<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alquiler de motos los amigos üèçÔ∏è</title>

  <!-- Export XLSX (Usuarios) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg1:#071126;
      --bg2:#0b1f46;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.09);
      --line:rgba(255,255,255,.12);
      --text:#eaf1ff;
      --muted:rgba(234,241,255,.72);
      --shadow: 0 18px 55px rgba(0,0,0,.35);
      --shadow2: 0 10px 30px rgba(0,0,0,.28);
      --primary:#4ea1ff;
      --primary2:#2d7dff;
      --ok:#26d07c;
      --warn:#ffc857;
      --bad:#ff4d6d;
      --chip:rgba(78,161,255,.18);
      --chip2:rgba(38,208,124,.16);
      --chip3:rgba(255,200,87,.16);
      --chip4:rgba(255,77,109,.16);
      --radius:18px;
      --radius2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(78,161,255,.20), transparent 55%),
        radial-gradient(900px 520px at 90% 10%, rgba(45,125,255,.18), transparent 58%),
        radial-gradient(800px 520px at 40% 95%, rgba(38,208,124,.10), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{min-height:100%; display:flex; align-items:stretch; justify-content:center}
    .container{
      width:min(1240px, 100%);
      padding:22px;
    }

    /* Top bar */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px;
      margin-bottom:16px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      padding:12px 14px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius:var(--radius);
      box-shadow:var(--shadow2);
      backdrop-filter: blur(10px);
    }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.30), transparent 60%),
        linear-gradient(135deg, rgba(78,161,255,.95), rgba(45,125,255,.65));
      border:1px solid rgba(255,255,255,.16);
      display:grid; place-items:center;
      box-shadow: 0 18px 40px rgba(45,125,255,.20);
      font-size:20px;
    }
    .brand h1{margin:0; font-size:16px; letter-spacing:.2px}
    .brand p{margin:0; color:var(--muted); font-size:12px}
    .actions{
      display:flex; align-items:center; gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      font-size:12px;
      display:flex; align-items:center; gap:8px;
      backdrop-filter: blur(10px);
    }
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:.2px;
      box-shadow: 0 10px 25px rgba(0,0,0,.20);
      transition:.18s transform, .18s background, .18s border;
      display:inline-flex; align-items:center; gap:10px;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background:rgba(255,255,255,.09); border-color:rgba(255,255,255,.22)}
    .btn:active{transform: translateY(0px) scale(.99)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(78,161,255,.96), rgba(45,125,255,.78));
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 16px 45px rgba(45,125,255,.20);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(255,77,109,.95), rgba(255,77,109,.55));
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 16px 45px rgba(255,77,109,.14);
    }
    .btn.ghost{background:transparent}
    .btn.small{padding:8px 10px; border-radius:12px; font-weight:800; font-size:12px}
    .btn.icon{padding:10px 10px}
    .btn[disabled]{opacity:.55; cursor:not-allowed; transform:none !important}
    .kbd{
      font-family:var(--mono);
      font-size:11px;
      padding:3px 7px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.25);
      color:rgba(234,241,255,.80);
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }
    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .card .hd{
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .card .hd h2{margin:0; font-size:14px}
    .card .hd p{margin:6px 0 0; color:var(--muted); font-size:12px; line-height:1.35}
    .card .bd{padding:14px 16px 16px}
    .subtle{
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    /* Sidebar / Nav */
    .nav{
      display:flex; flex-direction:column; gap:10px;
    }
    .nav .who{
      display:flex; align-items:center; gap:12px;
      padding:12px 14px;
      border-radius:var(--radius2);
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
    }
    .avatar{
      width:40px; height:40px; border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(16px 16px at 35% 35%, rgba(255,255,255,.24), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      display:grid; place-items:center;
      font-weight:900;
      letter-spacing:.3px;
    }
    .nav .who .nm{font-weight:900; font-size:13px; margin:0}
    .nav .who .rl{margin:3px 0 0; font-size:12px; color:var(--muted)}
    .tabs{
      display:flex; flex-direction:column; gap:8px;
      padding:10px;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
    }
    .tab{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      cursor:pointer;
      transition:.18s transform, .18s background, .18s border;
      user-select:none;
    }
    .tab:hover{transform: translateY(-1px); background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.18)}
    .tab.active{
      background:linear-gradient(135deg, rgba(78,161,255,.22), rgba(45,125,255,.10));
      border-color: rgba(78,161,255,.35);
      box-shadow: 0 16px 45px rgba(45,125,255,.12);
    }
    .tab .l{
      display:flex; align-items:center; gap:10px;
      font-weight:900;
      font-size:12px;
    }
    .ico{
      width:34px; height:34px; border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      display:grid; place-items:center;
      font-size:16px;
    }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      color:rgba(234,241,255,.82);
    }

    /* Forms */
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 580px){ .row{grid-template-columns:1fr} }
    label{display:block; font-size:12px; color:rgba(234,241,255,.82); font-weight:800; margin:8px 0 6px}
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    textarea{min-height:92px; resize:vertical}
    input::placeholder, textarea::placeholder{color:rgba(234,241,255,.45)}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(78,161,255,.55);
      box-shadow: 0 0 0 3px rgba(78,161,255,.18);
    }
    .help{margin-top:7px; font-size:12px; color:rgba(234,241,255,.62)}
    .divider{height:1px; background:rgba(255,255,255,.10); margin:14px 0}

    /* Table */
    .tableWrap{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      overflow:auto;
    }
    table{width:100%; border-collapse:separate; border-spacing:0}
    th,td{padding:11px 10px; font-size:12px; border-bottom:1px solid rgba(255,255,255,.09); vertical-align:top}
    th{
      position:sticky; top:0;
      background:rgba(9,22,48,.92);
      backdrop-filter: blur(10px);
      text-align:left;
      font-size:11px;
      letter-spacing:.25px;
      text-transform:uppercase;
      color:rgba(234,241,255,.78);
      z-index:1;
    }
    tr:hover td{background:rgba(255,255,255,.03)}
    td.mono{font-family:var(--mono); font-size:11px; color:rgba(234,241,255,.86)}
    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      font-size:12px;
      color:rgba(234,241,255,.86);
      display:inline-flex; align-items:center; gap:8px;
    }
    .chip.blue{background:var(--chip); border-color:rgba(78,161,255,.25)}
    .chip.green{background:var(--chip2); border-color:rgba(38,208,124,.25)}
    .chip.yellow{background:var(--chip3); border-color:rgba(255,200,87,.25)}
    .chip.red{background:var(--chip4); border-color:rgba(255,77,109,.25)}
    .statusDot{
      width:10px; height:10px; border-radius:999px; display:inline-block;
      background:rgba(255,255,255,.35);
      box-shadow: 0 0 0 3px rgba(255,255,255,.07);
    }
    .dotOk{background:rgba(38,208,124,.95); box-shadow: 0 0 0 3px rgba(38,208,124,.14)}
    .dotBad{background:rgba(255,77,109,.95); box-shadow: 0 0 0 3px rgba(255,77,109,.14)}
    .dotWarn{background:rgba(255,200,87,.95); box-shadow: 0 0 0 3px rgba(255,200,87,.14)}

    /* Toast */
    .toastHost{
      position:fixed; right:18px; bottom:18px;
      display:flex; flex-direction:column; gap:10px;
      z-index:9999;
    }
    .toast{
      width:min(420px, calc(100vw - 36px));
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,20,44,.92);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      padding:12px 12px;
      display:flex; gap:10px; align-items:flex-start;
    }
    .toast .t{font-weight:900; font-size:12px; margin:0}
    .toast .m{margin:4px 0 0; font-size:12px; color:rgba(234,241,255,.75); line-height:1.35}
    .toast .x{
      margin-left:auto;
      background:transparent;
      border:1px solid rgba(255,255,255,.16);
      color:rgba(234,241,255,.85);
      border-radius:12px;
      padding:6px 8px;
      cursor:pointer;
    }

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0; z-index:9998;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
    }
    .modalOverlay.show{display:flex}
    .modal{
      width:min(860px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .modal .mhd{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modal .mhd h3{margin:0; font-size:14px}
    .modal .mbd{padding:14px 16px 16px}
    .modal .mft{
      padding:14px 16px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;
    }
    .mutedSmall{font-size:11px; color:rgba(234,241,255,.62)}
    .dangerText{color: rgba(255,120,140,.95); font-weight:900}
    .okText{color: rgba(90,255,170,.95); font-weight:900}

    /* Login */
    .loginWrap{
      width:min(460px, 100%);
      margin: 26px auto 0;
    }
    .loginHero{
      padding:16px;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow2);
      margin-bottom:12px;
    }
    .loginHero h2{margin:0; font-size:16px}
    .loginHero p{margin:6px 0 0; color:var(--muted); font-size:12px; line-height:1.35}
    .hintBox{
      padding:12px 14px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.16);
      color:rgba(234,241,255,.80);
      font-size:12px;
      line-height:1.35;
    }
    .hide{display:none !important}
  </style>
</head>

<body>
  <div class="toastHost" id="toastHost"></div>

  <!-- MODAL -->
  <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="mhd">
        <h3 id="modalTitle">Modal</h3>
        <button class="btn small ghost" onclick="Modal.close()">‚úï</button>
      </div>
      <div class="mbd" id="modalBody"></div>
      <div class="mft" id="modalFooter"></div>
    </div>
  </div>

  <div class="wrap">
    <div class="container">

      <!-- TOP BAR -->
      <div class="topbar">
        <div class="brand">
          <div class="logo">üèçÔ∏è</div>
          <div>
            <h1>Alquiler de motos los amigos</h1>
            <p>Panel premium ‚Ä¢ Admin y Usuario ‚Ä¢ Local (sin servidor)</p>
          </div>
        </div>

        <div class="actions">
          <div class="pill" id="envPill">üß† Datos guardados en tu navegador</div>
          <button class="btn" id="btnSeed" title="Reinicia/crea datos de ejemplo">
            ‚ú® Demo
          </button>
          <button class="btn danger hide" id="btnLogout">Cerrar sesi√≥n</button>
        </div>
      </div>

      <!-- LOGIN VIEW -->
      <div id="viewLogin" class="loginWrap">
        <div class="loginHero">
          <h2>Ingresar</h2>
          <p>Inici√° sesi√≥n con usuario y contrase√±a (creados por el administrador).</p>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <h2>Inicio de sesi√≥n</h2>
              <p>Acceso seguro. El rol define qu√© m√≥dulos vas a ver.</p>
            </div>
            <span class="badge">Azul premium</span>
          </div>
          <div class="bd">
            <label>Usuario</label>
            <input id="loginUser" autocomplete="username" placeholder="Ej: admin" />

            <label>Contrase√±a</label>
            <input id="loginPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

            <div class="divider"></div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:center;">
              <button class="btn primary" onclick="Auth.login()">Ingresar</button>
              <span class="mutedSmall">Tip: <span class="kbd">Demo</span> crea usuario admin y datos de ejemplo.</span>
            </div>

            <div style="margin-top:12px" class="hintBox">
              <div><b>Cuenta admin (si us√°s Demo):</b> <span class="kbd">admin</span> / <span class="kbd">admin123</span></div>
              <div style="margin-top:6px"><b>Nota:</b> todo queda guardado en este navegador (localStorage).</div>
            </div>
          </div>
        </div>
      </div>

      <!-- APP VIEW -->
      <div id="viewApp" class="grid hide">

        <!-- SIDEBAR -->
        <div class="card">
          <div class="hd">
            <div>
              <h2>Navegaci√≥n</h2>
              <p>Accesos seg√∫n rol</p>
            </div>
          </div>
          <div class="bd nav">
            <div class="who">
              <div class="avatar" id="avatar">A</div>
              <div>
                <p class="nm" id="whoName">‚Äî</p>
                <p class="rl" id="whoRole">‚Äî</p>
              </div>
            </div>

            <div class="tabs" id="tabs">
              <!-- din√°mico -->
            </div>

            <div class="divider"></div>

            <div class="subtle">
              <b>Auto-Obligaciones:</b><br/>
              Se generan autom√°ticamente <b>5 d√≠as</b> despu√©s del inicio de contrato y vencen <b>2 d√≠as</b> despu√©s (total <b>7 d√≠as</b> desde el inicio), y luego semanalmente.
            </div>

            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn small" onclick="Data.backupJSON()">‚¨áÔ∏è Backup JSON</button>
              <button class="btn small" onclick="Data.restoreJSON()">‚¨ÜÔ∏è Restaurar JSON</button>
              <button class="btn small danger" onclick="Data.hardReset()">üß® Reset total</button>
            </div>
          </div>
        </div>

        <!-- MAIN -->
        <div class="card">
          <div class="hd">
            <div>
              <h2 id="mainTitle">Panel</h2>
              <p id="mainSubtitle">‚Äî</p>
            </div>
            <div class="chips" id="mainChips"></div>
          </div>
          <div class="bd" id="mainBody">
            <!-- din√°mico -->
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
/* ===========================
   UTIL
=========================== */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const fmtDate = (d) => {
  if(!d) return "";
  const dt = new Date(d);
  if (isNaN(dt)) return "";
  const dd = String(dt.getDate()).padStart(2,"0");
  const mm = String(dt.getMonth()+1).padStart(2,"0");
  const yy = dt.getFullYear();
  return `${dd}/${mm}/${yy}`;
};
const isoDate = (d) => {
  const dt = new Date(d);
  if (isNaN(dt)) return "";
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,"0");
  const dd = String(dt.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
};
const addDays = (date, days) => {
  const d = new Date(date);
  d.setDate(d.getDate() + Number(days||0));
  return d;
};
const startOfDay = (date) => {
  const d = new Date(date);
  d.setHours(0,0,0,0);
  return d;
};
const uid = (prefix="id") => prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
const sanitize = (s) => String(s ?? "").trim();
const toNumber = (v) => {
  const n = Number(String(v).replace(/[^\d.-]/g,''));
  return isNaN(n) ? 0 : n;
};
const safeText = (s) => String(s ?? "").replace(/[<>]/g,"");

const Toast = {
  show(title, msg, type="info"){
    const host = $("#toastHost");
    const el = document.createElement("div");
    el.className = "toast";
    const icon = type==="ok" ? "‚úÖ" : type==="warn" ? "‚ö†Ô∏è" : type==="bad" ? "‚õî" : "üí°";
    el.innerHTML = `
      <div style="font-size:18px; line-height:1">${icon}</div>
      <div>
        <p class="t">${safeText(title)}</p>
        <p class="m">${safeText(msg)}</p>
      </div>
      <button class="x" title="Cerrar">‚úï</button>
    `;
    el.querySelector(".x").onclick = () => el.remove();
    host.appendChild(el);
    setTimeout(()=>{ if(el.isConnected) el.remove(); }, 5200);
  }
};

const Modal = {
  open({title="Atenci√≥n", bodyHTML="", footerHTML=""}){
    $("#modalTitle").textContent = title;
    $("#modalBody").innerHTML = bodyHTML;
    $("#modalFooter").innerHTML = footerHTML;
    $("#modalOverlay").classList.add("show");
    $("#modalOverlay").setAttribute("aria-hidden","false");
  },
  close(){
    $("#modalOverlay").classList.remove("show");
    $("#modalOverlay").setAttribute("aria-hidden","true");
  }
};
document.addEventListener("keydown", (e)=>{
  if(e.key==="Escape") Modal.close();
});

/* ===========================
   STORAGE / DATA
=========================== */
const DB_KEY = "amla_db_v1";

const Data = {
  get(){
    const raw = localStorage.getItem(DB_KEY);
    if(!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
  },
  set(db){
    localStorage.setItem(DB_KEY, JSON.stringify(db));
  },
  ensure(){
    let db = Data.get();
    if(!db){
      db = {
        meta:{ createdAt: new Date().toISOString(), version: 1 },
        users: [],
        vehicles: [],
        obligations: [],
        session: { userId: null }
      };
      Data.set(db);
    }
    return db;
  },
  save(db){ Data.set(db); },

  hardReset(){
    Modal.open({
      title:"Reset total",
      bodyHTML: `
        <div class="subtle">
          Esto borra <b>todos</b> los usuarios, veh√≠culos, obligaciones y sesi√≥n de este navegador.
          <div class="divider"></div>
          <span class="dangerText">No se puede deshacer.</span>
        </div>
      `,
      footerHTML: `
        <button class="btn" onclick="Modal.close()">Cancelar</button>
        <button class="btn danger" onclick="Data._doHardReset()">Borrar todo</button>
      `
    });
  },
  _doHardReset(){
    localStorage.removeItem(DB_KEY);
    Modal.close();
    Toast.show("Listo", "Se borr√≥ toda la informaci√≥n.", "ok");
    App.init();
  },

  backupJSON(){
    const db = Data.ensure();
    const blob = new Blob([JSON.stringify(db, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `backup_alquiler_motos_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
    Toast.show("Backup generado", "Se descarg√≥ un archivo JSON con tu base local.", "ok");
  },
  restoreJSON(){
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.onchange = async () => {
      const file = input.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const parsed = JSON.parse(text);
        if(!parsed || !parsed.users || !parsed.vehicles || !parsed.obligations){
          Toast.show("Error", "El archivo no parece un backup v√°lido.", "bad");
          return;
        }
        Data.set(parsed);
        Toast.show("Restaurado", "Se import√≥ el backup correctamente.", "ok");
        App.init();
      }catch(err){
        Toast.show("Error", "No se pudo leer el JSON.", "bad");
      }
    };
    input.click();
  },

  seedDemo(){
    const db = Data.ensure();

    // Si ya existe admin, no duplicar
    const hasAdmin = db.users.some(u => u.username === "admin" && u.role === "admin");
    if(!hasAdmin){
      db.users.push({
        id: uid("usr"),
        role: "admin",
        username: "admin",
        pass: "admin123",
        dni: "",
        contractStart: "",
        phone: "",
        domainAssigned: "",
        status: "activo"
      });
    }

    // Usuario demo
    let demoUser = db.users.find(u => u.username === "juan");
    if(!demoUser){
      demoUser = {
        id: uid("usr"),
        role: "user",
        username: "juan",
        pass: "1234",
        dni: "40123456",
        contractStart: isoDate(addDays(new Date(), -20)),
        phone: "11 0000 0000",
        domainAssigned: "A170TCP",
        status: "activo"
      };
      db.users.push(demoUser);
    }

    // Veh√≠culo demo
    let demoVeh = db.vehicles.find(v => v.domain === "A170TCP");
    if(!demoVeh){
      demoVeh = {
        id: uid("veh"),
        weeklyFee: 105000,
        domain: "A170TCP",
        model: "Honda Wave 110S",
        color: "Negra",
        insuranceUntil: isoDate(addDays(new Date(), 60)),
        insurer: "Aseguradora Demo",
        vtvUntil: isoDate(addDays(new Date(), 120)),
        assignedUserId: demoUser.id
      };
      db.vehicles.push(demoVeh);
    }else{
      demoVeh.assignedUserId = demoUser.id;
    }

    Data.save(db);

    // Generar obligaciones autom√°ticas
    Obligations.autoGenerateForAll({weeksAhead: 16});
    Toast.show("Demo lista", "Cre√© admin/admin123 y usuario juan/1234 con veh√≠culo y obligaciones.", "ok");
    App.init();
  }
};

/* ===========================
   AUTH
=========================== */
const Auth = {
  current(){
    const db = Data.ensure();
    const userId = db.session?.userId;
    if(!userId) return null;
    return db.users.find(u => u.id === userId) || null;
  },
  login(){
    const username = sanitize($("#loginUser").value);
    const pass = sanitize($("#loginPass").value);
    if(!username || !pass){
      Toast.show("Faltan datos", "Ingres√° usuario y contrase√±a.", "warn");
      return;
    }
    const db = Data.ensure();
    const u = db.users.find(x => x.username === username && x.pass === pass && x.status !== "baja");
    if(!u){
      Toast.show("Acceso denegado", "Credenciales inv√°lidas o usuario dado de baja.", "bad");
      return;
    }
    db.session.userId = u.id;
    Data.save(db);

    // Auto generar obligaciones
    Obligations.autoGenerateForAll({weeksAhead: 20});

    Toast.show("Bienvenido", `Sesi√≥n iniciada como ${u.username}.`, "ok");
    App.init();
  },
  logout(){
    const db = Data.ensure();
    db.session.userId = null;
    Data.save(db);
    Toast.show("Sesi√≥n cerrada", "Volviste al inicio.", "ok");
    App.init();
  }
};

/* ===========================
   OBLIGATIONS LOGIC
=========================== */
const Obligations = {
  // Regla: se crean a los 5 d√≠as del inicio y vencen 2 d√≠as despu√©s => due = start + 7
  // Luego semanalmente: due +7, +14, ...
  // "monto": por defecto cuota semanal del veh√≠culo asignado (si existe).
  autoGenerateForUser(userId, {weeksAhead=16}={}){
    const db = Data.ensure();
    const user = db.users.find(u => u.id === userId);
    if(!user || user.status === "baja") return;

    const start = user.contractStart ? startOfDay(new Date(user.contractStart)) : null;
    if(!start) return;

    const veh = db.vehicles.find(v => v.assignedUserId === userId) || null;
    const defaultAmount = veh ? toNumber(veh.weeklyFee) : 0;

    const firstDue = startOfDay(addDays(start, 7)); // vencimiento 7 d√≠as desde el inicio
    const today = startOfDay(new Date());
    const maxDue = startOfDay(addDays(today, weeksAhead * 7));

    // Generar desde firstDue hasta maxDue en pasos semanales
    for(let due = new Date(firstDue); due <= maxDue; due = addDays(due, 7)){
      const key = `${userId}_${isoDate(due)}`;
      const exists = db.obligations.some(o => o.key === key);
      if(!exists){
        db.obligations.push({
          id: uid("obl"),
          key,
          userId,
          amount: defaultAmount,
          dueDate: isoDate(due),
          note: "Cuota semanal",
          status: "pendiente",
          createdAt: new Date().toISOString(),
          auto: true
        });
      }
    }
    Data.save(db);
  },
  autoGenerateForAll({weeksAhead=16}={}){
    const db = Data.ensure();
    db.users.filter(u => u.status !== "baja").forEach(u => {
      Obligations.autoGenerateForUser(u.id, {weeksAhead});
    });
  },
  listForUser(userId){
    const db = Data.ensure();
    return db.obligations
      .filter(o => o.userId === userId)
      .sort((a,b)=> new Date(a.dueDate) - new Date(b.dueDate));
  },
  statusChip(ob){
    const due = startOfDay(new Date(ob.dueDate));
    const today = startOfDay(new Date());
    let cls="blue", label="Pendiente", dot="dotWarn";
    if(ob.status==="pagado"){ cls="green"; label="Pagado"; dot="dotOk"; }
    else if(due < today){ cls="red"; label="Vencido"; dot="dotBad"; }
    else { cls="yellow"; label="Pendiente"; dot="dotWarn"; }
    return `<span class="chip ${cls}"><span class="statusDot ${dot}"></span>${label}</span>`;
  }
};

/* ===========================
   UI RENDER
=========================== */
const UI = {
  setMain(title, subtitle, chipsHTML=""){
    $("#mainTitle").textContent = title;
    $("#mainSubtitle").textContent = subtitle;
    $("#mainChips").innerHTML = chipsHTML;
  },
  renderTabs(user){
    const tabs = [];
    if(user.role === "admin"){
      tabs.push({id:"adm_users",  label:"Usuarios",   icon:"üë§", badge:"Admin"});
      tabs.push({id:"adm_veh",    label:"Veh√≠culos",  icon:"üèçÔ∏è", badge:"Admin"});
      tabs.push({id:"adm_obl",    label:"Obligaciones", icon:"üßæ", badge:"Auto"});
      tabs.push({id:"adm_reports",label:"Resumen",    icon:"üìä", badge:"Vista"});
    } else {
      tabs.push({id:"usr_home", label:"Mi panel", icon:"üè†", badge:"Usuario"});
      tabs.push({id:"usr_obl",  label:"Mis obligaciones", icon:"üßæ", badge:"Pagos"});
      tabs.push({id:"usr_sos",  label:"S.O.S", icon:"üÜò", badge:"R√°pido"});
    }

    const host = $("#tabs");
    host.innerHTML = "";
    tabs.forEach(t=>{
      const div = document.createElement("div");
      div.className = "tab";
      div.dataset.tab = t.id;
      div.innerHTML = `
        <div class="l">
          <div class="ico">${t.icon}</div>
          <div>${t.label}</div>
        </div>
        <div class="badge">${t.badge}</div>
      `;
      div.onclick = ()=> App.go(t.id);
      host.appendChild(div);
    });
  },
  setActiveTab(tabId){
    $$("#tabs .tab").forEach(el=>{
      el.classList.toggle("active", el.dataset.tab === tabId);
    });
  }
};

/* ===========================
   ADMIN: USERS
=========================== */
const AdminUsers = {
  view(){
    const db = Data.ensure();
    UI.setMain("Usuarios", "Crear, modificar y dar de alta/baja. Exportaci√≥n incluida.", `
      <span class="chip blue">üë§ Gesti√≥n</span>
      <span class="chip green">‚¨áÔ∏è Export</span>
    `);

    const rows = db.users
      .slice()
      .sort((a,b)=> (a.username||"").localeCompare(b.username||""))
      .map(u=>{
        const st = u.status === "activo"
          ? `<span class="chip green"><span class="statusDot dotOk"></span>Activo</span>`
          : `<span class="chip red"><span class="statusDot dotBad"></span>Baja</span>`;
        return `
          <tr>
            <td class="mono">${safeText(u.username)}</td>
            <td class="mono">${safeText(u.role)}</td>
            <td>${safeText(u.dni||"")}</td>
            <td class="mono">${safeText(u.phone||"")}</td>
            <td class="mono">${safeText(u.domainAssigned||"")}</td>
            <td class="mono">${u.contractStart ? fmtDate(u.contractStart) : ""}</td>
            <td>${st}</td>
            <td style="white-space:nowrap">
              <button class="btn small" onclick="AdminUsers.openEdit('${u.id}')">‚úèÔ∏è Editar</button>
              <button class="btn small ${u.status==='activo'?'danger':''}" onclick="AdminUsers.toggleStatus('${u.id}')">
                ${u.status==='activo'?'‚õî Baja':'‚úÖ Alta'}
              </button>
            </td>
          </tr>
        `;
      }).join("");

    $("#mainBody").innerHTML = `
      <div class="row">
        <div>
          <label>Crear usuario</label>
          <div class="subtle">Usuarios y contrase√±as los define el admin. Rol: <b>user</b> o <b>admin</b>.</div>
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap">
          <button class="btn small" onclick="AdminUsers.exportCSV()">‚¨áÔ∏è Exportar CSV</button>
          <button class="btn small primary" onclick="AdminUsers.exportXLSX()">‚¨áÔ∏è Exportar XLSX</button>
          <button class="btn small" onclick="AdminUsers.openCreate()">‚ûï Nuevo usuario</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Rol</th>
              <th>DNI</th>
              <th>Tel√©fono</th>
              <th>Dominio asignado</th>
              <th>Inicio contrato</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${rows || `<tr><td colspan="8" class="subtle">No hay usuarios todav√≠a.</td></tr>`}
          </tbody>
        </table>
      </div>
    `;
  },

  openCreate(){
    Modal.open({
      title:"Nuevo usuario",
      bodyHTML: AdminUsers.formHTML({mode:"create"}),
      footerHTML: `
        <button class="btn" onclick="Modal.close()">Cancelar</button>
        <button class="btn primary" onclick="AdminUsers.saveCreate()">Guardar</button>
      `
    });
  },

  openEdit(id){
    const db = Data.ensure();
    const u = db.users.find(x=>x.id===id);
    if(!u) return;
    Modal.open({
      title:`Editar usuario: ${u.username}`,
      bodyHTML: AdminUsers.formHTML({mode:"edit", user:u}),
      footerHTML: `
        <button class="btn" onclick="Modal.close()">Cerrar</button>
        <button class="btn primary" onclick="AdminUsers.saveEdit('${u.id}')">Guardar cambios</button>
      `
    });
  },

  formHTML({mode, user}){
    const u = user || {
      username:"", pass:"", role:"user", dni:"", contractStart:"", phone:"", domainAssigned:"", status:"activo"
    };
    const lockUser = (mode==="edit" && u.role==="admin" && u.username==="admin") ? true : false;
    return `
      <div class="row">
        <div>
          <label>Usuario</label>
          <input id="f_username" value="${safeText(u.username)}" placeholder="Ej: juan" ${lockUser?'disabled':''}/>
          <div class="help">√önico. No uses espacios.</div>
        </div>
        <div>
          <label>Contrase√±a</label>
          <input id="f_pass" value="${safeText(u.pass)}" placeholder="Ej: 1234" />
          <div class="help">Guardada localmente (en este navegador).</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Rol</label>
          <select id="f_role" ${lockUser?'disabled':''}>
            <option value="user" ${u.role==="user"?"selected":""}>user</option>
            <option value="admin" ${u.role==="admin"?"selected":""}>admin</option>
          </select>
        </div>
        <div>
          <label>Estado</label>
          <select id="f_status">
            <option value="activo" ${u.status==="activo"?"selected":""}>activo</option>
            <option value="baja" ${u.status==="baja"?"selected":""}>baja</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>DNI</label>
          <input id="f_dni" value="${safeText(u.dni)}" placeholder="Ej: 40123456" />
        </div>
        <div>
          <label>N√∫mero de tel√©fono</label>
          <input id="f_phone" value="${safeText(u.phone)}" placeholder="Ej: 11 1234 5678" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Fecha de inicio de contrato</label>
          <input id="f_contractStart" type="date" value="${safeText(u.contractStart)}" />
          <div class="help">Usada para generar obligaciones autom√°ticas.</div>
        </div>
        <div>
          <label>Dominio asignado (patente)</label>
          <input id="f_domainAssigned" value="${safeText(u.domainAssigned)}" placeholder="Ej: A170TCP" />
          <div class="help">Se usa para referencia y para asignaci√≥n.</div>
        </div>
      </div>

      <div class="divider"></div>
      <div class="subtle">
        <b>Auto-obligaciones:</b> al guardar, se generan obligaciones semanales desde el inicio del contrato.
      </div>
    `;
  },

  saveCreate(){
    const db = Data.ensure();
    const username = sanitize($("#f_username").value);
    const pass = sanitize($("#f_pass").value);
    const role = sanitize($("#f_role").value) || "user";
    const status = sanitize($("#f_status").value) || "activo";
    if(!username || !pass){
      Toast.show("Faltan datos", "Usuario y contrase√±a son obligatorios.", "warn");
      return;
    }
    if(db.users.some(u => u.username === username)){
      Toast.show("Duplicado", "Ya existe un usuario con ese nombre.", "bad");
      return;
    }
    const newUser = {
      id: uid("usr"),
      role,
      username,
      pass,
      dni: sanitize($("#f_dni").value),
      contractStart: sanitize($("#f_contractStart").value),
      phone: sanitize($("#f_phone").value),
      domainAssigned: sanitize($("#f_domainAssigned").value),
      status
    };
    db.users.push(newUser);
    Data.save(db);

    // Auto generar obligaciones
    Obligations.autoGenerateForUser(newUser.id, {weeksAhead: 20});

    Modal.close();
    Toast.show("Guardado", "Usuario creado correctamente.", "ok");
    AdminUsers.view();
  },

  saveEdit(id){
    const db = Data.ensure();
    const u = db.users.find(x=>x.id===id);
    if(!u) return;

    const oldStart = u.contractStart;

    const username = sanitize($("#f_username").value);
    const pass = sanitize($("#f_pass").value);
    const role = sanitize($("#f_role").value) || u.role;
    const status = sanitize($("#f_status").value) || u.status;

    if(!username || !pass){
      Toast.show("Faltan datos", "Usuario y contrase√±a son obligatorios.", "warn");
      return;
    }
    if(db.users.some(x => x.username === username && x.id !== id)){
      Toast.show("Duplicado", "Ya existe otro usuario con ese nombre.", "bad");
      return;
    }

    u.username = username;
    u.pass = pass;
    u.role = role;
    u.status = status;
    u.dni = sanitize($("#f_dni").value);
    u.contractStart = sanitize($("#f_contractStart").value);
    u.phone = sanitize($("#f_phone").value);
    u.domainAssigned = sanitize($("#f_domainAssigned").value);

    Data.save(db);

    // Si se cambi√≥ el inicio de contrato, regenerar hacia adelante (no borramos lo viejo para no perder historial)
    if(u.contractStart && u.contractStart !== oldStart){
      Obligations.autoGenerateForUser(u.id, {weeksAhead: 24});
    }

    Modal.close();
    Toast.show("Actualizado", "Cambios guardados.", "ok");
    AdminUsers.view();
  },

  toggleStatus(id){
    const db = Data.ensure();
    const u = db.users.find(x=>x.id===id);
    if(!u) return;

    const next = (u.status === "activo") ? "baja" : "activo";
    Modal.open({
      title: "Confirmar cambio de estado",
      bodyHTML: `
        <div class="subtle">
          Usuario: <b>${safeText(u.username)}</b><br/>
          Estado actual: <b>${safeText(u.status)}</b><br/>
          Nuevo estado: <b>${safeText(next)}</b>
          <div class="divider"></div>
          ${next==="baja"
            ? `<span class="dangerText">Al dar de baja, no podr√° iniciar sesi√≥n.</span>`
            : `<span class="okText">Volver√° a poder iniciar sesi√≥n.</span>`
          }
        </div>
      `,
      footerHTML: `
        <button class="btn" onclick="Modal.close()">Cancelar</button>
        <button class="btn ${next==="baja"?"danger":"primary"}" onclick="AdminUsers._doToggleStatus('${id}')">Confirmar</button>
      `
    });
  },
  _doToggleStatus(id){
    const db = Data.ensure();
    const u = db.users.find(x=>x.id===id);
    if(!u) return;
    u.status = (u.status === "activo") ? "baja" : "activo";
    Data.save(db);
    Modal.close();
    Toast.show("Listo", "Estado actualizado.", "ok");
    AdminUsers.view();
  },

  exportCSV(){
    const db = Data.ensure();
    const headers = ["usuario","rol","dni","inicio_contrato","telefono","dominio_asignado","estado"];
    const lines = [headers.join(",")];
    db.users.forEach(u=>{
      const row = [
        `"${String(u.username||"").replaceAll('"','""')}"`,
        `"${String(u.role||"").replaceAll('"','""')}"`,
        `"${String(u.dni||"").replaceAll('"','""')}"`,
        `"${String(u.contractStart||"").replaceAll('"','""')}"`,
        `"${String(u.phone||"").replaceAll('"','""')}"`,
        `"${String(u.domainAssigned||"").replaceAll('"','""')}"`,
        `"${String(u.status||"").replaceAll('"','""')}"`
      ];
      lines.push(row.join(","));
    });
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `usuarios_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
    Toast.show("Exportado", "CSV generado.", "ok");
  },

  exportXLSX(){
    const db = Data.ensure();
    const data = db.users.map(u => ({
      Usuario: u.username || "",
      Rol: u.role || "",
      DNI: u.dni || "",
      "Inicio contrato": u.contractStart ? fmtDate(u.contractStart) : "",
      Tel√©fono: u.phone || "",
      "Dominio asignado": u.domainAssigned || "",
      Estado: u.status || ""
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Usuarios");
    XLSX.writeFile(wb, `usuarios_${new Date().toISOString().slice(0,10)}.xlsx`);
    Toast.show("Exportado", "XLSX generado.", "ok");
  }
};

/* ===========================
   ADMIN: VEHICLES
=========================== */
const AdminVehicles = {
  view(){
    const db = Data.ensure();
    UI.setMain("Veh√≠culos", "Crear/modificar, asignar a usuarios y ver listado completo.", `
      <span class="chip blue">üèçÔ∏è Flota</span>
      <span class="chip yellow">üîÅ Asignaci√≥n</span>
    `);

    const users = db.users.filter(u => u.role !== "admin" && u.status !== "baja");

    const rows = db.vehicles
      .slice()
      .sort((a,b)=> (a.domain||"").localeCompare(b.domain||""))
      .map(v=>{
        const assigned = v.assignedUserId ? db.users.find(u=>u.id===v.assignedUserId) : null;
        const insDate = v.insuranceUntil ? fmtDate(v.insuranceUntil) : "";
        const vtvDate = v.vtvUntil ? fmtDate(v.vtvUntil) : "";
        return `
          <tr>
            <td class="mono">${safeText(v.domain||"")}</td>
            <td>${safeText(v.model||"")}</td>
            <td>${safeText(v.color||"")}</td>
            <td class="mono">$ ${toNumber(v.weeklyFee).toLocaleString("es-AR")}</td>
            <td>${safeText(v.insurer||"")}</td>
            <td class="mono">${insDate}</td>
            <td class="mono">${vtvDate}</td>
            <td>${assigned ? `<span class="chip blue">üë§ ${safeText(assigned.username)}</span>` : `<span class="chip red">Sin asignar</span>`}</td>
            <td style="white-space:nowrap">
              <button class="btn small" onclick="AdminVehicles.openEdit('${v.id}')">‚úèÔ∏è Modificar</button>
              <button class="btn small" onclick="AdminVehicles.openAssign('${v.id}')">üîÅ Asignar</button>
            </td>
          </tr>
        `;
      }).join("");

    $("#mainBody").innerHTML = `
      <div class="row">
        <div>
          <label>Crear veh√≠culo</label>
          <div class="subtle">Datos: <b>Cuota semanal</b>, dominio, modelo, color, seguro vigente hasta, aseguradora, VTV vigente hasta, asignado a.</div>
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap">
          <button class="btn small primary" onclick="AdminVehicles.openCreate()">‚ûï Nuevo veh√≠culo</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Dominio</th>
              <th>Modelo</th>
              <th>Color</th>
              <th>Cuota semanal</th>
              <th>Aseguradora</th>
              <th>Seguro hasta</th>
              <th>VTV hasta</th>
              <th>Asignado a</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${rows || `<tr><td colspan="9" class="subtle">No hay veh√≠culos cargados.</td></tr>`}
          </tbody>
        </table>
      </div>

      <div class="divider"></div>

      <div class="hintBox">
        <b>Tip:</b> Al asignar un veh√≠culo a un usuario, las obligaciones autom√°ticas toman la <b>cuota semanal</b> como monto por defecto (si el usuario tiene inicio de contrato).
      </div>
    `;
  },

  openCreate(){
    Modal.open({
      title:"Nuevo veh√≠culo",
      bodyHTML: AdminVehicles.formHTML({mode:"create"}),
      footerHTML: `
        <button class="btn" onclick="Modal.close()">Cancelar</button>
        <button class="btn primary" onclick="AdminVehicles.saveCreate()">Guardar</button>
      `
    });
  },

  openEdit(id){
    const db = Data.ensure();
    const v = db.vehicles.find(x=>x.id===id);
    if(!v) return;
    Modal.open({
      title:`Modificar veh√≠culo: ${v.domain}`,
      bodyHTML: AdminVehicles.formHTML({mode:"edit", veh:v}),
      footerHTML: `
        <button class="btn" onclick="Modal.close()">Cerrar</button>
        <button class="btn primary" onclick="AdminVehicles.saveEdit('${v.id}')">Guardar cambios</button>
      `
    });
  },

  openAssign(id){
    const db = Data.ensure();
    const v = db.vehicles.find(x=>x.id===id);
    if(!v) return;

    const users = db.users.filter(u => u.role !== "admin" && u.status !== "baja");
    const opts = [`<option value="">(Sin asignar)</option>`]
      .concat(users.map(u=> `<option value="${u.id}" ${u.id===v.assignedUserId?"selected":""}>${safeText(u.username)} (${safeText(u.dni||"")})</option>`))
      .join("");

    Modal.open({
      title:"Asignar veh√≠culo",
      bodyHTML: `
        <div class="subtle">
          Dominio: <b class="mono">${safeText(v.domain)}</b><br/>
          Modelo: <b>${safeText(v.model||"")}</b>
          <div class="divider"></div>
          <label>Asignado a</label>
          <select id="assign_user">${opts}</select>
          <div class="help">Si el usuario tiene inicio de contrato, se generar√°n obligaciones autom√°ticas.</div>
        </div>
      `,
      footerHTML: `
        <button class="btn" onclick="Modal.close()">Cancelar</button>
        <button class="btn primary" onclick="AdminVehicles.saveAssign('${v.id}')">Guardar</button>
      `
    });
  },

  formHTML({mode, veh}){
    const v = veh || {
      weeklyFee: "",
      domain:"",
      model:"",
      color:"",
      insuranceUntil:"",
      insurer:"",
      vtvUntil:"",
      assignedUserId:""
    };
    return `
      <div class="row">
        <div>
          <label>Cuota semanal</label>
          <input id="v_weeklyFee" inputmode="numeric" value="${safeText(v.weeklyFee)}" placeholder="Ej: 105000" />
        </div>
        <div>
          <label>Dominio (patente)</label>
          <input id="v_domain" value="${safeText(v.domain)}" placeholder="Ej: A170TCP" ${mode==="edit"?'disabled':''}/>
          <div class="help">${mode==="edit" ? "El dominio queda fijo para evitar duplicados." : "√önico."}</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Modelo</label>
          <input id="v_model" value="${safeText(v.model)}" placeholder="Ej: Honda Wave 110S" />
        </div>
        <div>
          <label>Color</label>
          <input id="v_color" value="${safeText(v.color)}" placeholder="Ej: Negra" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Seguro vigente hasta</label>
          <input id="v_insUntil" type="date" value="${safeText(v.insuranceUntil)}" />
        </div>
        <div>
          <label>Aseguradora</label>
          <input id="v_insurer" value="${safeText(v.insurer)}" placeholder="Ej: Rivadavia / Sancor / ..." />
        </div>
      </div>

      <div class="row">
        <div>
          <label>VTV vigente hasta</label>
          <input id="v_vtvUntil" type="date" value="${safeText(v.vtvUntil)}" />
        </div>
        <div>
          <label>Asignado a (usuario)</label>
          ${AdminVehicles.assignSelectHTML(v.assignedUserId)}
        </div>
      </div>

      <div class="divider"></div>
      <div class="subtle">
        Al guardar, si el veh√≠culo queda asignado a un usuario con inicio de contrato, se actualizan/crean obligaciones autom√°ticas con el monto de <b>cuota semanal</b>.
      </div>
    `;
  },

  assignSelectHTML(selectedId){
    const db = Data.ensure();
    const users = db.users.filter(u => u.role !== "admin" && u.status !== "baja");
    const opts = [`<option value="">(Sin asignar)</option>`]
      .concat(users.map(u=> `<option value="${u.id}" ${u.id===selectedId?"selected":""}>${safeText(u.username)} (${safeText(u.dni||"")})</option>`))
      .join("");
    return `<select id="v_assigned">${opts}</select>`;
  },

  saveCreate(){
    const db = Data.ensure();
    const domain = sanitize($("#v_domain").value).toUpperCase();
    if(!domain){
      Toast.show("Faltan datos", "El dominio es obligatorio.", "warn");
      return;
    }
    if(db.vehicles.some(v => (v.domain||"").toUpperCase() === domain)){
      Toast.show("Duplicado", "Ya existe un veh√≠culo con ese dominio.", "bad");
      return;
    }
    const v = {
      id: uid("veh"),
      weeklyFee: toNumber($("#v_weeklyFee").value),
      domain,
      model: sanitize($("#v_model").value),
      color: sanitize($("#v_color").value),
      insuranceUntil: sanitize($("#v_insUntil").value),
      insurer: sanitize($("#v_insurer").value),
      vtvUntil: sanitize($("#v_vtvUntil").value),
      assignedUserId: sanitize($("#v_assigned").value)
    };
    db.vehicles.push(v);

    // Si se asigna, reflejar en usuario domainAssigned si est√° vac√≠o
    if(v.assignedUserId){
      const u = db.users.find(x=>x.id===v.assignedUserId);
      if(u && !u.domainAssigned) u.domainAssigned = v.domain;
    }

    Data.save(db);

    // Auto generar obligaciones si corresponde
    if(v.assignedUserId){
      // asegurar que el monto por defecto se aplique: (solo afecta nuevas auto)
      Obligations.autoGenerateForUser(v.assignedUserId, {weeksAhead: 24});
    }

    Modal.close();
    Toast.show("Guardado", "Veh√≠culo creado.", "ok");
    AdminVehicles.view();
  },

  saveEdit(id){
    const db = Data.ensure();
    const v = db.vehicles.find(x=>x.id===id);
    if(!v) return;

    const prevAssigned = v.assignedUserId;

    v.weeklyFee = toNumber($("#v_weeklyFee").value);
    v.model = sanitize($("#v_model").value);
    v.color = sanitize($("#v_color").value);
    v.insuranceUntil = sanitize($("#v_insUntil").value);
    v.insurer = sanitize($("#v_insurer").value);
    v.vtvUntil = sanitize($("#v_vtvUntil").value);
    v.assignedUserId = sanitize($("#v_assigned").value);

    // Si se reasigna, mantener domainAssigned si est√° vac√≠o
    if(v.assignedUserId){
      const u = db.users.find(x=>x.id===v.assignedUserId);
      if(u && !u.domainAssigned) u.domainAssigned = v.domain;
    }

    Data.save(db);

    // Regenerar obligaciones hacia adelante para el nuevo asignado (si tiene contrato)
    if(v.assignedUserId) Obligations.autoGenerateForUser(v.assignedUserId, {weeksAhead: 24});
    if(prevAssigned && prevAssigned !== v.assignedUserId) {
      // Tambi√©n mantener generado para el anterior (no borramos historial)
      Obligations.autoGenerateForUser(prevAssigned, {weeksAhead: 8});
    }

    Modal.close();
    Toast.show("Actualizado", "Veh√≠culo modificado.", "ok");
    AdminVehicles.view();
  },

  saveAssign(id){
    const db = Data.ensure();
    const v = db.vehicles.find(x=>x.id===id);
    if(!v) return;
    v.assignedUserId = sanitize($("#assign_user").value);

    if(v.assignedUserId){
      const u = db.users.find(x=>x.id===v.assignedUserId);
      if(u && !u.domainAssigned) u.domainAssigned = v.domain;
    }

    Data.save(db);

    if(v.assignedUserId) Obligations.autoGenerateForUser(v.assignedUserId, {weeksAhead: 24});

    Modal.close();
    Toast.show("Listo", "Asignaci√≥n guardada.", "ok");
    AdminVehicles.view();
  }
};

/* ===========================
   ADMIN: OBLIGATIONS
=========================== */
const AdminObligations = {
  view(){
    const db = Data.ensure();
    UI.setMain("Obligaciones", "Crear obligaciones manuales o dejar que el sistema las genere autom√°ticamente.", `
      <span class="chip blue">üßæ Gesti√≥n</span>
      <span class="chip green">‚öôÔ∏è Auto</span>
    `);

    const users = db.users.filter(u => u.role !== "admin" && u.status !== "baja");

    const userOpts = users.map(u=> `<option value="${u.id}">${safeText(u.username)} (${safeText(u.dni||"")})</option>`).join("");

    const rows = db.obligations
      .slice()
      .sort((a,b)=> new Date(b.dueDate) - new Date(a.dueDate))
      .slice(0, 400) // l√≠mite visual
      .map(o=>{
        const u = db.users.find(x=>x.id===o.userId);
        const who = u ? u.username : "(usuario eliminado)";
        const status = Obligations.statusChip(o);
        return `
          <tr>
            <td class="mono">${safeText(who)}</td>
            <td class="mono">${fmtDate(o.dueDate)}</td>
            <td class="mono">$ ${toNumber(o.amount).toLocaleString("es-AR")}</td>
            <td>${safeText(o.note||"")}</td>
            <td>${o.auto ? `<span class="chip blue">Auto</span>` : `<span class="chip yellow">Manual</span>`}</td>
            <td>${status}</td>
            <td style="white-space:nowrap">
              <button class="btn small" onclick="AdminObligations.openEdit('${o.id}')">‚úèÔ∏è Editar</button>
              <button class="btn small" onclick="AdminObligations.togglePaid('${o.id}')">${o.status==="pagado"?"‚Ü©Ô∏è Pendiente":"‚úÖ Pagado"}</button>
              <button class="btn small danger" onclick="AdminObligations.remove('${o.id}')">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      }).join("");

    $("#mainBody").innerHTML = `
      <div class="row" style="align-items:end">
        <div>
          <label>Crear obligaci√≥n manual</label>
          <div class="subtle">Campos: usuario, monto, vencimiento y observaci√≥n. Impacta en el panel del usuario.</div>
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap">
          <button class="btn small" onclick="AdminObligations.runAuto()">‚öôÔ∏è Ejecutar auto-generaci√≥n</button>
          <button class="btn small primary" onclick="AdminObligations.openCreate()">‚ûï Nueva obligaci√≥n</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Vencimiento</th>
              <th>Monto</th>
              <th>Observaci√≥n</th>
              <th>Tipo</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${rows || `<tr><td colspan="7" class="subtle">No hay obligaciones cargadas.</td></tr>`}
          </tbody>
        </table>
      </div>

      <div class="divider"></div>
      <div class="hintBox">
        <b>Regla autom√°tica:</b> primera obligaci√≥n vence a los <b>7 d√≠as</b> del inicio del contrato, y luego se repite semanalmente.
        Se marca como <b>Auto</b> cuando fue generada por el sistema.
      </div>
    `;
  },

  runAuto(){
    Obligations.autoGenerateForAll({weeksAhead: 30});
    Toast.show("Auto-generaci√≥n", "Listo. Se crearon obligaciones faltantes hacia adelante.", "ok");
    AdminObligations.view();
  },

  openCreate(){
    const db = Data.ensure();
    const users = db.users.filter(u => u.role !== "admin" && u.status !== "baja");
    if(!users.length){
      Toast.show("Sin usuarios", "Primero cre√° al menos un usuario (no admin).", "warn");
      return;
    }
    Modal.open({
      title:"Nueva obligaci√≥n (manual)",
      bodyHTML: AdminObligations.formHTML({mode:"create"}),
      footerHTML: `
        <button class="btn" onclick="Modal.close()">Cancelar</button>
        <button class="btn primary" onclick="AdminObligations.saveCreate()">Guardar</button>
      `
    });
  },

  openEdit(id){
    const db = Data.ensure();
    const o = db.obligations.find(x=>x.id===id);
    if(!o) return;
    Modal.open({
      title:"Editar obligaci√≥n",
      bodyHTML: AdminObligations.formHTML({mode:"edit", obl:o}),
      footerHTML: `
        <button class="btn" onclick="Modal.close()">Cerrar</button>
        <button class="btn primary" onclick="AdminObligations.saveEdit('${id}')">Guardar cambios</button>
      `
    });
  },

  formHTML({mode, obl}){
    const db = Data.ensure();
    const users = db.users.filter(u => u.role !== "admin" && u.status !== "baja");
    const o = obl || {
      userId: users[0]?.id || "",
      amount: "",
      dueDate: isoDate(new Date()),
      note: "",
      status: "pendiente",
      auto: false
    };
    const userOpts = users.map(u=> `<option value="${u.id}" ${u.id===o.userId?"selected":""}>${safeText(u.username)} (${safeText(u.dni||"")})</option>`).join("");

    return `
      <div class="row">
        <div>
          <label>Usuario</label>
          <select id="o_user">${userOpts}</select>
        </div>
        <div>
          <label>Vencimiento</label>
          <input id="o_due" type="date" value="${safeText(o.dueDate)}"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Monto</label>
          <input id="o_amount" inputmode="numeric" value="${safeText(o.amount)}" placeholder="Ej: 105000"/>
        </div>
        <div>
          <label>Estado</label>
          <select id="o_status">
            <option value="pendiente" ${o.status==="pendiente"?"selected":""}>pendiente</option>
            <option value="pagado" ${o.status==="pagado"?"selected":""}>pagado</option>
          </select>
        </div>
      </div>

      <label>Observaci√≥n</label>
      <textarea id="o_note" placeholder="Ej: Cuota semanal / Ajuste / Mora...">${safeText(o.note||"")}</textarea>

      <div class="divider"></div>
      <div class="subtle">
        <b>Nota:</b> Las obligaciones manuales quedan marcadas como <b>Manual</b>.
      </div>
    `;
  },

  saveCreate(){
    const db = Data.ensure();
    const userId = sanitize($("#o_user").value);
    const dueDate = sanitize($("#o_due").value);
    const amount = toNumber($("#o_amount").value);
    const note = sanitize($("#o_note").value);
    const status = sanitize($("#o_status").value) || "pendiente";
    if(!userId || !dueDate || amount <= 0){
      Toast.show("Faltan datos", "Usuario, vencimiento y monto (>0) son obligatorios.", "warn");
      return;
    }

    const key = `${userId}_${dueDate}_manual_${Math.random().toString(16).slice(2)}`;
    db.obligations.push({
      id: uid("obl"),
      key,
      userId,
      amount,
      dueDate,
      note,
      status,
      createdAt: new Date().toISOString(),
      auto: false
    });
    Data.save(db);
    Modal.close();
    Toast.show("Guardado", "Obligaci√≥n creada.", "ok");
    AdminObligations.view();
  },

  saveEdit(id){
    const db = Data.ensure();
    const o = db.obligations.find(x=>x.id===id);
    if(!o) return;

    o.userId = sanitize($("#o_user").value);
    o.dueDate = sanitize($("#o_due").value);
    o.amount = toNumber($("#o_amount").value);
    o.note = sanitize($("#o_note").value);
    o.status = sanitize($("#o_status").value) || o.status;

    Data.save(db);
    Modal.close();
    Toast.show("Actualizado", "Obligaci√≥n modificada.", "ok");
    AdminObligations.view();
  },

  togglePaid(id){
    const db = Data.ensure();
    const o = db.obligations.find(x=>x.id===id);
    if(!o) return;
    o.status = (o.status === "pagado") ? "pendiente" : "pagado";
    Data.save(db);
    Toast.show("Listo", `Estado: ${o.status}.`, "ok");
    AdminObligations.view();
  },

  remove(id){
    Modal.open({
      title:"Eliminar obligaci√≥n",
      bodyHTML:`<div class="subtle"><span class="dangerText">Esto eliminar√° la obligaci√≥n definitivamente.</span></div>`,
      footerHTML: `
        <button class="btn" onclick="Modal.close()">Cancelar</button>
        <button class="btn danger" onclick="AdminObligations._doRemove('${id}')">Eliminar</button>
      `
    });
  },
  _doRemove(id){
    const db = Data.ensure();
    db.obligations = db.obligations.filter(o=>o.id!==id);
    Data.save(db);
    Modal.close();
    Toast.show("Eliminado", "Obligaci√≥n eliminada.", "ok");
    AdminObligations.view();
  }
};

/* ===========================
   ADMIN: REPORTS (simple)
=========================== */
const AdminReports = {
  view(){
    const db = Data.ensure();
    const totalUsers = db.users.filter(u=>u.role!=="admin").length;
    const activeUsers = db.users.filter(u=>u.role!=="admin" && u.status==="activo").length;
    const totalVeh = db.vehicles.length;

    const today = startOfDay(new Date());
    const obs = db.obligations.slice();
    const pending = obs.filter(o=>o.status!=="pagado").length;
    const overdue = obs.filter(o=>o.status!=="pagado" && startOfDay(new Date(o.dueDate)) < today).length;
    const paid = obs.filter(o=>o.status==="pagado").length;

    UI.setMain("Resumen", "Vista r√°pida del estado general del sistema.", `
      <span class="chip blue">üìä Estado</span>
      <span class="chip green">‚úÖ Pagos</span>
    `);

    $("#mainBody").innerHTML = `
      <div class="row">
        <div class="card" style="margin:0">
          <div class="bd">
            <div class="chips">
              <span class="chip blue">üë§ Usuarios: <b>${totalUsers}</b></span>
              <span class="chip green">üü¢ Activos: <b>${activeUsers}</b></span>
              <span class="chip yellow">üèçÔ∏è Veh√≠culos: <b>${totalVeh}</b></span>
            </div>
            <div class="divider"></div>
            <div class="chips">
              <span class="chip yellow">üßæ Pendientes: <b>${pending}</b></span>
              <span class="chip red">‚õî Vencidas: <b>${overdue}</b></span>
              <span class="chip green">‚úÖ Pagadas: <b>${paid}</b></span>
            </div>
          </div>
        </div>

        <div class="card" style="margin:0">
          <div class="bd">
            <div class="subtle">
              <b>Acciones r√°pidas</b>
              <div class="divider"></div>
              <button class="btn small" onclick="Obligations.autoGenerateForAll({weeksAhead:30}); Toast.show('Auto','Obligaciones generadas.', 'ok'); AdminReports.view();">‚öôÔ∏è Ejecutar auto-obligaciones</button>
              <button class="btn small" style="margin-left:8px" onclick="AdminUsers.exportXLSX()">‚¨áÔ∏è Exportar usuarios (XLSX)</button>
              <div class="divider"></div>
              <span class="mutedSmall">Sugerencia: manten√© actualizado <b>Inicio de contrato</b> y <b>Asignaci√≥n de veh√≠culo</b>.</span>
            </div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="hintBox">
        <b>C√≥mo funciona:</b> el admin crea usuarios y veh√≠culos, asigna un veh√≠culo a un usuario, y el sistema genera obligaciones semanales autom√°ticamente en base al inicio de contrato.
      </div>
    `;
  }
};

/* ===========================
   USER: HOME / OBL / SOS
=========================== */
const UserHome = {
  view(){
    const db = Data.ensure();
    const me = Auth.current();
    if(!me) return;

    const myVeh = db.vehicles.find(v=>v.assignedUserId===me.id) || null;
    const myObs = Obligations.listForUser(me.id);
    const today = startOfDay(new Date());
    const overdue = myObs.filter(o=>o.status!=="pagado" && startOfDay(new Date(o.dueDate)) < today);
    const next = myObs.find(o=>o.status!=="pagado" && startOfDay(new Date(o.dueDate)) >= today) || null;

    UI.setMain("Mi panel", "Informaci√≥n principal: unidad asignada y estado de obligaciones.", `
      <span class="chip blue">üë§ ${safeText(me.username)}</span>
      <span class="chip ${overdue.length? "red":"green"}">${overdue.length? "‚õî Con vencidas":"‚úÖ Al d√≠a"}</span>
    `);

    $("#mainBody").innerHTML = `
      <div class="row">
        <div class="card" style="margin:0">
          <div class="bd">
            <div class="chips">
              <span class="chip blue">üìÑ DNI: <b class="mono">${safeText(me.dni||"-")}</b></span>
              <span class="chip yellow">üìû Tel: <b class="mono">${safeText(me.phone||"-")}</b></span>
              <span class="chip blue">üèçÔ∏è Dominio: <b class="mono">${safeText(me.domainAssigned||"-")}</b></span>
              <span class="chip green">üóìÔ∏è Inicio: <b class="mono">${me.contractStart ? fmtDate(me.contractStart) : "-"}</b></span>
            </div>
            <div class="divider"></div>
            <div class="subtle">
              <b>Pr√≥ximo vencimiento:</b>
              ${next ? `<span class="chip yellow" style="margin-left:8px">üßæ ${fmtDate(next.dueDate)} ‚Ä¢ $ ${toNumber(next.amount).toLocaleString("es-AR")}</span>` : `<span class="chip green" style="margin-left:8px">Sin pendientes</span>`}
              <div style="margin-top:10px">
                <button class="btn small" onclick="App.go('usr_obl')">Ver mis obligaciones</button>
                <button class="btn small" style="margin-left:8px" onclick="App.go('usr_sos')">üÜò S.O.S</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin:0">
          <div class="bd">
            <div class="subtle">
              <b>Unidad asignada</b>
              <div class="divider"></div>
              ${myVeh ? `
                <div class="chips">
                  <span class="chip blue">üèçÔ∏è Modelo: <b>${safeText(myVeh.model||"-")}</b></span>
                  <span class="chip yellow">üé® Color: <b>${safeText(myVeh.color||"-")}</b></span>
                  <span class="chip blue">üí∞ Cuota: <b>$ ${toNumber(myVeh.weeklyFee).toLocaleString("es-AR")}</b></span>
                </div>
                <div class="divider"></div>
                <div class="chips">
                  <span class="chip green">üõ°Ô∏è Seguro hasta: <b class="mono">${myVeh.insuranceUntil ? fmtDate(myVeh.insuranceUntil) : "-"}</b></span>
                  <span class="chip yellow">üè¢ Aseguradora: <b>${safeText(myVeh.insurer||"-")}</b></span>
                  <span class="chip green">üîß VTV hasta: <b class="mono">${myVeh.vtvUntil ? fmtDate(myVeh.vtvUntil) : "-"}</b></span>
                </div>
              ` : `
                <span class="chip red">Sin veh√≠culo asignado</span>
                <div class="divider"></div>
                <div class="mutedSmall">Contact√° al administrador para asignarte una unidad.</div>
              `}
            </div>
          </div>
        </div>
      </div>

      ${overdue.length ? `
        <div class="divider"></div>
        <div class="hintBox">
          <b>Ten√©s ${overdue.length} obligaci√≥n(es) vencida(s).</b> Revis√° el detalle en <b>Mis obligaciones</b>.
        </div>
      ` : ``}
    `;
  }
};

const UserObligations = {
  view(){
    const db = Data.ensure();
    const me = Auth.current();
    if(!me) return;

    // Asegurar auto-generation por si cambi√≥ algo
    Obligations.autoGenerateForUser(me.id, {weeksAhead: 16});

    const list = Obligations.listForUser(me.id);
    const today = startOfDay(new Date());

    UI.setMain("Mis obligaciones", "Listado de cuotas/obligaciones. Estado y vencimientos.", `
      <span class="chip blue">üßæ ${list.length} registros</span>
    `);

    const rows = list.map(o=>{
      const due = startOfDay(new Date(o.dueDate));
      const isOver = o.status!=="pagado" && due < today;
      return `
        <tr>
          <td class="mono">${fmtDate(o.dueDate)}</td>
          <td class="mono">$ ${toNumber(o.amount).toLocaleString("es-AR")}</td>
          <td>${safeText(o.note||"")}</td>
          <td>${o.auto ? `<span class="chip blue">Auto</span>` : `<span class="chip yellow">Manual</span>`}</td>
          <td>${Obligations.statusChip(o)} ${isOver? `<span class="chip red">‚õî Vencida</span>`:""}</td>
        </tr>
      `;
    }).join("");

    $("#mainBody").innerHTML = `
      <div class="subtle">
        <div class="chips">
          <span class="chip blue">‚ÑπÔ∏è Generaci√≥n autom√°tica semanal</span>
          <span class="chip yellow">‚è∞ Vence cada 7 d√≠as</span>
        </div>
      </div>

      <div class="divider"></div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Vencimiento</th>
              <th>Monto</th>
              <th>Observaci√≥n</th>
              <th>Tipo</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            ${rows || `<tr><td colspan="5" class="subtle">No hay obligaciones.</td></tr>`}
          </tbody>
        </table>
      </div>

      <div class="divider"></div>
      <div class="hintBox">
        <b>Importante:</b> si tu inicio de contrato o asignaci√≥n cambi√≥, el sistema puede agregar nuevas obligaciones hacia adelante autom√°ticamente.
      </div>
    `;
  }
};

const UserSOS = {
  view(){
    const me = Auth.current();
    if(!me) return;

    UI.setMain("S.O.S", "Accesos r√°pidos de emergencia/ayuda.", `
      <span class="chip red">üÜò R√°pido</span>
    `);

    $("#mainBody").innerHTML = `
      <div class="card" style="margin:0">
        <div class="bd">
          <div class="subtle">
            <b>Eleg√≠ una opci√≥n:</b>
            <div class="divider"></div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <a class="btn primary" href="tel:+541152889290">üìû Llamar a Recupero</a>
              <a class="btn" href="https://wa.me/541130697389" target="_blank" rel="noopener">üí¨ WhatsApp Propietario 1</a>
              <a class="btn" href="https://wa.me/541170091012" target="_blank" rel="noopener">üí¨ WhatsApp Propietario 2</a>
            </div>

            <div class="divider"></div>
            <div class="mutedSmall">
              Si est√°s en una emergencia real, llam√° a los servicios de emergencia de tu zona.
            </div>
          </div>
        </div>
      </div>
    `;
  }
};

/* ===========================
   APP ROUTER
=========================== */
const App = {
  state:{
    tab:null
  },
  init(){
    const db = Data.ensure();

    const user = Auth.current();
    const logged = !!user;

    $("#viewLogin").classList.toggle("hide", logged);
    $("#viewApp").classList.toggle("hide", !logged);
    $("#btnLogout").classList.toggle("hide", !logged);

    if(!logged){
      $("#whoName").textContent = "‚Äî";
      $("#whoRole").textContent = "‚Äî";
      $("#avatar").textContent = "A";
      $("#loginUser").value = "";
      $("#loginPass").value = "";
      return;
    }

    // Identidad
    $("#whoName").textContent = user.username;
    $("#whoRole").textContent = user.role === "admin" ? "Administrador" : "Usuario";
    $("#avatar").textContent = (user.username||"U").slice(0,1).toUpperCase();

    // Tabs
    UI.renderTabs(user);

    // Default tab
    const defaultTab = (user.role === "admin") ? "adm_users" : "usr_home";
    const goTab = App.state.tab && document.querySelector(`[data-tab="${App.state.tab}"]`) ? App.state.tab : defaultTab;
    App.go(goTab, {silent:true});
  },

  go(tabId, {silent=false}={}){
    const user = Auth.current();
    if(!user) return;

    App.state.tab = tabId;
    UI.setActiveTab(tabId);

    // Render seg√∫n tab
    if(user.role === "admin"){
      if(tabId === "adm_users") AdminUsers.view();
      else if(tabId === "adm_veh") AdminVehicles.view();
      else if(tabId === "adm_obl") AdminObligations.view();
      else if(tabId === "adm_reports") AdminReports.view();
      else AdminUsers.view();
    } else {
      if(tabId === "usr_home") UserHome.view();
      else if(tabId === "usr_obl") UserObligations.view();
      else if(tabId === "usr_sos") UserSOS.view();
      else UserHome.view();
    }

    if(!silent) Toast.show("Listo", "Panel actualizado.", "ok");
  }
};

/* ===========================
   EVENTS / BOOT
=========================== */
$("#btnLogout").addEventListener("click", ()=> Auth.logout());
$("#btnSeed").addEventListener("click", ()=> Data.seedDemo());

// Enter para login
$("#loginPass").addEventListener("keydown", (e)=>{
  if(e.key==="Enter") Auth.login();
});
$("#loginUser").addEventListener("keydown", (e)=>{
  if(e.key==="Enter") $("#loginPass").focus();
});

// Primera carga
(function boot(){
  Data.ensure();
  // generar obligaciones por si ya hab√≠a usuarios con contrato
  Obligations.autoGenerateForAll({weeksAhead: 16});
  App.init();
})();
</script>

</body>
</html>
