<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gesti√≥n Vehicular</title>

  <!-- Export libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#e9ecef; --card:#fff; --text:#111; --muted:#666; --line:#ddd;
      --primary:#007bff; --primary2:#0056b3;
      --ok:#198754; --ok2:#146c43;
      --danger:#dc3545; --danger2:#b02a37;
      --warn:#ffc107; --warn2:#e0a800;
      --secondary:#6c757d; --secondary2:#565e64;
    }
    *{box-sizing:border-box}
    body{font-family:Arial, sans-serif;background:var(--bg);margin:0;min-height:100vh;display:flex;justify-content:center;align-items:center;color:var(--text)}
    .box{background:var(--card);padding:16px;width:1180px;max-width:98vw;border-radius:12px;box-shadow:0 0 12px rgba(0,0,0,.18)}
    .hidden{display:none}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;background:#f7f7f7}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:260px}
    h2,h3,h4{margin:8px 0}
    .section{margin-top:10px}

    input,select,textarea{
      width:100%;padding:8px;margin:4px 0;border:1px solid #ccc;border-radius:10px
    }
    textarea{min-height:74px;resize:vertical}

    button{
      padding:8px 10px;border:0;border-radius:10px;background:var(--primary);color:#fff;cursor:pointer
    }
    button:hover{background:var(--primary2)}
    button:disabled{opacity:.45;cursor:not-allowed}

    .btn-ok{background:var(--ok)}
    .btn-ok:hover{background:var(--ok2)}
    .btn-danger{background:var(--danger)}
    .btn-danger:hover{background:var(--danger2)}
    .btn-warn{background:var(--warn);color:#111}
    .btn-warn:hover{background:var(--warn2)}
    .btn-secondary{background:var(--secondary)}
    .btn-secondary:hover{background:var(--secondary2)}

    table{width:100%;border-collapse:collapse;font-size:12px;margin-top:8px}
    td,th{border:1px solid var(--line);padding:6px;text-align:center;vertical-align:middle}
    th{background:#f7f7f7}

    .ok{color:var(--ok);font-weight:700}
    .bad{color:var(--danger);font-weight:700}
    .admin{color:var(--ok);font-weight:700}

    .menu{display:flex;gap:8px;margin:10px 0;border-bottom:1px solid var(--line);padding-bottom:10px;flex-wrap:wrap}
    .menu button{background:#f8f9fa;border:1px solid var(--line);color:#111}
    .menu button:hover{background:#e9ecef}
    .menu.user button{color:#000 !important;font-weight:800}

    .cardline{border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:10px;background:#fafafa}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;background:#fff}
    .chip.ok{color:var(--ok)}
    .chip.warn{color:#8a6d00}
    .chip.bad{color:var(--danger)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:860px){.grid2{grid-template-columns:1fr}}

    /* Mobile: tables -> cards */
    @media(max-width:820px){
      .box{padding:12px}
      .col{min-width:180px}
      table{border:0}
      thead{display:none}
      tr{display:block;border:1px solid var(--line);border-radius:12px;margin:10px 0;overflow:hidden;background:#fff}
      td{display:flex;justify-content:space-between;gap:10px;text-align:left;border:0;border-top:1px solid var(--line);padding:10px}
      td:first-child{border-top:0}
      td::before{content:attr(data-label);font-weight:700;color:#333;min-width:120px}
      td > button{width:100%}
      .menu{gap:6px}
      .menu button{flex:1}
    }

    .logoWrap{display:flex;justify-content:center;margin-bottom:10px}
    .logo{
      max-width:220px; max-height:70px; object-fit:contain;
    }
    .logoSmall{
      max-width:140px; max-height:42px; object-fit:contain;
    }
  </style>
</head>

<body>

<!-- LOGIN -->
<div class="box" id="loginBox">
  <div class="logoWrap">
    <img id="logoLogin" class="logo" alt="Logo"/>
  </div>
  <h3 style="text-align:center;margin-top:0">Iniciar sesi√≥n</h3>
  <input id="loginUser" placeholder="Usuario" autocomplete="username" />
  <input id="loginPass" type="password" placeholder="Contrase√±a" autocomplete="current-password" />
  <button onclick="login()" style="width:100%">Ingresar</button>
</div>

<!-- APP -->
<div class="box hidden" id="panel">
  <div class="topbar">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <img id="logoTop" class="logoSmall" alt="Logo"/>
      <div>
        <div id="panelTitle"><b>Panel</b></div>
        <div id="panelSubtitle" style="font-size:12px;color:var(--muted)"></div>
      </div>
    </div>
    <div class="right">
      <span id="rolePill" class="pill"></span>
      <button class="btn-danger" onclick="logout()">Cerrar sesi√≥n</button>
    </div>
  </div>

  <!-- USER PANEL -->
  <div id="userPanel" class="hidden">
    <div class="menu user">
      <button onclick="showUserTab('uPagos')">PAGOS</button>
      <button onclick="showUserTab('uKm')">KM</button>
      <button onclick="showUserTab('uDocs')">DOCUMENTOS</button>
    </div>

    <div class="cardline" id="userHomeCard">
      <h3 id="userHello" style="margin-top:0"></h3>
      <div class="row">
        <div class="col">
          <div><b>Estado de cuenta:</b> <span id="userEstado"></span></div>
        </div>
        <div class="col" id="userSingleVehicleSummary"></div>
      </div>
    </div>

    <!-- PAGOS -->
    <div id="uPagos" class="section">
      <h4>Veh√≠culos</h4>
      <table>
        <thead><tr><th>Dominio</th><th>Modelo</th><th>Color</th><th>Cuota semanal</th><th>VTV</th><th>Seguro</th><th>Aceite</th></tr></thead>
        <tbody id="userVehTable"></tbody>
      </table>

      <h4 style="margin-top:12px">Obligaciones</h4>
      <table>
        <thead>
          <tr>
            <th>Dominio</th><th>Concepto</th><th>Monto</th><th>Vence</th>
            <th>Estado</th><th>Medio</th><th>Fecha</th><th>Obs.</th><th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="userObTable"></tbody>
      </table>
    </div>

    <!-- KM -->
    <div id="uKm" class="section hidden">
      <h4>KM</h4>
      <div class="row">
        <div class="col">
          <select id="kmDomSelect"></select>
          <input id="kmValue" type="number" placeholder="Kilometraje actual" />
        </div>
        <div class="col">
          <button onclick="userSaveKm()" style="width:100%">Guardar</button>
        </div>
      </div>

      <h4 style="margin-top:12px">Aceite</h4>
      <div id="userOilCards" class="grid2"></div>

      <h4 style="margin-top:12px">Historial KM</h4>
      <table>
        <thead><tr><th>Dominio</th><th>KM</th><th>Fecha</th></tr></thead>
        <tbody id="userKmTable"></tbody>
      </table>
    </div>

    <!-- DOCS -->
    <div id="uDocs" class="section hidden">
      <h4>Documentos</h4>
      <div id="userDocsCards" class="grid2"></div>
    </div>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="hidden">
    <h3 class="admin">Administrador</h3>

    <div class="menu">
      <button onclick="showAdminTab('aUsers')">Usuarios</button>
      <button onclick="showAdminTab('aVeh')">Veh√≠culos</button>
      <button onclick="showAdminTab('aOb')">Obligaciones</button>
      <button onclick="showAdminTab('aTaller')">Taller</button>
      <button onclick="showAdminTab('aKm')">KM</button>
      <button onclick="showAdminTab('aLogs')">Logs</button>
    </div>

    <!-- USERS -->
    <div id="aUsers" class="section">
      <div class="row">
        <div class="col">
          <h4>Alta usuario</h4>
          <input id="nuUser" placeholder="Usuario" />
          <input id="nuNombre" placeholder="Nombre" />
          <input id="nuTelefono" placeholder="Tel√©fono WhatsApp (obligatorio)" />
          <input id="nuPass" placeholder="Contrase√±a (default 1234)" />
          <select id="nuRole">
            <option value="USUARIO">USUARIO</option>
            <option value="ADMIN">ADMIN</option>
          </select>
        </div>
        <div class="col">
          <h4>Alquiler semanal</h4>
          <input id="nuAlqInicio" type="date" />
          <input id="nuAlqMonto" type="number" placeholder="Monto alquiler semanal" />
          <select id="nuAlqEstado">
            <option value="ACTIVO">ACTIVO</option>
            <option value="PAUSADO">PAUSADO</option>
            <option value="FINALIZADO">FINALIZADO</option>
          </select>
          <button class="btn-ok" onclick="adminCreateUser()" style="width:100%">Crear</button>
          <div class="row" style="margin-top:8px">
            <div class="col"><button class="btn-secondary" onclick="exportAdminTable('users')" style="width:100%">Exportar</button></div>
            <div class="col"><button class="btn-danger" onclick="adminResetAll()" style="width:100%">Reset</button></div>
          </div>
        </div>
      </div>

      <h4 style="margin-top:12px">Usuarios</h4>
      <table>
        <thead>
          <tr>
            <th>Usuario</th><th>Nombre</th><th>Rol</th><th>Tel√©fono</th><th>Clave</th>
            <th>Alq inicio</th><th>Alq monto</th><th>Alq estado</th>
            <th>Guardar</th><th>Eliminar</th>
          </tr>
        </thead>
        <tbody id="adminUsersTable"></tbody>
      </table>
    </div>

    <!-- VEHICLES -->
    <div id="aVeh" class="section hidden">
      <div class="row">
        <div class="col">
          <h4>Veh√≠culo</h4>
          <select id="vehSelect" onchange="adminLoadVehicleForm()">
            <option value="">Nuevo</option>
          </select>
          <input id="vDom" placeholder="Dominio" />
          <input id="vModelo" placeholder="Modelo" />
          <input id="vColor" placeholder="Color" />
        </div>
        <div class="col">
          <h4>&nbsp;</h4>
          <input id="vCuota" type="number" placeholder="Cuota semanal" />
          <input id="vVtv" type="date" />
          <input id="vSeguro" placeholder="Seguro" />
          <select id="vAssign"></select>
          <div class="row">
            <div class="col"><button class="btn-ok" onclick="adminSaveVehicle()" style="width:100%">Guardar</button></div>
            <div class="col"><button class="btn-danger" onclick="adminDeleteVehicle()" style="width:100%">Eliminar</button></div>
          </div>
          <button class="btn-secondary" onclick="exportAdminTable('vehicles')" style="width:100%;margin-top:8px">Exportar</button>
        </div>
      </div>

      <h4 style="margin-top:12px">Listado</h4>
      <table>
        <thead>
          <tr><th>Dominio</th><th>Modelo</th><th>Color</th><th>Cuota</th><th>VTV</th><th>Seguro</th><th>Usuario</th><th>Guardar</th></tr>
        </thead>
        <tbody id="adminVehTable"></tbody>
      </table>
    </div>

    <!-- OBLIGATIONS -->
    <div id="aOb" class="section hidden">
      <div class="row">
        <div class="col">
          <input id="fDom" placeholder="Filtrar dominio" />
        </div>
        <div class="col">
          <input id="fUser" placeholder="Filtrar usuario" />
        </div>
        <div class="col">
          <select id="fVencidas">
            <option value="">Todas</option>
            <option value="vencidas">Solo vencidas</option>
          </select>
        </div>
        <div class="col">
          <button onclick="adminRenderObligations()" style="width:100%">Aplicar</button>
        </div>
      </div>

      <div class="menu" style="margin-top:10px">
        <button onclick="showObTab('pendientes')">Pendientes</button>
        <button onclick="showObTab('aprobadas')">Aprobadas</button>
        <button onclick="showObTab('rechazadas')">Rechazadas</button>
        <button onclick="showObTab('punitorios')">Punitorios</button>
        <button class="btn-secondary" onclick="exportAdminTable('obligations')" style="margin-left:auto">Exportar</button>
      </div>

      <div class="cardline">
        <div class="row">
          <div class="col">
            <select id="obDom"></select>
            <input id="obConcepto" placeholder="Concepto" />
          </div>
          <div class="col">
            <input id="obMonto" type="number" placeholder="Monto" />
            <input id="obVence" type="date" />
            <button class="btn-ok" onclick="adminAddObligation()" style="width:100%">Crear obligaci√≥n</button>
          </div>
        </div>
      </div>

      <!-- PENDIENTES -->
      <div id="ob_pendientes" class="section">
        <table>
          <thead>
            <tr>
              <th>Dominio</th><th>Usuario</th><th>Concepto</th><th>Monto</th><th>Vence</th><th>Estado</th>
              <th>Medio</th><th>Fecha</th><th>Aprobar</th><th>Rechazar</th>
            </tr>
          </thead>
          <tbody id="adminObPendientes"></tbody>
        </table>
      </div>

      <!-- APROBADAS -->
      <div id="ob_aprobadas" class="section hidden">
        <table>
          <thead>
            <tr>
              <th>Dominio</th><th>Usuario</th><th>Concepto</th><th>Monto</th><th>Vence</th><th>Estado</th><th>Medio</th><th>Fecha</th>
            </tr>
          </thead>
          <tbody id="adminObAprobadas"></tbody>
        </table>
      </div>

      <!-- RECHAZADAS -->
      <div id="ob_rechazadas" class="section hidden">
        <table>
          <thead>
            <tr>
              <th>Dominio</th><th>Usuario</th><th>Concepto</th><th>Monto</th><th>Vence</th><th>Estado</th><th>Medio</th><th>Fecha</th><th>Motivo</th>
            </tr>
          </thead>
          <tbody id="adminObRechazadas"></tbody>
        </table>
      </div>

      <!-- PUNITORIOS -->
      <div id="ob_punitorios" class="section hidden">
        <table>
          <thead>
            <tr>
              <th>Dominio</th><th>Usuario</th><th>Concepto</th><th>Monto</th><th>Vence</th><th>Estado</th><th>Padre</th>
              <th>Quita</th><th>Editar</th><th>Eliminar</th>
            </tr>
          </thead>
          <tbody id="adminObPunitorios"></tbody>
        </table>
      </div>
    </div>

    <!-- TALLER -->
    <div id="aTaller" class="section hidden">
      <div class="cardline">
        <div class="row">
          <div class="col">
            <select id="tDom"></select>
            <input id="tFecha" type="date" />
            <input id="tKm" type="number" placeholder="KM" />
          </div>
          <div class="col">
            <input id="tTipo" placeholder="Tipo" />
            <input id="tCosto" type="number" placeholder="Costo" />
            <input id="tTaller" placeholder="Taller" />
          </div>
        </div>
        <textarea id="tDesc" placeholder="Descripci√≥n"></textarea>
        <button class="btn-ok" onclick="adminAddTaller()" style="width:100%">Registrar</button>
      </div>

      <div class="cardline">
        <div class="row">
          <div class="col"><select id="oilDom"></select></div>
          <div class="col"><input id="oilFecha" type="date" /></div>
          <div class="col"><input id="oilKm" type="number" placeholder="KM cambio aceite" /></div>
        </div>
        <textarea id="oilObs" placeholder="Observaci√≥n"></textarea>
        <div class="row">
          <div class="col"><button class="btn-ok" onclick="adminValidateOilChange()" style="width:100%">Validar aceite</button></div>
          <div class="col"><button class="btn-secondary" onclick="adminSendOilReminderWhatsApp()" style="width:100%">WhatsApp aceite</button></div>
        </div>
      </div>

      <div class="row">
        <div class="col"><button class="btn-secondary" onclick="exportAdminTable('taller')" style="width:100%">Exportar Taller</button></div>
        <div class="col"><button class="btn-secondary" onclick="exportAdminTable('oilReminders')" style="width:100%">Exportar WhatsApp</button></div>
      </div>

      <h4>Historial taller</h4>
      <table>
        <thead>
          <tr><th>Dominio</th><th>Fecha</th><th>KM</th><th>Tipo</th><th>Costo</th><th>Taller</th><th>Descripci√≥n</th><th>Por</th></tr>
        </thead>
        <tbody id="tallerTable"></tbody>
      </table>

      <h4>Historial aceite</h4>
      <table>
        <thead><tr><th>Dominio</th><th>Fecha</th><th>KM</th><th>Obs.</th><th>Por</th></tr></thead>
        <tbody id="oilHistoryTable"></tbody>
      </table>

      <h4>Historial WhatsApp aceite</h4>
      <table>
        <thead><tr><th>Dominio</th><th>Usuario</th><th>Tel√©fono</th><th>Estado</th><th>Restan</th><th>Fecha</th></tr></thead>
        <tbody id="oilReminderTable"></tbody>
      </table>
    </div>

    <!-- KM -->
    <div id="aKm" class="section hidden">
      <div class="row">
        <div class="col"><button class="btn-secondary" onclick="exportAdminTable('km')" style="width:100%">Exportar KM</button></div>
        <div class="col"><button class="btn-secondary" onclick="exportAdminTable('oilStatus')" style="width:100%">Exportar Aceite</button></div>
      </div>
      <table>
        <thead><tr><th>Dominio</th><th>KM</th><th>Fecha</th><th>Usuario</th></tr></thead>
        <tbody id="adminKmTable"></tbody>
      </table>
    </div>

    <!-- LOGS -->
    <div id="aLogs" class="section hidden">
      <button class="btn-secondary" onclick="exportAdminTable('logs')" style="width:100%">Exportar Logs</button>
      <table>
        <thead><tr><th>Usuario</th><th>Fecha</th></tr></thead>
        <tbody id="logTable"></tbody>
      </table>
    </div>

  </div>
</div>

<script>
/* ========= CONFIG ========= */
const LOGO_URL = "https://drive.google.com/uc?export=view&id=19j4ofQV4ONnwBDKXss16-L2F2rh5DK32";

const OIL_INTERVAL_KM = 1200;
const OIL_WARN_THRESHOLD = 300;

const RENT_GEN_OFFSET_DAYS = 5;
const RENT_DUE_OFFSET_DAYS = 7;      // vence al d√≠a 7 desde inicio + (semanas)
const PENALTY_RATE = 0.10;           // 10% del alquiler semanal
const PENALTY_PERIOD_DAYS = 7;       // semanal

/* ========= STORAGE ========= */
const KEYS = {
  users: "gv_users_v3",
  vehicles: "gv_vehicles_v3",
  obligations: "gv_obligations_v3",
  kms: "gv_kms_v3",
  logs: "gv_logs_v3",
  taller: "gv_taller_v3",
  oilHistory: "gv_oil_history_v3",
  oilReminders: "gv_oil_reminders_v3"
};

function loadJSON(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return fallback;
    const parsed = JSON.parse(raw);
    return parsed ?? fallback;
  }catch{ return fallback; }
}
function saveJSON(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

let users = loadJSON(KEYS.users, {
  admin: {
    password:"1234",
    role:"ADMIN",
    nombre:"Administrador",
    telefono:"",
    alquiler: { inicio:"", monto:0, estado:"FINALIZADO" }
  }
});
let vehicles = loadJSON(KEYS.vehicles, {});   // {dominio:{...}}
let obligations = loadJSON(KEYS.obligations, []); // array
let kms = loadJSON(KEYS.kms, []); // array
let logs = loadJSON(KEYS.logs, []); // array
let taller = loadJSON(KEYS.taller, []); // array
let oilHistory = loadJSON(KEYS.oilHistory, []); // array
let oilReminders = loadJSON(KEYS.oilReminders, []); // array

function saveAll(){
  saveJSON(KEYS.users, users);
  saveJSON(KEYS.vehicles, vehicles);
  saveJSON(KEYS.obligations, obligations);
  saveJSON(KEYS.kms, kms);
  saveJSON(KEYS.logs, logs);
  saveJSON(KEYS.taller, taller);
  saveJSON(KEYS.oilHistory, oilHistory);
  saveJSON(KEYS.oilReminders, oilReminders);
}

/* ========= HELPERS ========= */
let currentUser = null;

function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function nowStr(){ return new Date().toLocaleString(); }
function uid(){ return Date.now() + Math.floor(Math.random()*1000); }

function todayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function parseISO(d){ return d ? new Date(d+"T00:00:00") : null; }
function fmtISO(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function addDays(date, days){
  const d = new Date(date.getTime());
  d.setDate(d.getDate()+days);
  return d;
}
function daysBetween(a,b){
  // whole days between (b - a)
  const ms = (b.getTime() - a.getTime());
  return Math.floor(ms / (24*60*60*1000));
}

function normalizeWhatsAppPhone(raw){
  return String(raw||"").replace(/\D/g,"");
}

function getUserVehicles(username){
  return Object.values(vehicles)
    .filter(v => (v.usuario || "") === username)
    .sort((a,b)=>a.dominio.localeCompare(b.dominio));
}
function vehicleOwnerUsername(dom){ return vehicles[dom]?.usuario || ""; }
function vehicleOwnerPhone(dom){
  const u = vehicleOwnerUsername(dom);
  return users[u]?.telefono || "";
}

function ensureVehicleOilFields(v){
  if(!v.aceite){
    v.aceite = { intervaloKm: OIL_INTERVAL_KM, ultimoCambioKm: 0, ultimoCambioFecha: "", ultimoKmRegistrado: 0 };
  }
  if(!v.aceite.intervaloKm) v.aceite.intervaloKm = OIL_INTERVAL_KM;
  v.aceite.ultimoCambioKm = Number(v.aceite.ultimoCambioKm||0);
  v.aceite.ultimoKmRegistrado = Number(v.aceite.ultimoKmRegistrado||0);
}

function computeOilStatusForVehicle(v){
  ensureVehicleOilFields(v);
  const kmActual = Number(v.kmActual || 0);
  const lastChange = Number(v.aceite.ultimoCambioKm || 0);
  const interval = Number(v.aceite.intervaloKm || OIL_INTERVAL_KM);
  const kmDesde = kmActual - lastChange;
  const restantes = interval - kmDesde;

  let estado = "OK";
  if(restantes <= 0) estado = "VENCIDO";
  else if(restantes <= OIL_WARN_THRESHOLD) estado = "PROXIMO";

  return { kmActual, lastChange, interval, kmDesde, restantes, estado };
}
function oilChip(estado){
  if(estado==="OK") return `<span class="chip ok">OK</span>`;
  if(estado==="PROXIMO") return `<span class="chip warn">PR√ìXIMO</span>`;
  return `<span class="chip bad">VENCIDO</span>`;
}

function obBadge(st){
  if(st==="PAGADA") return `<span class="ok">PAGADA</span>`;
  if(st==="INFORMADO") return `<span class="pill">INFORMADO</span>`;
  if(st==="RECHAZADA") return `<span class="bad">RECHAZADA</span>`;
  if(st==="QUITADA") return `<span class="pill">QUITADA</span>`;
  return `<span class="pill">PENDIENTE</span>`;
}

function computeAccountStatus(username){
  const hoy = parseISO(todayISO());
  const myDom = new Set(getUserVehicles(username).map(v=>v.dominio));
  const hasDebt = obligations.some(o=>{
    if(!myDom.has(o.dominio)) return false;
    if(o.estado==="PAGADA" || o.estado==="QUITADA") return false;
    const venc = parseISO(o.vencimiento);
    return venc && venc < hoy;
  });
  return hasDebt ? "DEUDA" : "AL_DIA";
}

/* ========= AUTO GENERATORS (ALQUILER + PUNITORIOS) ========= */

function getUserRentPlan(username){
  const plan = users[username]?.alquiler || {inicio:"",monto:0,estado:"FINALIZADO"};
  return {
    inicio: plan.inicio || "",
    monto: Number(plan.monto||0),
    estado: plan.estado || "FINALIZADO"
  };
}

function getPrimaryDomainForUser(username){
  // si hay varios, usa el primero ordenado
  const list = getUserVehicles(username);
  return list.length ? list[0].dominio : "";
}

function obExistsByKey(key){
  return obligations.some(o=>o.autoKey===key);
}

function autoCreateRentObligationsForUser(username){
  const plan = getUserRentPlan(username);
  if(plan.estado !== "ACTIVO") return;
  if(!plan.inicio) return;
  if(!(plan.monto > 0)) return;

  const dom = getPrimaryDomainForUser(username);
  if(!dom) return;

  const start = parseISO(plan.inicio);
  const today = parseISO(todayISO());
  if(!start || !today) return;

  // semana 0: gen = start+5, due = start+7
  const gen0 = addDays(start, RENT_GEN_OFFSET_DAYS);

  // si todav√≠a no lleg√≥ gen0, no crea
  if(today < gen0) return;

  const daysSinceGen0 = daysBetween(gen0, today);
  const weekIndexMax = Math.floor(daysSinceGen0 / 7);

  for(let w=0; w<=weekIndexMax; w++){
    const genDate = addDays(gen0, w*7);
    const dueDate = addDays(start, RENT_DUE_OFFSET_DAYS + w*7);

    const key = `RENT:${username}:${dom}:${fmtISO(genDate)}`;
    if(obExistsByKey(key)) continue;

    obligations.push({
      id: uid(),
      tipo: "AUTOMATICA",
      subtipo: "ALQUILER",
      dominio: dom,
      concepto: "Alquiler semanal",
      monto: plan.monto,
      vencimiento: fmtISO(dueDate),
      estado: "PENDIENTE",
      medioPago: "",
      fechaPago: "",
      motivoRechazo: "",
      autoKey: key,
      parentId: null
    });
  }
}

function autoCreatePenaltiesForRentObligation(rentOb){
  // Crea punitorios semanales del 10% hasta que se pague la principal.
  // Solo aplica a obligaciones de alquiler.
  if(rentOb.subtipo !== "ALQUILER") return;
  if(rentOb.estado === "PAGADA") return;

  const dom = rentOb.dominio;
  const owner = vehicleOwnerUsername(dom);
  if(!owner) return;

  const plan = getUserRentPlan(owner);
  const baseRent = Number(plan.monto || rentOb.monto || 0);
  if(!(baseRent > 0)) return;

  const today = parseISO(todayISO());
  const due = parseISO(rentOb.vencimiento);
  if(!today || !due) return;
  if(today <= due) return; // no mora a√∫n

  const daysLate = daysBetween(due, today);
  const weeksLate = Math.floor(daysLate / PENALTY_PERIOD_DAYS) + 1; // 1er punitorio al pasar 0..6 d√≠as? se considera semana de mora iniciada

  for(let k=1; k<=weeksLate; k++){
    // punitorio k: vence a la semana de mora + 2 d√≠as (mismo patr√≥n que alquiler: 7 total)
    // simplificaci√≥n: vence 2 d√≠as luego del "inicio de esa semana de mora"
    const weekStart = addDays(due, (k-1)*PENALTY_PERIOD_DAYS);
    const penDue = addDays(weekStart, 2);

    const key = `PEN:${rentOb.id}:${k}`;
    if(obExistsByKey(key)) continue;

    obligations.push({
      id: uid(),
      tipo: "AUTOMATICA",
      subtipo: "PUNITORIO",
      dominio: dom,
      concepto: `Punitorio mora 10% (semana ${k})`,
      monto: Math.round(baseRent * PENALTY_RATE),
      vencimiento: fmtISO(penDue),
      estado: "PENDIENTE",
      medioPago: "",
      fechaPago: "",
      motivoRechazo: "",
      autoKey: key,
      parentId: rentOb.id
    });
  }
}

function runAutoGeneration(){
  // alquiler
  Object.keys(users).forEach(u=>{
    if(u==="admin") return;
    if(users[u].role !== "USUARIO") return;
    autoCreateRentObligationsForUser(u);
  });

  // punitorios
  const rentals = obligations.filter(o => o.subtipo==="ALQUILER");
  rentals.forEach(o=>{
    // si la principal se paga, no genera m√°s punitorios futuros
    if(o.estado !== "PAGADA"){
      autoCreatePenaltiesForRentObligation(o);
    }
  });

  saveAll();
}

/* ========= LOGIN / NAV ========= */
function applyLogo(){
  document.getElementById("logoLogin").src = LOGO_URL;
  document.getElementById("logoTop").src = LOGO_URL;
}

function login(){
  const u = document.getElementById("loginUser").value.trim();
  const p = document.getElementById("loginPass").value;

  if(!users[u] || users[u].password !== p){
    return;
  }

  currentUser = u;

  logs.unshift({ user: u, date: nowStr() });
  saveAll();

  // generar autom√°ticas al iniciar sesi√≥n
  runAutoGeneration();

  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("panel").classList.remove("hidden");

  document.getElementById("rolePill").textContent = users[u].role;
  document.getElementById("panelTitle").innerHTML = users[u].role==="ADMIN" ? "<b>Administrador</b>" : "<b>Veh√≠culo</b>";
  document.getElementById("panelSubtitle").textContent = users[u].role==="ADMIN" ? "" : `Usuario: ${u}`;

  if(users[u].role === "ADMIN"){
    document.getElementById("adminPanel").classList.remove("hidden");
    document.getElementById("userPanel").classList.add("hidden");
    showAdminTab("aUsers");
    adminRenderAll();
  }else{
    document.getElementById("userPanel").classList.remove("hidden");
    document.getElementById("adminPanel").classList.add("hidden");
    showUserTab("uPagos");
    userRenderAll();
  }
}

function logout(){ location.reload(); }

function showUserTab(id){
  ["uPagos","uKm","uDocs"].forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");

  if(id==="uPagos"){ userRenderHeader(); userRenderVehicles(); userRenderObligations(); }
  if(id==="uKm"){ userRenderKm(); }
  if(id==="uDocs"){ userRenderDocs(); }
}
function showAdminTab(id){
  ["aUsers","aVeh","aOb","aTaller","aKm","aLogs"].forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");

  if(id==="aUsers") adminRenderUsers();
  if(id==="aVeh") adminRenderVehicles();
  if(id==="aOb") { showObTab("pendientes"); adminRenderObligations(); }
  if(id==="aTaller") adminRenderTallerAll();
  if(id==="aKm") adminRenderKm();
  if(id==="aLogs") adminRenderLogs();
}
function showObTab(tab){
  ["ob_pendientes","ob_aprobadas","ob_rechazadas","ob_punitorios"].forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById("ob_"+tab).classList.remove("hidden");
}

/* ========= USER ========= */
function userRenderAll(){
  userRenderHeader();
  userRenderVehicles();
  userRenderObligations();
  userRenderKm();
  userRenderDocs();
}

function userRenderHeader(){
  const u = users[currentUser];
  document.getElementById("userHello").textContent = `Hola ${u?.nombre || currentUser}`;

  const st = computeAccountStatus(currentUser);
  document.getElementById("userEstado").innerHTML =
    st==="DEUDA" ? `<span class="bad">DEUDA</span>` : `<span class="ok">AL D√çA</span>`;

  const my = getUserVehicles(currentUser);
  const box = document.getElementById("userSingleVehicleSummary");
  box.innerHTML = "";

  if(my.length === 1){
    const v = my[0];
    const oil = computeOilStatusForVehicle(v);
    box.innerHTML = `
      <div><b>Dominio:</b> ${esc(v.dominio)}</div>
      <div><b>Cuota semanal:</b> $${Number(v.cuotaSemanal||0)}</div>
      <div style="margin-top:6px"><b>Aceite:</b> ${oilChip(oil.estado)} <span style="color:var(--muted);font-size:12px">Restan ${oil.restantes} km</span></div>
    `;
  }else if(my.length > 1){
    box.innerHTML = `<div><b>Veh√≠culos:</b> ${my.length}</div>`;
  }
}

function userRenderVehicles(){
  const tbody = document.getElementById("userVehTable");
  tbody.innerHTML = "";

  const my = getUserVehicles(currentUser);
  if(my.length===0){
    tbody.innerHTML = `<tr><td colspan="7" data-label="Estado">Sin veh√≠culos</td></tr>`;
    return;
  }

  my.forEach(v=>{
    const oil = computeOilStatusForVehicle(v);
    tbody.innerHTML += `
      <tr>
        <td data-label="Dominio"><b>${esc(v.dominio)}</b></td>
        <td data-label="Modelo">${esc(v.modelo||"-")}</td>
        <td data-label="Color">${esc(v.color||"-")}</td>
        <td data-label="Cuota">$${Number(v.cuotaSemanal||0)}</td>
        <td data-label="VTV">${esc(v.vtv||"-")}</td>
        <td data-label="Seguro">${esc(v.seguro||"-")}</td>
        <td data-label="Aceite">${oilChip(oil.estado)} <span style="color:var(--muted);font-size:12px">(${oil.restantes})</span></td>
      </tr>
    `;
  });
}

function userRenderObligations(){
  const tbody = document.getElementById("userObTable");
  tbody.innerHTML = "";

  const myDom = new Set(getUserVehicles(currentUser).map(v=>v.dominio));
  const items = obligations
    .filter(o=>myDom.has(o.dominio))
    .sort((a,b)=> new Date(a.vencimiento) - new Date(b.vencimiento));

  if(items.length===0){
    tbody.innerHTML = `<tr><td colspan="9" data-label="Estado">Sin obligaciones</td></tr>`;
    return;
  }

  items.forEach(o=>{
    const canInform = (o.estado==="PENDIENTE" || o.estado==="RECHAZADA");
    tbody.innerHTML += `
      <tr>
        <td data-label="Dominio"><b>${esc(o.dominio)}</b></td>
        <td data-label="Concepto">${esc(o.concepto)}</td>
        <td data-label="Monto">$${Number(o.monto||0)}</td>
        <td data-label="Vence">${esc(o.vencimiento)}</td>
        <td data-label="Estado">${obBadge(o.estado)}</td>
        <td data-label="Medio">${esc(o.medioPago||"-")}</td>
        <td data-label="Fecha">${esc(o.fechaPago||"-")}</td>
        <td data-label="Obs.">${esc(o.motivoRechazo||"-")}</td>
        <td data-label="Acci√≥n">
          ${canInform ? `<button onclick="userInformPayment(${o.id})">Informar pago</button>` : "‚Äî"}
        </td>
      </tr>
    `;
  });
}

function userInformPayment(id){
  const ob = obligations.find(o=>o.id===id);
  if(!ob) return;

  if(!(ob.estado==="PENDIENTE" || ob.estado==="RECHAZADA")){
    return;
  }

  const veh = vehicles[ob.dominio];
  if(!veh || veh.usuario !== currentUser){
    return;
  }

  const medio = prompt("Medio de pago:");
  if(medio===null) return;
  const m = medio.trim();
  if(!m) return;

  ob.estado = "INFORMADO";
  ob.medioPago = m;
  ob.fechaPago = nowStr();
  ob.motivoRechazo = "";

  saveAll();
  userRenderObligations();
  userRenderHeader();
}

function userRenderKm(){
  const sel = document.getElementById("kmDomSelect");
  sel.innerHTML = "";

  const my = getUserVehicles(currentUser);
  if(my.length===0){
    sel.innerHTML = `<option value="">Sin veh√≠culos</option>`;
  }else{
    my.forEach(v=> sel.innerHTML += `<option value="${esc(v.dominio)}">${esc(v.dominio)}</option>`);
  }

  const cards = document.getElementById("userOilCards");
  cards.innerHTML = "";
  my.forEach(v=>{
    const oil = computeOilStatusForVehicle(v);
    const last = oil.lastChange ? `${oil.lastChange}` : "0";
    cards.innerHTML += `
      <div class="cardline">
        <div><b>${esc(v.dominio)}</b> ${oilChip(oil.estado)}</div>
        <div style="font-size:12px;color:var(--muted);margin-top:6px">
          KM actual: <b>${oil.kmActual}</b><br/>
          √öltimo aceite: <b>${last}</b><br/>
          Desde √∫ltimo: <b>${oil.kmDesde}</b><br/>
          Restan: <b>${oil.restantes}</b>
        </div>
      </div>
    `;
  });

  const tbody = document.getElementById("userKmTable");
  tbody.innerHTML = "";

  const myDom = new Set(my.map(v=>v.dominio));
  const items = kms.filter(k=>myDom.has(k.dominio));
  if(items.length===0){
    tbody.innerHTML = `<tr><td colspan="3" data-label="Estado">Sin registros</td></tr>`;
    return;
  }
  items.slice(0,400).forEach(k=>{
    tbody.innerHTML += `
      <tr>
        <td data-label="Dominio"><b>${esc(k.dominio)}</b></td>
        <td data-label="KM">${Number(k.km||0)}</td>
        <td data-label="Fecha">${esc(k.fecha)}</td>
      </tr>
    `;
  });
}

function userSaveKm(){
  const dom = document.getElementById("kmDomSelect").value;
  const km = Number(document.getElementById("kmValue").value || 0);

  if(!dom) return;
  if(!vehicles[dom] || vehicles[dom].usuario !== currentUser) return;
  if(!km || km<=0) return;

  const v = vehicles[dom];
  ensureVehicleOilFields(v);

  const prevKm = Number(v.kmActual || 0);
  if(km < prevKm) return;

  const lastChange = Number(v.aceite.ultimoCambioKm || 0);
  if(km < lastChange) return;

  v.kmActual = km;
  v.kmUpdatedAt = nowStr();
  v.aceite.ultimoKmRegistrado = km;

  kms.unshift({ id: uid(), dominio: dom, km, fecha: nowStr(), user: currentUser });
  saveAll();

  document.getElementById("kmValue").value = "";
  userRenderKm();
  userRenderVehicles();
  userRenderHeader();
}

function userRenderDocs(){
  const cards = document.getElementById("userDocsCards");
  cards.innerHTML = "";

  const my = getUserVehicles(currentUser);
  if(my.length===0){
    cards.innerHTML = `<div class="cardline">Sin veh√≠culos</div>`;
    return;
  }

  my.forEach(v=>{
    cards.innerHTML += `
      <div class="cardline">
        <div><b>${esc(v.dominio)}</b></div>
        <div style="font-size:12px;color:var(--muted);margin-top:6px">
          Modelo: <b>${esc(v.modelo||"-")}</b><br/>
          Color: <b>${esc(v.color||"-")}</b><br/>
          Cuota: <b>$${Number(v.cuotaSemanal||0)}</b><br/>
          VTV: <b>${esc(v.vtv||"-")}</b><br/>
          Seguro: <b>${esc(v.seguro||"-")}</b>
        </div>
      </div>
    `;
  });
}

/* ========= ADMIN USERS ========= */
function adminRenderAll(){
  runAutoGeneration();
  adminRenderUsers();
  adminRenderVehicles();
  adminRenderObligations();
  adminRenderTallerAll();
  adminRenderKm();
  adminRenderLogs();
}

function adminCreateUser(){
  const u = document.getElementById("nuUser").value.trim();
  const nombre = document.getElementById("nuNombre").value.trim();
  const telefonoRaw = document.getElementById("nuTelefono").value.trim();
  const pass = document.getElementById("nuPass").value.trim() || "1234";
  const role = document.getElementById("nuRole").value;

  const alqInicio = document.getElementById("nuAlqInicio").value;
  const alqMonto = Number(document.getElementById("nuAlqMonto").value || 0);
  const alqEstado = document.getElementById("nuAlqEstado").value;

  if(!u) return;
  if(users[u]) return;
  if(u.toLowerCase()==="admin") return;

  const tel = normalizeWhatsAppPhone(telefonoRaw);
  if(!tel) return;

  users[u] = {
    password: pass,
    role,
    nombre: nombre || u,
    telefono: tel,
    alquiler: { inicio: alqInicio || "", monto: alqMonto || 0, estado: alqEstado || "FINALIZADO" }
  };

  saveAll();

  document.getElementById("nuUser").value="";
  document.getElementById("nuNombre").value="";
  document.getElementById("nuTelefono").value="";
  document.getElementById("nuPass").value="";
  document.getElementById("nuRole").value="USUARIO";
  document.getElementById("nuAlqInicio").value="";
  document.getElementById("nuAlqMonto").value="";
  document.getElementById("nuAlqEstado").value="ACTIVO";

  runAutoGeneration();
  adminRenderUsers();
  adminRenderVehicles();
  adminRenderObligations();
  adminRenderVehicleSelectors();
}

function adminRenderUsers(){
  const tbody = document.getElementById("adminUsersTable");
  tbody.innerHTML = "";

  Object.keys(users).sort().forEach(u=>{
    const isRoot = (u==="admin");
    const alq = users[u].alquiler || {inicio:"",monto:0,estado:"FINALIZADO"};

    tbody.innerHTML += `
      <tr>
        <td data-label="Usuario"><b>${esc(u)}</b></td>
        <td data-label="Nombre"><input id="un_${esc(u)}" value="${esc(users[u].nombre||"")}"></td>
        <td data-label="Rol">
          <select id="ur_${esc(u)}" ${isRoot ? "disabled" : ""}>
            <option value="USUARIO" ${users[u].role==="USUARIO"?"selected":""}>USUARIO</option>
            <option value="ADMIN" ${users[u].role==="ADMIN"?"selected":""}>ADMIN</option>
          </select>
        </td>
        <td data-label="Tel√©fono"><input id="ut_${esc(u)}" value="${esc(users[u].telefono||"")}"></td>
        <td data-label="Clave"><input id="up_${esc(u)}" value="${esc(users[u].password||"")}"></td>

        <td data-label="Alq inicio"><input id="ai_${esc(u)}" type="date" value="${esc(alq.inicio||"")}"></td>
        <td data-label="Alq monto"><input id="am_${esc(u)}" type="number" value="${Number(alq.monto||0)}"></td>
        <td data-label="Alq estado">
          <select id="ae_${esc(u)}">
            <option value="ACTIVO" ${alq.estado==="ACTIVO"?"selected":""}>ACTIVO</option>
            <option value="PAUSADO" ${alq.estado==="PAUSADO"?"selected":""}>PAUSADO</option>
            <option value="FINALIZADO" ${alq.estado==="FINALIZADO"?"selected":""}>FINALIZADO</option>
          </select>
        </td>

        <td data-label="Guardar"><button class="btn-ok" onclick="adminSaveUser('${esc(u)}')">üíæ</button></td>
        <td data-label="Eliminar"><button class="btn-danger" onclick="adminDeleteUser('${esc(u)}')" ${isRoot ? "disabled" : ""}>üóë</button></td>
      </tr>
    `;
  });

  // dropdown asignaci√≥n veh√≠culos: solo USUARIO
  const assign = document.getElementById("vAssign");
  assign.innerHTML = `<option value="">Sin asignar</option>`;
  Object.keys(users).sort().forEach(u=>{
    if(users[u].role==="USUARIO"){
      assign.innerHTML += `<option value="${esc(u)}">${esc(u)}</option>`;
    }
  });
}

function adminSaveUser(u){
  const nombre = document.getElementById(`un_${u}`).value.trim();
  const role = document.getElementById(`ur_${u}`).value;
  const pass = document.getElementById(`up_${u}`).value.trim();
  const telRaw = document.getElementById(`ut_${u}`).value.trim();

  const alqInicio = document.getElementById(`ai_${u}`).value;
  const alqMonto = Number(document.getElementById(`am_${u}`).value || 0);
  const alqEstado = document.getElementById(`ae_${u}`).value;

  if(!pass) return;
  const tel = normalizeWhatsAppPhone(telRaw);

  if(u!=="admin"){
    if(!tel) return;
    users[u].role = role;
  }

  users[u].nombre = nombre || u;
  users[u].password = pass;
  users[u].telefono = tel;

  users[u].alquiler = { inicio: alqInicio || "", monto: alqMonto || 0, estado: alqEstado || "FINALIZADO" };

  saveAll();
  runAutoGeneration();
  adminRenderUsers();
  adminRenderVehicles();
  adminRenderObligations();
}

function adminDeleteUser(u){
  if(u==="admin") return;
  if(!confirm(`Eliminar usuario ${u}?`)) return;

  Object.values(vehicles).forEach(v=>{
    if(v.usuario === u) v.usuario = "";
  });

  delete users[u];
  saveAll();
  adminRenderUsers();
  adminRenderVehicles();
  adminRenderObligations();
}

/* ========= ADMIN VEHICLES ========= */
function adminRenderVehicles(){
  const sel = document.getElementById("vehSelect");
  sel.innerHTML = `<option value="">Nuevo</option>`;
  Object.keys(vehicles).sort().forEach(dom=>{
    sel.innerHTML += `<option value="${esc(dom)}">${esc(dom)}</option>`;
  });

  const tbody = document.getElementById("adminVehTable");
  tbody.innerHTML = "";

  const userOptions = (() => {
    let html = `<option value="">Sin asignar</option>`;
    Object.keys(users).sort().forEach(u=>{
      if(users[u].role==="USUARIO") html += `<option value="${esc(u)}">${esc(u)}</option>`;
    });
    return html;
  })();

  const doms = Object.keys(vehicles).sort();
  if(doms.length===0){
    tbody.innerHTML = `<tr><td colspan="8" data-label="Estado">Sin veh√≠culos</td></tr>`;
    adminRenderVehicleSelectors();
    return;
  }

  doms.forEach(dom=>{
    const v = vehicles[dom];
    ensureVehicleOilFields(v);
    tbody.innerHTML += `
      <tr>
        <td data-label="Dominio"><b>${esc(dom)}</b></td>
        <td data-label="Modelo"><input id="vm_${esc(dom)}" value="${esc(v.modelo||"")}"></td>
        <td data-label="Color"><input id="vc_${esc(dom)}" value="${esc(v.color||"")}"></td>
        <td data-label="Cuota"><input id="vcu_${esc(dom)}" type="number" value="${Number(v.cuotaSemanal||0)}"></td>
        <td data-label="VTV"><input id="vv_${esc(dom)}" type="date" value="${esc(v.vtv||"")}"></td>
        <td data-label="Seguro"><input id="vs_${esc(dom)}" value="${esc(v.seguro||"")}"></td>
        <td data-label="Usuario"><select id="va_${esc(dom)}">${userOptions}</select></td>
        <td data-label="Guardar"><button class="btn-ok" onclick="adminSaveVehicleRow('${esc(dom)}')">üíæ</button></td>
      </tr>
    `;
    document.getElementById(`va_${dom}`).value = v.usuario || "";
  });

  adminRenderVehicleSelectors();
}

function adminRenderVehicleSelectors(){
  const doms = Object.keys(vehicles).sort();

  const obSel = document.getElementById("obDom");
  const tSel = document.getElementById("tDom");
  const oilSel = document.getElementById("oilDom");

  const build = (sel) => {
    sel.innerHTML = "";
    if(doms.length===0){
      sel.innerHTML = `<option value="">Sin veh√≠culos</option>`;
      return;
    }
    doms.forEach(d=> sel.innerHTML += `<option value="${esc(d)}">${esc(d)}</option>`);
  };
  build(obSel); build(tSel); build(oilSel);

  document.getElementById("oilFecha").value = todayISO();
  document.getElementById("tFecha").value = todayISO();
}

function adminLoadVehicleForm(){
  const selected = document.getElementById("vehSelect").value;
  if(!selected){
    document.getElementById("vDom").value="";
    document.getElementById("vModelo").value="";
    document.getElementById("vColor").value="";
    document.getElementById("vCuota").value="";
    document.getElementById("vVtv").value="";
    document.getElementById("vSeguro").value="";
    document.getElementById("vAssign").value="";
    return;
  }
  const v = vehicles[selected];
  ensureVehicleOilFields(v);

  document.getElementById("vDom").value = v.dominio || selected;
  document.getElementById("vModelo").value = v.modelo || "";
  document.getElementById("vColor").value = v.color || "";
  document.getElementById("vCuota").value = Number(v.cuotaSemanal||0);
  document.getElementById("vVtv").value = v.vtv || "";
  document.getElementById("vSeguro").value = v.seguro || "";
  document.getElementById("vAssign").value = v.usuario || "";
}

function adminSaveVehicle(){
  const selected = document.getElementById("vehSelect").value;
  const dom = document.getElementById("vDom").value.trim().toUpperCase();
  if(!dom) return;

  const payload = {
    dominio: dom,
    modelo: document.getElementById("vModelo").value.trim(),
    color: document.getElementById("vColor").value.trim(),
    cuotaSemanal: Number(document.getElementById("vCuota").value || 0),
    vtv: document.getElementById("vVtv").value,
    seguro: document.getElementById("vSeguro").value.trim(),
    usuario: document.getElementById("vAssign").value,
    kmActual: 0,
    kmUpdatedAt: "",
    aceite: { intervaloKm: OIL_INTERVAL_KM, ultimoCambioKm: 0, ultimoCambioFecha: "", ultimoKmRegistrado: 0 }
  };

  const isRename = selected && selected !== dom;
  if(isRename){
    if(vehicles[dom]) return;

    const old = vehicles[selected];
    payload.kmActual = Number(old?.kmActual || 0);
    payload.kmUpdatedAt = old?.kmUpdatedAt || "";
    payload.aceite = old?.aceite || payload.aceite;

    delete vehicles[selected];
    vehicles[dom] = payload;

    obligations.forEach(o=>{ if(o.dominio===selected) o.dominio = dom; });
    kms.forEach(k=>{ if(k.dominio===selected) k.dominio = dom; });
    taller.forEach(t=>{ if(t.dominio===selected) t.dominio = dom; });
    oilHistory.forEach(h=>{ if(h.dominio===selected) h.dominio = dom; });
    oilReminders.forEach(r=>{ if(r.dominio===selected) r.dominio = dom; });

  }else{
    if(vehicles[dom]){
      const old = vehicles[dom];
      payload.kmActual = Number(old?.kmActual || 0);
      payload.kmUpdatedAt = old?.kmUpdatedAt || "";
      payload.aceite = old?.aceite || payload.aceite;
    }
    vehicles[dom] = payload;
  }

  saveAll();
  runAutoGeneration();
  adminRenderVehicles();
  adminRenderObligations();
  adminRenderVehicleSelectors();

  document.getElementById("vehSelect").value = dom;
}

function adminSaveVehicleRow(dom){
  const v = vehicles[dom];
  if(!v) return;

  v.modelo = document.getElementById(`vm_${dom}`).value.trim();
  v.color = document.getElementById(`vc_${dom}`).value.trim();
  v.cuotaSemanal = Number(document.getElementById(`vcu_${dom}`).value || 0);
  v.vtv = document.getElementById(`vv_${dom}`).value;
  v.seguro = document.getElementById(`vs_${dom}`).value.trim();
  v.usuario = document.getElementById(`va_${dom}`).value;

  saveAll();
  runAutoGeneration();
  adminRenderObligations();
}

function adminDeleteVehicle(){
  const selected = document.getElementById("vehSelect").value || document.getElementById("vDom").value.trim().toUpperCase();
  if(!selected) return;
  if(!vehicles[selected]) return;
  if(!confirm(`Eliminar veh√≠culo ${selected}?`)) return;

  delete vehicles[selected];
  saveAll();
  runAutoGeneration();

  adminRenderVehicles();
  adminRenderObligations();
  adminRenderVehicleSelectors();
  adminLoadVehicleForm();
}

/* ========= ADMIN OBLIGATIONS ========= */
function adminAddObligation(){
  const dom = document.getElementById("obDom").value.trim().toUpperCase();
  const concepto = document.getElementById("obConcepto").value.trim();
  const monto = Number(document.getElementById("obMonto").value || 0);
  const vence = document.getElementById("obVence").value;

  if(!dom || !vehicles[dom]) return;
  if(!concepto) return;
  if(!monto || monto<=0) return;
  if(!vence) return;

  obligations.push({
    id: uid(),
    tipo: "MANUAL",
    subtipo: "MANUAL",
    dominio: dom,
    concepto,
    monto,
    vencimiento: vence,
    estado: "PENDIENTE",
    medioPago: "",
    fechaPago: "",
    motivoRechazo: "",
    autoKey: "",
    parentId: null
  });

  saveAll();
  document.getElementById("obConcepto").value="";
  document.getElementById("obMonto").value="";
  document.getElementById("obVence").value="";

  adminRenderObligations();
}

function obligationMatchesFilters(o){
  const domF = document.getElementById("fDom").value.trim().toUpperCase();
  const userF = document.getElementById("fUser").value.trim();
  const vencF = document.getElementById("fVencidas").value;

  if(domF && !o.dominio.toUpperCase().includes(domF)) return false;

  if(userF){
    const owner = vehicleOwnerUsername(o.dominio);
    if(!owner.toLowerCase().includes(userF.toLowerCase())) return false;
  }

  if(vencF === "vencidas"){
    const hoy = parseISO(todayISO());
    const venc = parseISO(o.vencimiento);
    if(!(venc && venc < hoy)) return false;
  }

  return true;
}

function adminRenderObligations(){
  runAutoGeneration();

  const pend = document.getElementById("adminObPendientes");
  const apr  = document.getElementById("adminObAprobadas");
  const rej  = document.getElementById("adminObRechazadas");
  const pun  = document.getElementById("adminObPunitorios");
  pend.innerHTML = ""; apr.innerHTML = ""; rej.innerHTML = ""; pun.innerHTML = "";

  const filtered = obligations.filter(obligationMatchesFilters);

  // Orden por vencimiento
  filtered.sort((a,b)=> new Date(a.vencimiento) - new Date(b.vencimiento));

  filtered.forEach(o=>{
    const owner = vehicleOwnerUsername(o.dominio) || "-";

    if(o.subtipo==="PUNITORIO"){
      pun.innerHTML += `
        <tr>
          <td data-label="Dominio"><b>${esc(o.dominio)}</b></td>
          <td data-label="Usuario">${esc(owner)}</td>
          <td data-label="Concepto">${esc(o.concepto)}</td>
          <td data-label="Monto">$${Number(o.monto||0)}</td>
          <td data-label="Vence">${esc(o.vencimiento)}</td>
          <td data-label="Estado">${obBadge(o.estado)}</td>
          <td data-label="Padre">${o.parentId ?? "-"}</td>
          <td data-label="Quita"><button class="btn-warn" onclick="adminApplyQuita(${o.id})">Quita</button></td>
          <td data-label="Editar"><button class="btn-secondary" onclick="adminEditPunitorio(${o.id})">Editar</button></td>
          <td data-label="Eliminar"><button class="btn-danger" onclick="adminDeleteObligation(${o.id})">Eliminar</button></td>
        </tr>
      `;
      return;
    }

    const base = `
      <td data-label="Dominio"><b>${esc(o.dominio)}</b></td>
      <td data-label="Usuario">${esc(owner)}</td>
      <td data-label="Concepto">${esc(o.concepto)}</td>
      <td data-label="Monto">$${Number(o.monto||0)}</td>
      <td data-label="Vence">${esc(o.vencimiento)}</td>
      <td data-label="Estado">${obBadge(o.estado)}</td>
      <td data-label="Medio">${esc(o.medioPago||"-")}</td>
      <td data-label="Fecha">${esc(o.fechaPago||"-")}</td>
    `;

    if(o.estado==="PENDIENTE" || o.estado==="INFORMADO"){
      const can = (o.estado==="INFORMADO");
      pend.innerHTML += `
        <tr>
          ${base}
          <td data-label="Aprobar"><button class="btn-ok" ${can?"":"disabled"} onclick="adminApprove(${o.id})">‚úÖ</button></td>
          <td data-label="Rechazar"><button class="btn-warn" ${can?"":"disabled"} onclick="adminReject(${o.id})">‚ùå</button></td>
        </tr>
      `;
    }else if(o.estado==="PAGADA"){
      apr.innerHTML += `<tr>${base}</tr>`;
    }else if(o.estado==="RECHAZADA"){
      rej.innerHTML += `<tr>${base}<td data-label="Motivo">${esc(o.motivoRechazo||"-")}</td></tr>`;
    }else if(o.estado==="QUITADA"){
      // queda como "aprobadas" a efectos pr√°cticos
      apr.innerHTML += `<tr>${base}</tr>`;
    }
  });

  if(!pend.innerHTML) pend.innerHTML = `<tr><td colspan="10" data-label="Estado">‚Äî</td></tr>`;
  if(!apr.innerHTML)  apr.innerHTML  = `<tr><td colspan="8" data-label="Estado">‚Äî</td></tr>`;
  if(!rej.innerHTML)  rej.innerHTML  = `<tr><td colspan="9" data-label="Estado">‚Äî</td></tr>`;
  if(!pun.innerHTML)  pun.innerHTML  = `<tr><td colspan="10" data-label="Estado">‚Äî</td></tr>`;
}

function adminApprove(id){
  const ob = obligations.find(o=>o.id===id);
  if(!ob) return;
  if(ob.estado !== "INFORMADO") return;

  ob.estado = "PAGADA";
  saveAll();
  adminRenderObligations();
}

function adminReject(id){
  const ob = obligations.find(o=>o.id===id);
  if(!ob) return;
  if(ob.estado !== "INFORMADO") return;

  const motivo = prompt("Motivo rechazo:");
  if(motivo===null) return;
  const m = motivo.trim();
  if(!m) return;

  ob.estado = "RECHAZADA";
  ob.motivoRechazo = m;
  saveAll();
  adminRenderObligations();
}

function adminApplyQuita(id){
  const ob = obligations.find(o=>o.id===id);
  if(!ob) return;
  if(ob.subtipo !== "PUNITORIO") return;

  const tipo = prompt("Quita: TOTAL o PARCIAL (T/P):");
  if(tipo===null) return;
  const t = tipo.trim().toUpperCase();

  if(t==="T"){
    ob.estado = "QUITADA";
    ob.monto = 0;
    ob.medioPago = "QUITA";
    ob.fechaPago = nowStr();
    saveAll();
    adminRenderObligations();
    return;
  }

  if(t==="P"){
    const nuevo = prompt("Nuevo monto:");
    if(nuevo===null) return;
    const nm = Number(nuevo||0);
    if(!(nm>=0)) return;
    ob.monto = nm;
    if(nm===0){
      ob.estado = "QUITADA";
      ob.medioPago = "QUITA";
      ob.fechaPago = nowStr();
    }
    saveAll();
    adminRenderObligations();
    return;
  }
}

function adminEditPunitorio(id){
  const ob = obligations.find(o=>o.id===id);
  if(!ob) return;
  if(ob.subtipo !== "PUNITORIO") return;

  const nmStr = prompt("Monto punitorio:", String(ob.monto||0));
  if(nmStr===null) return;
  const nm = Number(nmStr||0);
  if(!(nm>=0)) return;

  ob.monto = nm;
  if(nm===0){
    ob.estado = "QUITADA";
    ob.medioPago = "QUITA";
    ob.fechaPago = nowStr();
  }
  saveAll();
  adminRenderObligations();
}

function adminDeleteObligation(id){
  if(!confirm("Eliminar obligaci√≥n?")) return;
  obligations = obligations.filter(o=>o.id!==id);
  saveAll();
  adminRenderObligations();
}

/* ========= ADMIN TALLER + ACEITE + WHATSAPP ========= */
function adminRenderTallerAll(){
  adminRenderVehicleSelectors();
  const dom = document.getElementById("oilDom").value;
  if(dom && vehicles[dom]){
    document.getElementById("oilKm").value = Number(vehicles[dom].kmActual||0) || "";
  }
  adminRenderTaller();
  adminRenderOilHistory();
  adminRenderOilReminders();
}

document.addEventListener("change", (e)=>{
  if(e.target && e.target.id === "oilDom"){
    const dom = document.getElementById("oilDom").value;
    if(dom && vehicles[dom]){
      document.getElementById("oilKm").value = Number(vehicles[dom].kmActual||0) || "";
    }else{
      document.getElementById("oilKm").value = "";
    }
  }
});

function adminAddTaller(){
  const dom = document.getElementById("tDom").value.trim().toUpperCase();
  const fecha = document.getElementById("tFecha").value || todayISO();
  const km = Number(document.getElementById("tKm").value || 0);
  const tipo = document.getElementById("tTipo").value.trim();
  const costo = Number(document.getElementById("tCosto").value || 0);
  const tallerName = document.getElementById("tTaller").value.trim();
  const desc = document.getElementById("tDesc").value.trim();

  if(!dom || !vehicles[dom]) return;
  if(!tipo) return;

  taller.unshift({
    id: uid(),
    dominio: dom,
    fecha,
    km: km || (Number(vehicles[dom].kmActual||0) || 0),
    tipo,
    costo,
    taller: tallerName,
    desc,
    creadoPor: currentUser
  });

  saveAll();
  document.getElementById("tKm").value="";
  document.getElementById("tTipo").value="";
  document.getElementById("tCosto").value="";
  document.getElementById("tTaller").value="";
  document.getElementById("tDesc").value="";
  adminRenderTaller();
}

function adminRenderTaller(){
  const tbody = document.getElementById("tallerTable");
  tbody.innerHTML = "";

  if(taller.length===0){
    tbody.innerHTML = `<tr><td colspan="8" data-label="Estado">‚Äî</td></tr>`;
    return;
  }
  taller.slice(0,400).forEach(t=>{
    tbody.innerHTML += `
      <tr>
        <td data-label="Dominio"><b>${esc(t.dominio)}</b></td>
        <td data-label="Fecha">${esc(t.fecha)}</td>
        <td data-label="KM">${Number(t.km||0)}</td>
        <td data-label="Tipo">${esc(t.tipo)}</td>
        <td data-label="Costo">$${Number(t.costo||0)}</td>
        <td data-label="Taller">${esc(t.taller||"-")}</td>
        <td data-label="Descripci√≥n">${esc(t.desc||"-")}</td>
        <td data-label="Por">${esc(t.creadoPor||"-")}</td>
      </tr>
    `;
  });
}

function adminValidateOilChange(){
  const dom = document.getElementById("oilDom").value.trim().toUpperCase();
  const fecha = document.getElementById("oilFecha").value || todayISO();
  const km = Number(document.getElementById("oilKm").value || 0);
  const obs = document.getElementById("oilObs").value.trim();

  if(!dom || !vehicles[dom]) return;
  const v = vehicles[dom];
  ensureVehicleOilFields(v);

  const kmActual = Number(v.kmActual||0);
  if(!km || km<=0) return;
  if(km < kmActual) return;
  if(km < Number(v.aceite.ultimoCambioKm||0)) return;

  oilHistory.unshift({ id: uid(), dominio: dom, fecha, km, obs, validadoPor: currentUser });

  v.kmActual = Math.max(kmActual, km);
  v.kmUpdatedAt = nowStr();
  v.aceite.intervaloKm = OIL_INTERVAL_KM;
  v.aceite.ultimoCambioKm = km;
  v.aceite.ultimoCambioFecha = fecha;
  v.aceite.ultimoKmRegistrado = v.kmActual;

  taller.unshift({
    id: uid(),
    dominio: dom,
    fecha,
    km,
    tipo: "CAMBIO_ACEITE",
    costo: 0,
    taller: "",
    desc: obs ? `Cambio de aceite: ${obs}` : "Cambio de aceite",
    creadoPor: currentUser
  });

  saveAll();
  document.getElementById("oilObs").value = "";
  adminRenderTallerAll();
}

function adminSendOilReminderWhatsApp(){
  const dom = document.getElementById("oilDom").value.trim().toUpperCase();
  if(!dom || !vehicles[dom]) return;

  const v = vehicles[dom];
  const owner = v.usuario || "";
  if(!owner) return;

  const tel = normalizeWhatsAppPhone(users[owner]?.telefono || "");
  if(!tel) return;

  const oil = computeOilStatusForVehicle(v);
  const nombre = users[owner]?.nombre || owner;
  const estadoTxt = (oil.estado==="OK") ? "OK" : (oil.estado==="PROXIMO" ? "PR√ìXIMO" : "VENCIDO");

  const msg =
`Hola ${nombre},
veh√≠culo ${v.dominio} - cambio de aceite ${estadoTxt}.
Restan ${oil.restantes} km.`;

  const url = `https://wa.me/${encodeURIComponent(tel)}?text=${encodeURIComponent(msg)}`;
  window.open(url, "_blank", "noopener,noreferrer");

  oilReminders.unshift({
    id: uid(),
    dominio: dom,
    user: owner,
    telefono: tel,
    estadoAceite: oil.estado,
    kmRestantes: oil.restantes,
    fecha: nowStr()
  });

  saveAll();
  adminRenderOilReminders();
}

function adminRenderOilHistory(){
  const tbody = document.getElementById("oilHistoryTable");
  tbody.innerHTML = "";

  if(oilHistory.length===0){
    tbody.innerHTML = `<tr><td colspan="5" data-label="Estado">‚Äî</td></tr>`;
    return;
  }
  oilHistory.slice(0,400).forEach(h=>{
    tbody.innerHTML += `
      <tr>
        <td data-label="Dominio"><b>${esc(h.dominio)}</b></td>
        <td data-label="Fecha">${esc(h.fecha)}</td>
        <td data-label="KM">${Number(h.km||0)}</td>
        <td data-label="Obs.">${esc(h.obs||"-")}</td>
        <td data-label="Por">${esc(h.validadoPor||"-")}</td>
      </tr>
    `;
  });
}

function adminRenderOilReminders(){
  const tbody = document.getElementById("oilReminderTable");
  tbody.innerHTML = "";

  if(oilReminders.length===0){
    tbody.innerHTML = `<tr><td colspan="6" data-label="Estado">‚Äî</td></tr>`;
    return;
  }
  oilReminders.slice(0,500).forEach(r=>{
    const estadoTxt = (r.estadoAceite==="OK") ? "OK" : (r.estadoAceite==="PROXIMO" ? "PR√ìXIMO" : "VENCIDO");
    tbody.innerHTML += `
      <tr>
        <td data-label="Dominio"><b>${esc(r.dominio)}</b></td>
        <td data-label="Usuario">${esc(r.user)}</td>
        <td data-label="Tel√©fono">${esc(r.telefono)}</td>
        <td data-label="Estado">${esc(estadoTxt)}</td>
        <td data-label="Restan">${Number(r.kmRestantes||0)}</td>
        <td data-label="Fecha">${esc(r.fecha)}</td>
      </tr>
    `;
  });
}

/* ========= ADMIN KM + LOGS ========= */
function adminRenderKm(){
  const tbody = document.getElementById("adminKmTable");
  tbody.innerHTML = "";

  if(kms.length===0){
    tbody.innerHTML = `<tr><td colspan="4" data-label="Estado">‚Äî</td></tr>`;
    return;
  }
  kms.slice(0,600).forEach(k=>{
    tbody.innerHTML += `
      <tr>
        <td data-label="Dominio"><b>${esc(k.dominio)}</b></td>
        <td data-label="KM">${Number(k.km||0)}</td>
        <td data-label="Fecha">${esc(k.fecha)}</td>
        <td data-label="Usuario">${esc(k.user||"-")}</td>
      </tr>
    `;
  });
}

function adminRenderLogs(){
  const tbody = document.getElementById("logTable");
  tbody.innerHTML = "";

  if(logs.length===0){
    tbody.innerHTML = `<tr><td colspan="2" data-label="Estado">‚Äî</td></tr>`;
    return;
  }
  logs.slice(0,700).forEach(l=>{
    tbody.innerHTML += `
      <tr>
        <td data-label="Usuario">${esc(l.user)}</td>
        <td data-label="Fecha">${esc(l.date)}</td>
      </tr>
    `;
  });
}

/* ========= EXPORT ========= */
function exportAdminTable(type){
  const { table, filename, title } = buildExportTable(type);
  if(!table) return;

  const wb = XLSX.utils.table_to_book(table, { sheet: "Datos" });
  XLSX.writeFile(wb, `${filename}.xlsx`);

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("l", "pt", "a4");
  doc.text(title, 40, 30);
  doc.autoTable({ html: table, startY: 50, styles: { fontSize: 8 } });
  doc.save(`${filename}.pdf`);

  table.remove();
}

function buildExportTable(type){
  const tmp = document.createElement("table");
  tmp.style.position = "fixed";
  tmp.style.left = "-99999px";
  tmp.style.top = "-99999px";

  let filename="export";
  let title="Export";

  const thead = document.createElement("thead");
  const tbody = document.createElement("tbody");
  tmp.appendChild(thead);
  tmp.appendChild(tbody);

  if(type==="users"){
    filename="usuarios"; title="Usuarios";
    thead.innerHTML = `<tr><th>Usuario</th><th>Nombre</th><th>Rol</th><th>Tel√©fono</th><th>Inicio</th><th>Monto</th><th>Estado</th></tr>`;
    Object.keys(users).sort().forEach(u=>{
      const alq = users[u].alquiler || {};
      tbody.innerHTML += `<tr><td>${esc(u)}</td><td>${esc(users[u].nombre||"")}</td><td>${esc(users[u].role||"")}</td><td>${esc(users[u].telefono||"")}</td><td>${esc(alq.inicio||"")}</td><td>${Number(alq.monto||0)}</td><td>${esc(alq.estado||"")}</td></tr>`;
    });
  }

  if(type==="vehicles"){
    filename="vehiculos"; title="Veh√≠culos";
    thead.innerHTML = `<tr><th>Dominio</th><th>Modelo</th><th>Color</th><th>Cuota</th><th>VTV</th><th>Seguro</th><th>Usuario</th><th>KM</th></tr>`;
    Object.keys(vehicles).sort().forEach(d=>{
      const v = vehicles[d];
      tbody.innerHTML += `<tr><td>${esc(v.dominio||d)}</td><td>${esc(v.modelo||"")}</td><td>${esc(v.color||"")}</td><td>${Number(v.cuotaSemanal||0)}</td><td>${esc(v.vtv||"")}</td><td>${esc(v.seguro||"")}</td><td>${esc(v.usuario||"")}</td><td>${Number(v.kmActual||0)}</td></tr>`;
    });
  }

  if(type==="obligations"){
    filename="obligaciones"; title="Obligaciones";
    thead.innerHTML = `<tr><th>Dominio</th><th>Usuario</th><th>Tipo</th><th>Subtipo</th><th>Concepto</th><th>Monto</th><th>Vence</th><th>Estado</th><th>Padre</th></tr>`;
    obligations.filter(obligationMatchesFilters).forEach(o=>{
      const owner = vehicleOwnerUsername(o.dominio) || "";
      tbody.innerHTML += `<tr><td>${esc(o.dominio)}</td><td>${esc(owner)}</td><td>${esc(o.tipo||"")}</td><td>${esc(o.subtipo||"")}</td><td>${esc(o.concepto)}</td><td>${Number(o.monto||0)}</td><td>${esc(o.vencimiento)}</td><td>${esc(o.estado)}</td><td>${o.parentId ?? ""}</td></tr>`;
    });
  }

  if(type==="km"){
    filename="kilometrajes"; title="KM";
    thead.innerHTML = `<tr><th>Dominio</th><th>KM</th><th>Fecha</th><th>Usuario</th></tr>`;
    kms.forEach(k=>{
      tbody.innerHTML += `<tr><td>${esc(k.dominio)}</td><td>${Number(k.km||0)}</td><td>${esc(k.fecha)}</td><td>${esc(k.user||"")}</td></tr>`;
    });
  }

  if(type==="logs"){
    filename="logs"; title="Logs";
    thead.innerHTML = `<tr><th>Usuario</th><th>Fecha</th></tr>`;
    logs.forEach(l=>{
      tbody.innerHTML += `<tr><td>${esc(l.user)}</td><td>${esc(l.date)}</td></tr>`;
    });
  }

  if(type==="taller"){
    filename="taller"; title="Taller";
    thead.innerHTML = `<tr><th>Dominio</th><th>Fecha</th><th>KM</th><th>Tipo</th><th>Costo</th><th>Taller</th><th>Descripci√≥n</th><th>Por</th></tr>`;
    taller.forEach(t=>{
      tbody.innerHTML += `<tr><td>${esc(t.dominio)}</td><td>${esc(t.fecha)}</td><td>${Number(t.km||0)}</td><td>${esc(t.tipo)}</td><td>${Number(t.costo||0)}</td><td>${esc(t.taller||"")}</td><td>${esc(t.desc||"")}</td><td>${esc(t.creadoPor||"")}</td></tr>`;
    });
  }

  if(type==="oilReminders"){
    filename="whatsapp_aceite"; title="WhatsApp aceite";
    thead.innerHTML = `<tr><th>Dominio</th><th>Usuario</th><th>Tel√©fono</th><th>Estado</th><th>Restan</th><th>Fecha</th></tr>`;
    oilReminders.forEach(r=>{
      tbody.innerHTML += `<tr><td>${esc(r.dominio)}</td><td>${esc(r.user)}</td><td>${esc(r.telefono)}</td><td>${esc(r.estadoAceite)}</td><td>${Number(r.kmRestantes||0)}</td><td>${esc(r.fecha)}</td></tr>`;
    });
  }

  if(type==="oilStatus"){
    filename="estado_aceite"; title="Estado aceite";
    thead.innerHTML = `<tr><th>Dominio</th><th>Usuario</th><th>KM</th><th>Ult cambio</th><th>Desde</th><th>Restan</th><th>Estado</th></tr>`;
    Object.keys(vehicles).sort().forEach(d=>{
      const v = vehicles[d];
      const oil = computeOilStatusForVehicle(v);
      tbody.innerHTML += `<tr><td>${esc(v.dominio||d)}</td><td>${esc(v.usuario||"")}</td><td>${oil.kmActual}</td><td>${oil.lastChange}</td><td>${oil.kmDesde}</td><td>${oil.restantes}</td><td>${esc(oil.estado)}</td></tr>`;
    });
  }

  if(tbody.children.length===0){
    tmp.remove();
    return { table:null, filename, title };
  }
  document.body.appendChild(tmp);
  return { table: tmp, filename, title };
}

/* ========= RESET ========= */
function adminResetAll(){
  if(!confirm("Reset total?")) return;
  Object.values(KEYS).forEach(k => localStorage.removeItem(k));
  location.reload();
}

/* ========= INIT ========= */
(function init(){
  applyLogo();
  Object.values(vehicles).forEach(v=>ensureVehicleOilFields(v));

  // asegurar estructura alquiler en usuarios existentes
  Object.keys(users).forEach(u=>{
    if(!users[u].alquiler){
      users[u].alquiler = { inicio:"", monto:0, estado:"FINALIZADO" };
    }
  });

  saveAll();
})();
</script>
</body>
</html>