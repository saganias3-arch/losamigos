<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Control Vehicular</title>

  <style>
    :root{
      --bg:#e9ecef; --card:#fff; --text:#111; --muted:#666; --line:#ddd;
      --primary:#007bff; --primary2:#0056b3;
      --ok:#198754; --ok2:#146c43;
      --danger:#dc3545; --danger2:#b02a37;
      --warn:#ffc107; --warn2:#e0a800;
      --secondary:#6c757d; --secondary2:#565e64;
    }
    body{font-family:Arial, sans-serif;background:var(--bg);margin:0;min-height:100vh;display:flex;justify-content:center;align-items:center}
    .box{background:var(--card);padding:18px;width:1180px;max-width:98vw;border-radius:12px;box-shadow:0 0 12px rgba(0,0,0,.18)}
    .hidden{display:none}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;background:#f7f7f7}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:260px}
    h3,h4{margin:8px 0}
    .section{margin-top:10px}

    input,select,textarea{
      width:100%;padding:8px;margin:4px 0;border:1px solid #ccc;border-radius:10px;box-sizing:border-box
    }
    textarea{min-height:74px;resize:vertical}

    button{
      padding:8px 10px;border:0;border-radius:10px;background:var(--primary);color:#fff;cursor:pointer
    }
    button:hover{background:var(--primary2)}
    button:disabled{opacity:.45;cursor:not-allowed}

    .btn-ok{background:var(--ok)}
    .btn-ok:hover{background:var(--ok2)}
    .btn-danger{background:var(--danger)}
    .btn-danger:hover{background:var(--danger2)}
    .btn-warn{background:var(--warn);color:#111}
    .btn-warn:hover{background:var(--warn2)}
    .btn-secondary{background:var(--secondary)}
    .btn-secondary:hover{background:var(--secondary2)}

    table{width:100%;border-collapse:collapse;font-size:12px;margin-top:8px}
    td,th{border:1px solid var(--line);padding:6px;text-align:center;vertical-align:middle}
    th{background:#f7f7f7}

    .ok{color:var(--ok);font-weight:700}
    .bad{color:var(--danger);font-weight:700}
    .admin{color:var(--ok);font-weight:700}

    .menu{display:flex;gap:8px;margin:10px 0;border-bottom:1px solid var(--line);padding-bottom:10px;flex-wrap:wrap}
    .menu button{background:#f8f9fa;border:1px solid var(--line);color:#111}
    .menu button:hover{background:#e9ecef}
    /* Men√∫ USUARIO: letra negra como pediste */
    .menu.user button{color:#000 !important;font-weight:800}

    .cardline{border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:10px;background:#fafafa}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;background:#fff}
    .chip.ok{color:var(--ok)}
    .chip.warn{color:#8a6d00}
    .chip.bad{color:var(--danger)}
    .banner{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fffbe6}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:860px){.grid2{grid-template-columns:1fr}}
  </style>

  <!-- Export libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>

<body>

<!-- LOGIN -->
<div class="box" id="loginBox">
  <h3>Iniciar sesi√≥n</h3>
  <input id="loginUser" placeholder="Usuario" autocomplete="username" />
  <input id="loginPass" type="password" placeholder="Contrase√±a" autocomplete="current-password" />
  <button onclick="login()" style="width:100%">Ingresar</button>
  <div id="loginMsg" class="muted" style="margin-top:8px"></div>
  <div class="muted" style="margin-top:6px">Admin: <b>admin</b> / clave: <b>1234</b></div>
</div>

<!-- APP -->
<div class="box hidden" id="panel">
  <div class="topbar">
    <div>
      <div id="panelTitle"><b>Panel</b></div>
      <div id="panelSubtitle" class="muted"></div>
    </div>
    <div class="right">
      <span id="rolePill" class="pill"></span>
      <button class="btn-danger" onclick="logout()">Cerrar sesi√≥n</button>
    </div>
  </div>

  <!-- USER PANEL -->
  <div id="userPanel" class="hidden">
    <div class="menu user">
      <button onclick="showUserTab('uPagos')">PAGOS</button>
      <button onclick="showUserTab('uKm')">CARGA DE KM</button>
      <button onclick="showUserTab('uDocs')">DOCUMENTACI√ìN</button>
    </div>

    <div class="cardline" id="userHomeCard">
      <h3 id="userHello"></h3>
      <div class="row">
        <div class="col">
          <div><b>Estado de cuenta:</b> <span id="userEstado"></span></div>
          <div class="muted" style="margin-top:4px">
            Regla: si ten√©s alguna obligaci√≥n <b>vencida</b> en <b>PENDIENTE</b> o <b>RECHAZADA</b> ‚áí <b>DEUDA</b>. Si no ‚áí <b>AL D√çA</b>.
          </div>
        </div>
        <div class="col" id="userSingleVehicleSummary"></div>
      </div>
    </div>

    <!-- PAGOS -->
    <div id="uPagos" class="section">
      <h4>Mis veh√≠culos</h4>
      <table>
        <thead><tr><th>Dominio</th><th>Modelo</th><th>Color</th><th>Cuota semanal</th><th>VTV</th><th>Seguro</th><th>Aceite</th></tr></thead>
        <tbody id="userVehTable"></tbody>
      </table>

      <h4 style="margin-top:12px">Mis obligaciones</h4>
      <table>
        <thead>
          <tr>
            <th>Dominio</th><th>Concepto</th><th>Monto</th><th>Vence</th>
            <th>Estado</th><th>Medio</th><th>Fecha</th><th>Observaci√≥n</th><th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="userObTable"></tbody>
      </table>
      <div class="muted" style="margin-top:8px">
        *Pod√©s informar pago solo si est√° <b>PENDIENTE</b> o <b>RECHAZADA</b>. Si queda <b>INFORMADO</b>, el admin debe aprobar o rechazar. Si est√° <b>PAGADA</b>, no se puede repetir.
      </div>
    </div>

    <!-- KM -->
    <div id="uKm" class="section hidden">
      <h4>Cargar KM (KM real actual)</h4>
      <div class="row">
        <div class="col">
          <select id="kmDomSelect"></select>
          <input id="kmValue" type="number" placeholder="Kilometraje actual (ej: 10400)" />
        </div>
        <div class="col">
          <button onclick="userSaveKm()" style="width:100%">Guardar KM</button>
          <div class="muted" style="margin-top:6px">
            *El KM no puede bajar. Se usa para calcular cambio de aceite cada <b>1200 km</b>.
          </div>
        </div>
      </div>

      <h4 style="margin-top:12px">Estado de aceite (por veh√≠culo)</h4>
      <div id="userOilCards" class="grid2"></div>

      <h4 style="margin-top:12px">Historial de KM</h4>
      <table>
        <thead><tr><th>Dominio</th><th>KM</th><th>Fecha</th></tr></thead>
        <tbody id="userKmTable"></tbody>
      </table>
    </div>

    <!-- DOCS -->
    <div id="uDocs" class="section hidden">
      <h4>Documentaci√≥n</h4>
      <div class="muted">Secci√≥n lista para agregar enlaces/documentos (contrato/seguro/etc.).</div>
      <div class="cardline" style="margin-top:10px">
        <h4>Datos de mis veh√≠culos</h4>
        <div id="userDocsCards" class="grid2"></div>
      </div>
    </div>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="hidden">
    <h3 class="admin">Panel Administrador</h3>

    <div class="menu">
      <button onclick="showAdminTab('aUsers')">üë§ Usuarios</button>
      <button onclick="showAdminTab('aVeh')">üöó Veh√≠culos</button>
      <button onclick="showAdminTab('aOb')">üìÑ Obligaciones</button>
      <button onclick="showAdminTab('aTaller')">üõ† Taller</button>
      <button onclick="showAdminTab('aKm')">üìä KM</button>
      <button onclick="showAdminTab('aLogs')">üßæ Logs</button>
    </div>

    <!-- USERS -->
    <div id="aUsers" class="section">
      <div class="row">
        <div class="col">
          <h4>‚ûï Alta de usuario</h4>
          <input id="nuUser" placeholder="Usuario" />
          <input id="nuNombre" placeholder="Nombre visible" />
        </div>
        <div class="col">
          <h4>&nbsp;</h4>
          <input id="nuTelefono" placeholder="Tel√©fono WhatsApp (obligatorio) ej: 54911XXXXXXXX" />
          <input id="nuPass" placeholder="Contrase√±a (default 1234)" />
          <select id="nuRole">
            <option value="USUARIO">USUARIO</option>
            <option value="ADMIN">ADMIN</option>
          </select>
          <button class="btn-ok" onclick="adminCreateUser()" style="width:100%">Crear usuario</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <button class="btn-secondary" onclick="exportAdminTable('users')" style="width:100%">üìä Excel / üßæ PDF Usuarios</button>
        </div>
        <div class="col">
          <button class="btn-danger" onclick="adminResetAll()" style="width:100%">‚ö† Reset total (si ven√≠as con datos rotos)</button>
        </div>
      </div>

      <h4 style="margin-top:12px">Listado y edici√≥n</h4>
      <table>
        <thead>
          <tr>
            <th>Usuario</th><th>Nombre</th><th>Rol</th><th>Tel√©fono</th><th>Contrase√±a</th><th>Guardar</th><th>Eliminar</th>
          </tr>
        </thead>
        <tbody id="adminUsersTable"></tbody>
      </table>
      <div class="muted" style="margin-top:8px">
        *Tel√©fono es obligatorio (para recordatorios WhatsApp). Guardalo como <b>54911XXXXXXXX</b> (recomendado).
      </div>
    </div>

    <!-- VEHICLES -->
    <div id="aVeh" class="section hidden">
      <div class="row">
        <div class="col">
          <h4>‚ûï / ‚úè Veh√≠culo</h4>
          <select id="vehSelect" onchange="adminLoadVehicleForm()">
            <option value="">-- Nuevo veh√≠culo --</option>
          </select>
          <input id="vDom" placeholder="Dominio (√∫nico)" />
          <input id="vModelo" placeholder="Modelo" />
          <input id="vColor" placeholder="Color" />
        </div>
        <div class="col">
          <h4>&nbsp;</h4>
          <input id="vCuota" type="number" placeholder="Cuota semanal (monto)" />
          <input id="vVtv" type="date" />
          <input id="vSeguro" placeholder="Seguro (texto/link)" />
          <select id="vAssign"></select>
          <div class="row">
            <div class="col"><button class="btn-ok" onclick="adminSaveVehicle()" style="width:100%">Guardar</button></div>
            <div class="col"><button class="btn-danger" onclick="adminDeleteVehicle()" style="width:100%">Eliminar</button></div>
          </div>
        </div>
      </div>

      <button class="btn-secondary" onclick="exportAdminTable('vehicles')" style="width:100%;margin-top:10px">üìä Excel / üßæ PDF Veh√≠culos</button>

      <h4 style="margin-top:12px">Listado editable (reasignaci√≥n r√°pida)</h4>
      <table>
        <thead>
          <tr><th>Dominio</th><th>Modelo</th><th>Color</th><th>Cuota</th><th>VTV</th><th>Seguro</th><th>Asignado a</th><th>Guardar</th></tr>
        </thead>
        <tbody id="adminVehTable"></tbody>
      </table>
    </div>

    <!-- OBLIGATIONS -->
    <div id="aOb" class="section hidden">
      <h3>Gesti√≥n de Obligaciones</h3>

      <div class="banner" id="obSummaryBanner"></div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <input id="fDom" placeholder="Filtrar por dominio" />
        </div>
        <div class="col">
          <input id="fUser" placeholder="Filtrar por usuario (asignado)" />
        </div>
        <div class="col">
          <select id="fVencidas">
            <option value="">Todas</option>
            <option value="vencidas">Solo vencidas</option>
          </select>
        </div>
        <div class="col">
          <button onclick="adminRenderObligations()" style="width:100%">Aplicar filtros</button>
        </div>
      </div>

      <div class="menu" style="margin-top:10px">
        <button onclick="showObTab('pendientes')">‚è≥ Pendientes</button>
        <button onclick="showObTab('aprobadas')">‚úÖ Aprobadas</button>
        <button onclick="showObTab('rechazadas')">‚ùå Rechazadas</button>
        <button class="btn-secondary" onclick="exportAdminTable('obligations')" style="margin-left:auto">üìä Excel / üßæ PDF</button>
      </div>

      <div class="cardline">
        <h4>‚ûï Crear obligaci√≥n</h4>
        <div class="row">
          <div class="col">
            <select id="obDom"></select>
            <input id="obConcepto" placeholder="Concepto / especificaci√≥n" />
          </div>
          <div class="col">
            <input id="obMonto" type="number" placeholder="Monto" />
            <input id="obVence" type="date" />
            <button class="btn-ok" onclick="adminAddObligation()" style="width:100%">Crear obligaci√≥n</button>
          </div>
        </div>
        <div class="muted">
          *El usuario informa pago una sola vez; si se rechaza puede re-informar. Si se aprueba pasa a Aprobadas.
        </div>
      </div>

      <!-- PENDIENTES -->
      <div id="ob_pendientes" class="section">
        <h4>Obligaciones Pendientes (PENDIENTE / INFORMADO)</h4>
        <table>
          <thead>
            <tr>
              <th>Dominio</th><th>Usuario</th><th>Concepto</th><th>Monto</th><th>Vence</th><th>Estado</th>
              <th>Medio</th><th>Fecha</th><th>Aprobar</th><th>Rechazar</th>
            </tr>
          </thead>
          <tbody id="adminObPendientes"></tbody>
        </table>
      </div>

      <!-- APROBADAS -->
      <div id="ob_aprobadas" class="section hidden">
        <h4>Obligaciones Aprobadas (PAGADA)</h4>
        <table>
          <thead>
            <tr>
              <th>Dominio</th><th>Usuario</th><th>Concepto</th><th>Monto</th><th>Vence</th><th>Estado</th><th>Medio</th><th>Fecha</th>
            </tr>
          </thead>
          <tbody id="adminObAprobadas"></tbody>
        </table>
      </div>

      <!-- RECHAZADAS -->
      <div id="ob_rechazadas" class="section hidden">
        <h4>Obligaciones Rechazadas (RECHAZADA)</h4>
        <table>
          <thead>
            <tr>
              <th>Dominio</th><th>Usuario</th><th>Concepto</th><th>Monto</th><th>Vence</th><th>Estado</th><th>Medio</th><th>Fecha</th><th>Motivo</th>
            </tr>
          </thead>
          <tbody id="adminObRechazadas"></tbody>
        </table>
      </div>
    </div>

    <!-- TALLER -->
    <div id="aTaller" class="section hidden">
      <h3>üõ† Taller / Mantenimiento</h3>

      <div class="cardline">
        <h4>Registrar trabajo</h4>
        <div class="row">
          <div class="col">
            <select id="tDom"></select>
            <input id="tFecha" type="date" />
            <input id="tKm" type="number" placeholder="KM al momento" />
          </div>
          <div class="col">
            <input id="tTipo" placeholder="Tipo (service, reparaci√≥n, etc.)" />
            <input id="tCosto" type="number" placeholder="Costo" />
            <input id="tTaller" placeholder="Nombre del taller" />
          </div>
        </div>
        <textarea id="tDesc" placeholder="Descripci√≥n / observaci√≥n"></textarea>
        <button class="btn-ok" onclick="adminAddTaller()" style="width:100%">Registrar</button>
      </div>

      <div class="cardline">
        <h4>üõ¢Ô∏è Cambio de aceite (cada 1200 km)</h4>
        <div class="row">
          <div class="col">
            <select id="oilDom"></select>
          </div>
          <div class="col">
            <input id="oilFecha" type="date" />
          </div>
          <div class="col">
            <input id="oilKm" type="number" placeholder="KM al momento del cambio" />
          </div>
        </div>
        <textarea id="oilObs" placeholder="Observaci√≥n (opcional): aceite 10w30, filtro, etc."></textarea>
        <div class="row">
          <div class="col"><button class="btn-ok" onclick="adminValidateOilChange()" style="width:100%">‚úÖ Validar cambio de aceite</button></div>
          <div class="col"><button class="btn-secondary" onclick="adminSendOilReminderWhatsApp()" style="width:100%">üîî Enviar recordatorio WhatsApp</button></div>
        </div>
        <div class="muted" style="margin-top:6px">
          *La validaci√≥n resetea el contador. El recordatorio abre WhatsApp al tel√©fono del usuario asignado.
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col"><button class="btn-secondary" onclick="exportAdminTable('taller')" style="width:100%">üìä Excel / üßæ PDF Taller</button></div>
        <div class="col"><button class="btn-secondary" onclick="exportAdminTable('oilReminders')" style="width:100%">üìä Excel / üßæ PDF Recordatorios</button></div>
      </div>

      <h4 style="margin-top:12px">Historial de taller</h4>
      <table>
        <thead>
          <tr><th>Dominio</th><th>Fecha</th><th>KM</th><th>Tipo</th><th>Costo</th><th>Taller</th><th>Descripci√≥n</th><th>Creado por</th></tr>
        </thead>
        <tbody id="tallerTable"></tbody>
      </table>

      <h4 style="margin-top:12px">Historial cambios de aceite</h4>
      <table>
        <thead><tr><th>Dominio</th><th>Fecha</th><th>KM</th><th>Observaci√≥n</th><th>Validado por</th></tr></thead>
        <tbody id="oilHistoryTable"></tbody>
      </table>

      <h4 style="margin-top:12px">Historial recordatorios WhatsApp</h4>
      <table>
        <thead><tr><th>Dominio</th><th>Usuario</th><th>Tel√©fono</th><th>Estado aceite</th><th>KM restantes</th><th>Fecha</th></tr></thead>
        <tbody id="oilReminderTable"></tbody>
      </table>
    </div>

    <!-- KM -->
    <div id="aKm" class="section hidden">
      <div class="row">
        <div class="col"><button class="btn-secondary" onclick="exportAdminTable('km')" style="width:100%">üìä Excel / üßæ PDF KM</button></div>
        <div class="col"><button class="btn-secondary" onclick="exportAdminTable('oilStatus')" style="width:100%">üìä Excel / üßæ PDF Estado Aceite</button></div>
      </div>

      <h4 style="margin-top:12px">Kilometrajes (todas las cargas)</h4>
      <table>
        <thead><tr><th>Dominio</th><th>KM</th><th>Fecha</th><th>Usuario</th></tr></thead>
        <tbody id="adminKmTable"></tbody>
      </table>
    </div>

    <!-- LOGS -->
    <div id="aLogs" class="section hidden">
      <button class="btn-secondary" onclick="exportAdminTable('logs')" style="width:100%">üìä Excel / üßæ PDF Logs</button>
      <h4 style="margin-top:12px">Registro de accesos</h4>
      <table>
        <thead><tr><th>Usuario</th><th>Fecha</th></tr></thead>
        <tbody id="logTable"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* =========================
   STORAGE
========================= */
const KEYS = {
  users: "cv_users_v2",
  vehicles: "cv_vehicles_v2",
  obligations: "cv_obligations_v2",
  kms: "cv_kms_v2",
  logs: "cv_logs_v2",
  taller: "cv_taller_v2",
  oilHistory: "cv_oil_history_v2",
  oilReminders: "cv_oil_reminders_v2"
};

function loadJSON(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return fallback;
    const parsed = JSON.parse(raw);
    return parsed ?? fallback;
  }catch(e){
    return fallback;
  }
}
function saveJSON(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

let users = loadJSON(KEYS.users, {
  admin: { password:"1234", role:"ADMIN", nombre:"Administrador", telefono:"" }
});
let vehicles = loadJSON(KEYS.vehicles, {}); // {dominio:{...}}
let obligations = loadJSON(KEYS.obligations, []); // array
let kms = loadJSON(KEYS.kms, []); // array
let logs = loadJSON(KEYS.logs, []); // array
let taller = loadJSON(KEYS.taller, []); // array
let oilHistory = loadJSON(KEYS.oilHistory, []); // array
let oilReminders = loadJSON(KEYS.oilReminders, []); // array

function saveAll(){
  saveJSON(KEYS.users, users);
  saveJSON(KEYS.vehicles, vehicles);
  saveJSON(KEYS.obligations, obligations);
  saveJSON(KEYS.kms, kms);
  saveJSON(KEYS.logs, logs);
  saveJSON(KEYS.taller, taller);
  saveJSON(KEYS.oilHistory, oilHistory);
  saveJSON(KEYS.oilReminders, oilReminders);
}

/* =========================
   HELPERS
========================= */
let currentUser = null;

const OIL_INTERVAL_KM = 1200;
const OIL_WARN_THRESHOLD = 300; // <=300 km restantes => PR√ìXIMO

function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function todayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function nowStr(){ return new Date().toLocaleString(); }
function uid(){ return Date.now() + Math.floor(Math.random()*1000); }

function obBadge(st){
  if(st==="PAGADA") return `<span class="ok">PAGADA</span>`;
  if(st==="INFORMADO") return `<span class="pill">INFORMADO</span>`;
  if(st==="RECHAZADA") return `<span class="bad">RECHAZADA</span>`;
  return `<span class="pill">PENDIENTE</span>`;
}
function getUserVehicles(username){
  return Object.values(vehicles).filter(v => (v.usuario || "") === username).sort((a,b)=>a.dominio.localeCompare(b.dominio));
}
function computeAccountStatus(username){
  const hoy = new Date(todayISO());
  const myDom = new Set(getUserVehicles(username).map(v=>v.dominio));
  const hasDebt = obligations.some(o=>{
    if(!myDom.has(o.dominio)) return false;
    const venc = new Date(o.vencimiento);
    return venc < hoy && (o.estado==="PENDIENTE" || o.estado==="RECHAZADA");
  });
  return hasDebt ? "DEUDA" : "AL_DIA";
}

function normalizeWhatsAppPhone(raw){
  // Recomendado: 54911XXXXXXXX (AR). Ac√° solo limpiamos no-d√≠gitos.
  const digits = String(raw||"").replace(/\D/g,"");
  return digits;
}
function vehicleOwnerUsername(dom){
  return vehicles[dom]?.usuario || "";
}
function vehicleOwnerPhone(dom){
  const u = vehicleOwnerUsername(dom);
  return users[u]?.telefono || "";
}

function ensureVehicleOilFields(v){
  if(!v.aceite){
    v.aceite = {
      intervaloKm: OIL_INTERVAL_KM,
      ultimoCambioKm: 0,
      ultimoCambioFecha: "",
      ultimoKmRegistrado: 0
    };
  }
  if(!v.aceite.intervaloKm) v.aceite.intervaloKm = OIL_INTERVAL_KM;
  if(typeof v.aceite.ultimoCambioKm !== "number") v.aceite.ultimoCambioKm = Number(v.aceite.ultimoCambioKm||0);
  if(typeof v.aceite.ultimoKmRegistrado !== "number") v.aceite.ultimoKmRegistrado = Number(v.aceite.ultimoKmRegistrado||0);
}

function computeOilStatusForVehicle(v){
  ensureVehicleOilFields(v);
  const kmActual = Number(v.kmActual || 0);
  const lastChange = Number(v.aceite.ultimoCambioKm || 0);
  const interval = Number(v.aceite.intervaloKm || OIL_INTERVAL_KM);
  const kmDesde = kmActual - lastChange;
  const restantes = interval - kmDesde;

  let estado = "OK";
  if(restantes <= 0) estado = "VENCIDO";
  else if(restantes <= OIL_WARN_THRESHOLD) estado = "PROXIMO";

  return { kmActual, lastChange, interval, kmDesde, restantes, estado };
}

function oilChip(estado){
  if(estado==="OK") return `<span class="chip ok">üü¢ OK</span>`;
  if(estado==="PROXIMO") return `<span class="chip warn">üü° PR√ìXIMO</span>`;
  return `<span class="chip bad">üî¥ VENCIDO</span>`;
}

/* =========================
   LOGIN / NAV
========================= */
function login(){
  const u = document.getElementById("loginUser").value.trim();
  const p = document.getElementById("loginPass").value;
  const msg = document.getElementById("loginMsg");
  msg.textContent = "";

  if(!users[u] || users[u].password !== p){
    msg.textContent = "Usuario o contrase√±a incorrectos.";
    return;
  }

  currentUser = u;
  logs.unshift({ user: u, date: nowStr() });
  saveAll();

  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("panel").classList.remove("hidden");

  document.getElementById("rolePill").textContent = users[u].role;
  document.getElementById("panelTitle").innerHTML = users[u].role==="ADMIN" ? "<b>Administrador</b>" : "<b>Panel Veh√≠culo</b>";
  document.getElementById("panelSubtitle").textContent = users[u].role==="ADMIN" ? "" : `Usuario: ${u}`;

  if(users[u].role === "ADMIN"){
    document.getElementById("adminPanel").classList.remove("hidden");
    document.getElementById("userPanel").classList.add("hidden");
    showAdminTab("aUsers");
    adminRenderAll();
  }else{
    document.getElementById("userPanel").classList.remove("hidden");
    document.getElementById("adminPanel").classList.add("hidden");
    showUserTab("uPagos");
    userRenderAll();
  }
}

function logout(){ location.reload(); }

function showUserTab(id){
  ["uPagos","uKm","uDocs"].forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");

  if(id==="uPagos"){ userRenderHeader(); userRenderVehicles(); userRenderObligations(); }
  if(id==="uKm"){ userRenderKm(); }
  if(id==="uDocs"){ userRenderDocs(); }
}
function showAdminTab(id){
  ["aUsers","aVeh","aOb","aTaller","aKm","aLogs"].forEach(x=>document.getElementById(x).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");

  if(id==="aUsers") adminRenderUsers();
  if(id==="aVeh") adminRenderVehicles();
  if(id==="aOb") { showObTab("pendientes"); adminRenderObligations(); }
  if(id==="aTaller") adminRenderTallerAll();
  if(id==="aKm") adminRenderKm();
  if(id==="aLogs") adminRenderLogs();
}

/* =========================
   USER
========================= */
function userRenderAll(){
  userRenderHeader();
  userRenderVehicles();
  userRenderObligations();
  userRenderKm();
  userRenderDocs();
}

function userRenderHeader(){
  const u = users[currentUser];
  document.getElementById("userHello").textContent = `Hola ${u?.nombre || currentUser}`;

  const st = computeAccountStatus(currentUser);
  document.getElementById("userEstado").innerHTML = st==="DEUDA"
    ? `<span class="bad">DEUDA</span>`
    : `<span class="ok">AL D√çA</span>`;

  const my = getUserVehicles(currentUser);
  const box = document.getElementById("userSingleVehicleSummary");
  box.innerHTML = "";

  if(my.length === 0){
    box.innerHTML = `<div class="muted">No ten√©s veh√≠culo asignado a√∫n.</div>`;
    return;
  }

  if(my.length === 1){
    const v = my[0];
    const oil = computeOilStatusForVehicle(v);
    box.innerHTML = `
      <div><b>Dominio:</b> ${esc(v.dominio)}</div>
      <div><b>Cuota semanal:</b> $${Number(v.cuotaSemanal||0)}</div>
      <div style="margin-top:6px"><b>Aceite:</b> ${oilChip(oil.estado)} <span class="muted">(restan ${oil.restantes} km)</span></div>
    `;
  }else{
    box.innerHTML = `
      <div><b>Veh√≠culos asignados:</b> ${my.length}</div>
      <div class="muted">Ver detalle en ‚ÄúPagos‚Äù o ‚ÄúKM‚Äù.</div>
    `;
  }
}

function userRenderVehicles(){
  const tbody = document.getElementById("userVehTable");
  tbody.innerHTML = "";

  const my = getUserVehicles(currentUser);
  if(my.length===0){
    tbody.innerHTML = `<tr><td colspan="7" class="muted">No ten√©s veh√≠culos asignados.</td></tr>`;
    return;
  }

  my.forEach(v=>{
    const oil = computeOilStatusForVehicle(v);
    tbody.innerHTML += `
      <tr>
        <td><b>${esc(v.dominio)}</b></td>
        <td>${esc(v.modelo||"-")}</td>
        <td>${esc(v.color||"-")}</td>
        <td>$${Number(v.cuotaSemanal||0)}</td>
        <td>${esc(v.vtv||"-")}</td>
        <td>${esc(v.seguro||"-")}</td>
        <td>${oilChip(oil.estado)}<div class="muted">Restan ${oil.restantes} km</div></td>
      </tr>
    `;
  });
}

function userRenderObligations(){
  const tbody = document.getElementById("userObTable");
  tbody.innerHTML = "";

  const myDom = new Set(getUserVehicles(currentUser).map(v=>v.dominio));
  const items = obligations
    .filter(o=>myDom.has(o.dominio))
    .sort((a,b)=> new Date(a.vencimiento) - new Date(b.vencimiento));

  if(items.length===0){
    tbody.innerHTML = `<tr><td colspan="9" class="muted">No hay obligaciones cargadas.</td></tr>`;
    return;
  }

  items.forEach(o=>{
    const canInform = (o.estado==="PENDIENTE" || o.estado==="RECHAZADA");
    tbody.innerHTML += `
      <tr>
        <td><b>${esc(o.dominio)}</b></td>
        <td>${esc(o.concepto)}</td>
        <td>$${Number(o.monto||0)}</td>
        <td>${esc(o.vencimiento)}</td>
        <td>${obBadge(o.estado)}</td>
        <td>${esc(o.medioPago||"-")}</td>
        <td>${esc(o.fechaPago||"-")}</td>
        <td>${esc(o.motivoRechazo||"-")}</td>
        <td>
          ${canInform ? `<button onclick="userInformPayment(${o.id})" style="width:100%">Informar pago</button>` : "‚Äî"}
        </td>
      </tr>
    `;
  });
}

function userInformPayment(id){
  const ob = obligations.find(o=>o.id===id);
  if(!ob) return;

  if(!(ob.estado==="PENDIENTE" || ob.estado==="RECHAZADA")){
    alert("Esta obligaci√≥n ya fue informada o pagada.");
    return;
  }

  const veh = vehicles[ob.dominio];
  if(!veh || veh.usuario !== currentUser){
    alert("No ten√©s permiso para informar este pago.");
    return;
  }

  const medio = prompt("Medio de pago (efectivo / transferencia / MP):");
  if(medio===null) return;
  const m = medio.trim();
  if(!m) return alert("Deb√©s indicar el medio de pago.");

  ob.estado = "INFORMADO";
  ob.medioPago = m;
  ob.fechaPago = nowStr();
  ob.motivoRechazo = ""; // si estaba rechazada, al re-informar se limpia motivo

  saveAll();
  userRenderObligations();
  userRenderHeader();
}

function userRenderKm(){
  const sel = document.getElementById("kmDomSelect");
  sel.innerHTML = "";

  const my = getUserVehicles(currentUser);
  if(my.length===0){
    sel.innerHTML = `<option value="">-- Sin veh√≠culos asignados --</option>`;
  }else{
    my.forEach(v=> sel.innerHTML += `<option value="${esc(v.dominio)}">${esc(v.dominio)}</option>`);
  }

  // Oil cards
  const cards = document.getElementById("userOilCards");
  cards.innerHTML = "";
  my.forEach(v=>{
    const oil = computeOilStatusForVehicle(v);
    const lastChangeText = oil.lastChange ? `${oil.lastChange} km` : "No registrado";
    cards.innerHTML += `
      <div class="cardline">
        <div><b>${esc(v.dominio)}</b> ${oilChip(oil.estado)}</div>
        <div class="muted" style="margin-top:6px">
          KM actual: <b>${oil.kmActual}</b><br/>
          √öltimo cambio validado: <b>${lastChangeText}</b><br/>
          Desde √∫ltimo: <b>${oil.kmDesde}</b> km<br/>
          Restan: <b>${oil.restantes}</b> km (intervalo ${oil.interval} km)
        </div>
      </div>
    `;
  });

  // KM history
  const tbody = document.getElementById("userKmTable");
  tbody.innerHTML = "";

  const myDom = new Set(my.map(v=>v.dominio));
  const items = kms.filter(k=>myDom.has(k.dominio));
  if(items.length===0){
    tbody.innerHTML = `<tr><td colspan="3" class="muted">Sin cargas a√∫n.</td></tr>`;
    return;
  }
  items.forEach(k=>{
    tbody.innerHTML += `<tr><td><b>${esc(k.dominio)}</b></td><td>${Number(k.km||0)}</td><td>${esc(k.fecha)}</td></tr>`;
  });
}

function userSaveKm(){
  const dom = document.getElementById("kmDomSelect").value;
  const km = Number(document.getElementById("kmValue").value || 0);

  if(!dom) return alert("Seleccion√° un dominio.");
  if(!vehicles[dom] || vehicles[dom].usuario !== currentUser) return alert("No ten√©s permiso para ese dominio.");
  if(!km || km<=0) return alert("Kilometraje inv√°lido.");

  const v = vehicles[dom];
  ensureVehicleOilFields(v);

  // Validaci√≥n: KM no puede bajar
  const prevKm = Number(v.kmActual || 0);
  if(km < prevKm) return alert(`El KM no puede bajar. √öltimo registrado: ${prevKm}.`);

  // Validaci√≥n: KM no puede ser menor al km del √∫ltimo cambio de aceite validado
  const lastChange = Number(v.aceite.ultimoCambioKm || 0);
  if(km < lastChange) return alert(`El KM no puede ser menor al √∫ltimo cambio de aceite validado (${lastChange} km).`);

  // Guardar km actual en veh√≠culo
  v.kmActual = km;
  v.kmUpdatedAt = nowStr();
  v.aceite.ultimoKmRegistrado = km;

  // Guardar evento KM
  kms.unshift({ id: uid(), dominio: dom, km, fecha: nowStr(), user: currentUser });

  saveAll();
  document.getElementById("kmValue").value = "";

  // Refresh panels
  userRenderKm();
  userRenderVehicles();
  userRenderHeader();
}

function userRenderDocs(){
  const cards = document.getElementById("userDocsCards");
  cards.innerHTML = "";

  const my = getUserVehicles(currentUser);
  if(my.length===0){
    cards.innerHTML = `<div class="muted">No hay veh√≠culos asignados.</div>`;
    return;
  }

  my.forEach(v=>{
    cards.innerHTML += `
      <div class="cardline">
        <div><b>${esc(v.dominio)}</b></div>
        <div class="muted" style="margin-top:6px">
          Modelo: <b>${esc(v.modelo||"-")}</b><br/>
          Color: <b>${esc(v.color||"-")}</b><br/>
          Cuota semanal: <b>$${Number(v.cuotaSemanal||0)}</b><br/>
          VTV: <b>${esc(v.vtv||"-")}</b><br/>
          Seguro: <b>${esc(v.seguro||"-")}</b>
        </div>
      </div>
    `;
  });
}

/* =========================
   ADMIN USERS
========================= */
function adminRenderAll(){
  adminRenderUsers();
  adminRenderVehicles();
  adminRenderObligations();
  adminRenderTallerAll();
  adminRenderKm();
  adminRenderLogs();
}

function adminCreateUser(){
  const u = document.getElementById("nuUser").value.trim();
  const nombre = document.getElementById("nuNombre").value.trim();
  const telefonoRaw = document.getElementById("nuTelefono").value.trim();
  const pass = document.getElementById("nuPass").value.trim() || "1234";
  const role = document.getElementById("nuRole").value;

  if(!u) return alert("Usuario requerido.");
  if(users[u]) return alert("Ese usuario ya existe.");
  if(u.toLowerCase()==="admin") return alert("No uses 'admin' como usuario nuevo.");

  const tel = normalizeWhatsAppPhone(telefonoRaw);
  if(!tel) return alert("Tel√©fono obligatorio.");
  if(tel.length < 10) return alert("Tel√©fono inv√°lido. Recomendado: 54911XXXXXXXX.");

  users[u] = { password: pass, role, nombre: nombre || u, telefono: tel };
  saveAll();

  document.getElementById("nuUser").value="";
  document.getElementById("nuNombre").value="";
  document.getElementById("nuTelefono").value="";
  document.getElementById("nuPass").value="";
  document.getElementById("nuRole").value="USUARIO";

  adminRenderUsers();
  adminRenderVehicles();
  adminRenderTallerDropdowns();
}

function adminRenderUsers(){
  const tbody = document.getElementById("adminUsersTable");
  tbody.innerHTML = "";

  Object.keys(users).sort().forEach(u=>{
    const isRoot = (u==="admin");
    tbody.innerHTML += `
      <tr>
        <td><b>${esc(u)}</b></td>
        <td><input id="un_${esc(u)}" value="${esc(users[u].nombre||"")}"></td>
        <td>
          <select id="ur_${esc(u)}" ${isRoot ? "disabled" : ""}>
            <option value="USUARIO" ${users[u].role==="USUARIO"?"selected":""}>USUARIO</option>
            <option value="ADMIN" ${users[u].role==="ADMIN"?"selected":""}>ADMIN</option>
          </select>
        </td>
        <td><input id="ut_${esc(u)}" value="${esc(users[u].telefono||"")}" placeholder="54911XXXXXXXX"></td>
        <td><input id="up_${esc(u)}" value="${esc(users[u].password||"")}"></td>
        <td><button class="btn-ok" onclick="adminSaveUser('${esc(u)}')">üíæ</button></td>
        <td><button class="btn-danger" onclick="adminDeleteUser('${esc(u)}')" ${isRoot ? "disabled" : ""}>üóë</button></td>
      </tr>
    `;
  });

  // dropdown asignaci√≥n veh√≠culos: solo USUARIO
  const assign = document.getElementById("vAssign");
  assign.innerHTML = `<option value="">-- Sin asignar --</option>`;
  Object.keys(users).sort().forEach(u=>{
    if(users[u].role==="USUARIO"){
      assign.innerHTML += `<option value="${esc(u)}">${esc(u)}</option>`;
    }
  });
}

function adminSaveUser(u){
  const nombre = document.getElementById(`un_${u}`).value.trim();
  const role = document.getElementById(`ur_${u}`).value;
  const pass = document.getElementById(`up_${u}`).value.trim();
  const telRaw = document.getElementById(`ut_${u}`).value.trim();

  if(!pass) return alert("La contrase√±a no puede quedar vac√≠a.");

  const isRoot = (u==="admin");
  if(!isRoot){
    const tel = normalizeWhatsAppPhone(telRaw);
    if(!tel) return alert("Tel√©fono obligatorio.");
    if(tel.length < 10) return alert("Tel√©fono inv√°lido. Recomendado: 54911XXXXXXXX.");
    users[u].telefono = tel;
    users[u].role = role;
  }else{
    // root admin: tel√©fono opcional
    users[u].telefono = normalizeWhatsAppPhone(telRaw);
  }

  users[u].nombre = nombre || u;
  users[u].password = pass;

  saveAll();
  adminRenderUsers();
  adminRenderVehicles();
  adminRenderTallerDropdowns();
  alert("Usuario actualizado.");
}

function adminDeleteUser(u){
  if(u==="admin") return;
  if(!confirm(`¬øEliminar usuario ${u}?`)) return;

  // desasignar veh√≠culos
  Object.values(vehicles).forEach(v=>{
    if(v.usuario === u) v.usuario = "";
  });

  delete users[u];
  saveAll();

  adminRenderUsers();
  adminRenderVehicles();
  adminRenderObligations();
  adminRenderTallerDropdowns();
}

/* =========================
   ADMIN VEHICLES
========================= */
function adminRenderVehicles(){
  // selector
  const sel = document.getElementById("vehSelect");
  sel.innerHTML = `<option value="">-- Nuevo veh√≠culo --</option>`;
  Object.keys(vehicles).sort().forEach(dom=>{
    sel.innerHTML += `<option value="${esc(dom)}">${esc(dom)}</option>`;
  });

  // table editable
  const tbody = document.getElementById("adminVehTable");
  tbody.innerHTML = "";

  const userOptions = (() => {
    let html = `<option value="">-- Sin asignar --</option>`;
    Object.keys(users).sort().forEach(u=>{
      if(users[u].role==="USUARIO") html += `<option value="${esc(u)}">${esc(u)}</option>`;
    });
    return html;
  })();

  const doms = Object.keys(vehicles).sort();
  if(doms.length===0){
    tbody.innerHTML = `<tr><td colspan="8" class="muted">No hay veh√≠culos cargados.</td></tr>`;
    adminRenderVehicleSelectors();
    return;
  }

  doms.forEach(dom=>{
    const v = vehicles[dom];
    ensureVehicleOilFields(v);
    tbody.innerHTML += `
      <tr>
        <td><b>${esc(dom)}</b></td>
        <td><input id="vm_${esc(dom)}" value="${esc(v.modelo||"")}"></td>
        <td><input id="vc_${esc(dom)}" value="${esc(v.color||"")}"></td>
        <td><input id="vcu_${esc(dom)}" type="number" value="${Number(v.cuotaSemanal||0)}"></td>
        <td><input id="vv_${esc(dom)}" type="date" value="${esc(v.vtv||"")}"></td>
        <td><input id="vs_${esc(dom)}" value="${esc(v.seguro||"")}"></td>
        <td><select id="va_${esc(dom)}">${userOptions}</select></td>
        <td><button class="btn-ok" onclick="adminSaveVehicleRow('${esc(dom)}')">üíæ</button></td>
      </tr>
    `;
    document.getElementById(`va_${dom}`).value = v.usuario || "";
  });

  adminRenderVehicleSelectors();
}

function adminRenderVehicleSelectors(){
  // selector dominio en obligaciones y taller
  const doms = Object.keys(vehicles).sort();
  const obSel = document.getElementById("obDom");
  const tSel = document.getElementById("tDom");
  const oilSel = document.getElementById("oilDom");

  const build = (sel) => {
    sel.innerHTML = "";
    if(doms.length===0){
      sel.innerHTML = `<option value="">-- Sin veh√≠culos --</option>`;
      return;
    }
    doms.forEach(d=> sel.innerHTML += `<option value="${esc(d)}">${esc(d)}</option>`);
  };

  build(obSel);
  build(tSel);
  build(oilSel);

  // default oil date
  document.getElementById("oilFecha").value = todayISO();
  document.getElementById("tFecha").value = todayISO();
}

function adminLoadVehicleForm(){
  const selected = document.getElementById("vehSelect").value;
  if(!selected){
    document.getElementById("vDom").value="";
    document.getElementById("vModelo").value="";
    document.getElementById("vColor").value="";
    document.getElementById("vCuota").value="";
    document.getElementById("vVtv").value="";
    document.getElementById("vSeguro").value="";
    document.getElementById("vAssign").value="";
    return;
  }
  const v = vehicles[selected];
  ensureVehicleOilFields(v);

  document.getElementById("vDom").value = v.dominio || selected;
  document.getElementById("vModelo").value = v.modelo || "";
  document.getElementById("vColor").value = v.color || "";
  document.getElementById("vCuota").value = Number(v.cuotaSemanal||0);
  document.getElementById("vVtv").value = v.vtv || "";
  document.getElementById("vSeguro").value = v.seguro || "";
  document.getElementById("vAssign").value = v.usuario || "";
}

function adminSaveVehicle(){
  const selected = document.getElementById("vehSelect").value;
  const dom = document.getElementById("vDom").value.trim().toUpperCase();
  if(!dom) return alert("Dominio requerido.");

  const payload = {
    dominio: dom,
    modelo: document.getElementById("vModelo").value.trim(),
    color: document.getElementById("vColor").value.trim(),
    cuotaSemanal: Number(document.getElementById("vCuota").value || 0),
    vtv: document.getElementById("vVtv").value,
    seguro: document.getElementById("vSeguro").value.trim(),
    usuario: document.getElementById("vAssign").value,
    kmActual: 0,
    kmUpdatedAt: "",
    aceite: { intervaloKm: OIL_INTERVAL_KM, ultimoCambioKm: 0, ultimoCambioFecha: "", ultimoKmRegistrado: 0 }
  };

  const isRename = selected && selected !== dom;
  if(isRename){
    if(vehicles[dom]) return alert("Ya existe ese dominio.");
    const old = vehicles[selected];
    // conservar datos hist√≥ricos relevantes si ya exist√≠a
    payload.kmActual = Number(old?.kmActual || 0);
    payload.kmUpdatedAt = old?.kmUpdatedAt || "";
    payload.aceite = old?.aceite || payload.aceite;

    delete vehicles[selected];
    vehicles[dom] = payload;

    // actualizar referencias
    obligations.forEach(o=>{ if(o.dominio===selected) o.dominio = dom; });
    kms.forEach(k=>{ if(k.dominio===selected) k.dominio = dom; });
    taller.forEach(t=>{ if(t.dominio===selected) t.dominio = dom; });
    oilHistory.forEach(h=>{ if(h.dominio===selected) h.dominio = dom; });
    oilReminders.forEach(r=>{ if(r.dominio===selected) r.dominio = dom; });

  }else{
    // si ya existe, mantenemos km/aceite existentes y actualizamos dem√°s campos
    if(vehicles[dom]){
      const old = vehicles[dom];
      payload.kmActual = Number(old?.kmActual || 0);
      payload.kmUpdatedAt = old?.kmUpdatedAt || "";
      payload.aceite = old?.aceite || payload.aceite;
    }
    vehicles[dom] = payload;
  }

  saveAll();
  adminRenderVehicles();
  adminRenderObligations();
  adminRenderTallerDropdowns();

  document.getElementById("vehSelect").value = dom;
  alert("Veh√≠culo guardado.");
}

function adminSaveVehicleRow(dom){
  const v = vehicles[dom];
  if(!v) return;

  v.modelo = document.getElementById(`vm_${dom}`).value.trim();
  v.color = document.getElementById(`vc_${dom}`).value.trim();
  v.cuotaSemanal = Number(document.getElementById(`vcu_${dom}`).value || 0);
  v.vtv = document.getElementById(`vv_${dom}`).value;
  v.seguro = document.getElementById(`vs_${dom}`).value.trim();
  v.usuario = document.getElementById(`va_${dom}`).value;

  saveAll();
}

function adminDeleteVehicle(){
  const selected = document.getElementById("vehSelect").value || document.getElementById("vDom").value.trim().toUpperCase();
  if(!selected) return alert("Seleccion√° un veh√≠culo.");
  if(!vehicles[selected]) return alert("No existe ese veh√≠culo.");
  if(!confirm(`¬øEliminar veh√≠culo ${selected}?`)) return;

  delete vehicles[selected];
  saveAll();

  adminRenderVehicles();
  adminRenderObligations();
  adminRenderTallerDropdowns();
  adminLoadVehicleForm();
}

/* =========================
   ADMIN OBLIGATIONS
========================= */
function showObTab(tab){
  ["ob_pendientes","ob_aprobadas","ob_rechazadas"].forEach(id => document.getElementById(id).classList.add("hidden"));
  document.getElementById("ob_"+tab).classList.remove("hidden");
}

function adminAddObligation(){
  const dom = document.getElementById("obDom").value.trim().toUpperCase();
  const concepto = document.getElementById("obConcepto").value.trim();
  const monto = Number(document.getElementById("obMonto").value || 0);
  const vence = document.getElementById("obVence").value;

  if(!dom) return alert("Dominio requerido.");
  if(!vehicles[dom]) return alert("El dominio no existe en veh√≠culos.");
  if(!concepto) return alert("Concepto requerido.");
  if(!monto || monto<=0) return alert("Monto inv√°lido.");
  if(!vence) return alert("Vencimiento requerido.");

  obligations.push({
    id: uid(),
    dominio: dom,
    concepto,
    monto,
    vencimiento: vence,
    estado: "PENDIENTE", // PENDIENTE | INFORMADO | PAGADA | RECHAZADA
    medioPago: "",
    fechaPago: "",
    motivoRechazo: ""
  });

  saveAll();
  document.getElementById("obConcepto").value="";
  document.getElementById("obMonto").value="";
  document.getElementById("obVence").value="";

  adminRenderObligations();
}

function obligationMatchesFilters(o){
  const domF = document.getElementById("fDom").value.trim().toUpperCase();
  const userF = document.getElementById("fUser").value.trim();
  const vencF = document.getElementById("fVencidas").value;

  if(domF && !o.dominio.toUpperCase().includes(domF)) return false;

  if(userF){
    const owner = vehicleOwnerUsername(o.dominio);
    if(!owner.toLowerCase().includes(userF.toLowerCase())) return false;
  }

  if(vencF === "vencidas"){
    const hoy = new Date(todayISO());
    const venc = new Date(o.vencimiento);
    if(!(venc < hoy)) return false;
  }

  return true;
}

function adminRenderObligations(){
  const pend = document.getElementById("adminObPendientes");
  const apr = document.getElementById("adminObAprobadas");
  const rej = document.getElementById("adminObRechazadas");
  pend.innerHTML = ""; apr.innerHTML = ""; rej.innerHTML = "";

  const filtered = obligations.filter(obligationMatchesFilters);

  // Resumen
  const total = filtered.length;
  const cPend = filtered.filter(o=>o.estado==="PENDIENTE").length;
  const cInf  = filtered.filter(o=>o.estado==="INFORMADO").length;
  const cApr  = filtered.filter(o=>o.estado==="PAGADA").length;
  const cRej  = filtered.filter(o=>o.estado==="RECHAZADA").length;

  document.getElementById("obSummaryBanner").innerHTML = `
    <b>Resumen (filtrado):</b>
    <span class="chip">Total: ${total}</span>
    <span class="chip">PENDIENTE: ${cPend}</span>
    <span class="chip">INFORMADO: ${cInf}</span>
    <span class="chip ok">PAGADA: ${cApr}</span>
    <span class="chip bad">RECHAZADA: ${cRej}</span>
  `;

  // Agrupar por mes visualmente (YYYY-MM)
  const byMonth = {};
  filtered.forEach(o=>{
    const m = String(o.vencimiento||"").slice(0,7) || "Sin fecha";
    if(!byMonth[m]) byMonth[m] = [];
    byMonth[m].push(o);
  });

  const months = Object.keys(byMonth).sort().reverse();
  if(months.length===0){
    pend.innerHTML = `<tr><td colspan="10" class="muted">No hay obligaciones con esos filtros.</td></tr>`;
    apr.innerHTML = `<tr><td colspan="8" class="muted">‚Äî</td></tr>`;
    rej.innerHTML = `<tr><td colspan="9" class="muted">‚Äî</td></tr>`;
    return;
  }

  months.forEach(m=>{
    const list = byMonth[m].slice().sort((a,b)=> new Date(b.vencimiento)-new Date(a.vencimiento));
    const monthRowPend = `<tr><td colspan="10" style="text-align:left"><b>Mes:</b> ${esc(m)}</td></tr>`;
    const monthRowApr  = `<tr><td colspan="8" style="text-align:left"><b>Mes:</b> ${esc(m)}</td></tr>`;
    const monthRowRej  = `<tr><td colspan="9" style="text-align:left"><b>Mes:</b> ${esc(m)}</td></tr>`;

    let wrotePend = false, wroteApr=false, wroteRej=false;

    list.forEach(o=>{
      const owner = vehicleOwnerUsername(o.dominio) || "-";
      const basePend = `
        <td><b>${esc(o.dominio)}</b></td>
        <td>${esc(owner)}</td>
        <td>${esc(o.concepto)}</td>
        <td>$${Number(o.monto||0)}</td>
        <td>${esc(o.vencimiento)}</td>
        <td>${obBadge(o.estado)}</td>
        <td>${esc(o.medioPago||"-")}</td>
        <td>${esc(o.fechaPago||"-")}</td>
      `;

      if(o.estado==="PENDIENTE" || o.estado==="INFORMADO"){
        if(!wrotePend){ pend.innerHTML += monthRowPend; wrotePend=true; }
        const canApprove = (o.estado==="INFORMADO");
        const canReject  = (o.estado==="INFORMADO");
        pend.innerHTML += `
          <tr>
            ${basePend}
            <td><button class="btn-ok" ${canApprove?"":"disabled"} onclick="adminApprove(${o.id})">‚úÖ</button></td>
            <td><button class="btn-warn" ${canReject?"":"disabled"} onclick="adminReject(${o.id})">‚ùå</button></td>
          </tr>
        `;
      }

      if(o.estado==="PAGADA"){
        if(!wroteApr){ apr.innerHTML += monthRowApr; wroteApr=true; }
        apr.innerHTML += `<tr>${basePend}</tr>`;
      }

      if(o.estado==="RECHAZADA"){
        if(!wroteRej){ rej.innerHTML += monthRowRej; wroteRej=true; }
        rej.innerHTML += `<tr>${basePend}<td>${esc(o.motivoRechazo||"-")}</td></tr>`;
      }
    });
  });

  // Si alguna tabla qued√≥ vac√≠a, mostrar placeholder
  if(!pend.innerHTML) pend.innerHTML = `<tr><td colspan="10" class="muted">No hay pendientes/informadas.</td></tr>`;
  if(!apr.innerHTML)  apr.innerHTML  = `<tr><td colspan="8" class="muted">No hay aprobadas.</td></tr>`;
  if(!rej.innerHTML)  rej.innerHTML  = `<tr><td colspan="9" class="muted">No hay rechazadas.</td></tr>`;
}

function adminApprove(id){
  const ob = obligations.find(o=>o.id===id);
  if(!ob) return;

  if(ob.estado !== "INFORMADO"){
    alert("Solo se puede aprobar si est√° INFORMADO.");
    return;
  }

  ob.estado = "PAGADA";
  // queda el medio/fecha como auditor√≠a
  saveAll();
  adminRenderObligations();
}

function adminReject(id){
  const ob = obligations.find(o=>o.id===id);
  if(!ob) return;

  if(ob.estado !== "INFORMADO"){
    alert("Solo se puede rechazar si est√° INFORMADO.");
    return;
  }

  const motivo = prompt("Motivo del rechazo:");
  if(motivo===null) return;
  const m = motivo.trim();
  if(!m) return alert("Deb√©s indicar un motivo.");

  ob.estado = "RECHAZADA";
  ob.motivoRechazo = m;
  saveAll();
  adminRenderObligations();
}

/* =========================
   ADMIN TALLER + ACEITE + WHATSAPP
========================= */
function adminRenderTallerDropdowns(){
  adminRenderVehicleSelectors();
}

function adminRenderTallerAll(){
  adminRenderVehicleSelectors();
  // autocompletar km en formulario de aceite seg√∫n veh√≠culo seleccionado
  const dom = document.getElementById("oilDom").value;
  if(dom && vehicles[dom]){
    document.getElementById("oilKm").value = Number(vehicles[dom].kmActual||0) || "";
  }
  adminRenderTaller();
  adminRenderOilHistory();
  adminRenderOilReminders();
}

document.addEventListener("change", (e)=>{
  if(e.target && e.target.id === "oilDom"){
    const dom = document.getElementById("oilDom").value;
    if(dom && vehicles[dom]){
      document.getElementById("oilKm").value = Number(vehicles[dom].kmActual||0) || "";
    }else{
      document.getElementById("oilKm").value = "";
    }
  }
});

function adminAddTaller(){
  const dom = document.getElementById("tDom").value.trim().toUpperCase();
  const fecha = document.getElementById("tFecha").value || todayISO();
  const km = Number(document.getElementById("tKm").value || 0);
  const tipo = document.getElementById("tTipo").value.trim();
  const costo = Number(document.getElementById("tCosto").value || 0);
  const tallerName = document.getElementById("tTaller").value.trim();
  const desc = document.getElementById("tDesc").value.trim();

  if(!dom) return alert("Dominio requerido.");
  if(!vehicles[dom]) return alert("El dominio no existe.");
  if(!tipo) return alert("Tipo requerido.");

  taller.unshift({
    id: uid(),
    dominio: dom,
    fecha,
    km: km || (Number(vehicles[dom].kmActual||0) || 0),
    tipo,
    costo,
    taller: tallerName,
    desc,
    creadoPor: currentUser
  });

  saveAll();
  document.getElementById("tKm").value="";
  document.getElementById("tTipo").value="";
  document.getElementById("tCosto").value="";
  document.getElementById("tTaller").value="";
  document.getElementById("tDesc").value="";
  adminRenderTaller();
}

function adminRenderTaller(){
  const tbody = document.getElementById("tallerTable");
  tbody.innerHTML = "";

  if(taller.length===0){
    tbody.innerHTML = `<tr><td colspan="8" class="muted">Sin registros de taller.</td></tr>`;
    return;
  }

  taller.slice(0,400).forEach(t=>{
    tbody.innerHTML += `
      <tr>
        <td><b>${esc(t.dominio)}</b></td>
        <td>${esc(t.fecha)}</td>
        <td>${Number(t.km||0)}</td>
        <td>${esc(t.tipo)}</td>
        <td>$${Number(t.costo||0)}</td>
        <td>${esc(t.taller||"-")}</td>
        <td>${esc(t.desc||"-")}</td>
        <td>${esc(t.creadoPor||"-")}</td>
      </tr>
    `;
  });
}

function adminValidateOilChange(){
  const dom = document.getElementById("oilDom").value.trim().toUpperCase();
  const fecha = document.getElementById("oilFecha").value || todayISO();
  const km = Number(document.getElementById("oilKm").value || 0);
  const obs = document.getElementById("oilObs").value.trim();

  if(!dom) return alert("Dominio requerido.");
  if(!vehicles[dom]) return alert("El dominio no existe.");
  const v = vehicles[dom];
  ensureVehicleOilFields(v);

  const kmActual = Number(v.kmActual||0);
  if(!km || km<=0) return alert("KM del cambio requerido (n√∫mero).");
  if(km < kmActual) return alert(`El KM del cambio no puede ser menor al KM actual registrado (${kmActual}).`);
  if(km < Number(v.aceite.ultimoCambioKm||0)) return alert("El KM del cambio no puede ser menor al √∫ltimo cambio ya validado.");

  // Registrar en historial de aceite
  oilHistory.unshift({
    id: uid(),
    dominio: dom,
    fecha,
    km,
    obs,
    validadoPor: currentUser
  });

  // Actualizar veh√≠culo (resetea referencia)
  v.kmActual = Math.max(kmActual, km); // si el cambio se valida con km mayor, actualizamos
  v.kmUpdatedAt = nowStr();
  v.aceite.intervaloKm = OIL_INTERVAL_KM;
  v.aceite.ultimoCambioKm = km;
  v.aceite.ultimoCambioFecha = fecha;
  v.aceite.ultimoKmRegistrado = v.kmActual;

  // Tambi√©n registramos en taller como evento
  taller.unshift({
    id: uid(),
    dominio: dom,
    fecha,
    km,
    tipo: "CAMBIO_ACEITE",
    costo: 0,
    taller: "",
    desc: obs ? `Cambio de aceite: ${obs}` : "Cambio de aceite",
    creadoPor: currentUser
  });

  saveAll();
  document.getElementById("oilObs").value = "";
  alert("Cambio de aceite validado. Contador reiniciado a 1200 km.");

  adminRenderTallerAll();
}

function adminSendOilReminderWhatsApp(){
  const dom = document.getElementById("oilDom").value.trim().toUpperCase();
  if(!dom) return alert("Seleccion√° un dominio.");
  if(!vehicles[dom]) return alert("El dominio no existe.");

  const v = vehicles[dom];
  const owner = v.usuario || "";
  if(!owner) return alert("Ese veh√≠culo no tiene usuario asignado.");
  const tel = normalizeWhatsAppPhone(users[owner]?.telefono || "");
  if(!tel) return alert("El usuario no tiene tel√©fono cargado (obligatorio).");

  const oil = computeOilStatusForVehicle(v);
  const nombre = users[owner]?.nombre || owner;
  const estadoTxt = (oil.estado==="OK") ? "OK" : (oil.estado==="PROXIMO" ? "PR√ìXIMO" : "VENCIDO");

  const msg =
`Hola ${nombre},
te recordamos que el veh√≠culo ${v.dominio} tiene el cambio de aceite ${estadoTxt}.

Restan ${oil.restantes} km para realizarlo (intervalo ${oil.interval} km).

Por favor coordin√° el service.
‚Äî Administraci√≥n`;

  // wa.me requiere solo d√≠gitos, ideal AR: 54911XXXXXXXX
  const url = `https://wa.me/${encodeURIComponent(tel)}?text=${encodeURIComponent(msg)}`;
  window.open(url, "_blank", "noopener,noreferrer");

  // guardar auditor√≠a
  oilReminders.unshift({
    id: uid(),
    dominio: dom,
    user: owner,
    telefono: tel,
    estadoAceite: oil.estado,
    kmRestantes: oil.restantes,
    fecha: nowStr()
  });

  saveAll();
  adminRenderOilReminders();
}

function adminRenderOilHistory(){
  const tbody = document.getElementById("oilHistoryTable");
  tbody.innerHTML = "";

  if(oilHistory.length===0){
    tbody.innerHTML = `<tr><td colspan="5" class="muted">Sin cambios de aceite validados.</td></tr>`;
    return;
  }

  oilHistory.slice(0,400).forEach(h=>{
    tbody.innerHTML += `
      <tr>
        <td><b>${esc(h.dominio)}</b></td>
        <td>${esc(h.fecha)}</td>
        <td>${Number(h.km||0)}</td>
        <td>${esc(h.obs||"-")}</td>
        <td>${esc(h.validadoPor||"-")}</td>
      </tr>
    `;
  });
}

function adminRenderOilReminders(){
  const tbody = document.getElementById("oilReminderTable");
  tbody.innerHTML = "";

  if(oilReminders.length===0){
    tbody.innerHTML = `<tr><td colspan="6" class="muted">Sin recordatorios enviados.</td></tr>`;
    return;
  }

  oilReminders.slice(0,500).forEach(r=>{
    const estadoTxt = (r.estadoAceite==="OK") ? "OK" : (r.estadoAceite==="PROXIMO" ? "PR√ìXIMO" : "VENCIDO");
    tbody.innerHTML += `
      <tr>
        <td><b>${esc(r.dominio)}</b></td>
        <td>${esc(r.user)}</td>
        <td>${esc(r.telefono)}</td>
        <td>${esc(estadoTxt)}</td>
        <td>${Number(r.kmRestantes||0)}</td>
        <td>${esc(r.fecha)}</td>
      </tr>
    `;
  });
}

/* =========================
   ADMIN KM + LOGS
========================= */
function adminRenderKm(){
  const tbody = document.getElementById("adminKmTable");
  tbody.innerHTML = "";

  if(kms.length===0){
    tbody.innerHTML = `<tr><td colspan="4" class="muted">Sin cargas de KM.</td></tr>`;
    return;
  }

  kms.slice(0,600).forEach(k=>{
    tbody.innerHTML += `
      <tr>
        <td><b>${esc(k.dominio)}</b></td>
        <td>${Number(k.km||0)}</td>
        <td>${esc(k.fecha)}</td>
        <td>${esc(k.user||"-")}</td>
      </tr>
    `;
  });
}

function adminRenderLogs(){
  const tbody = document.getElementById("logTable");
  tbody.innerHTML = "";

  if(logs.length===0){
    tbody.innerHTML = `<tr><td colspan="2" class="muted">Sin logs.</td></tr>`;
    return;
  }

  logs.slice(0,700).forEach(l=>{
    tbody.innerHTML += `<tr><td>${esc(l.user)}</td><td>${esc(l.date)}</td></tr>`;
  });
}

/* =========================
   EXPORT (Excel + PDF)
========================= */
function exportAdminTable(type){
  const { table, filename, title } = buildExportTable(type);
  if(!table) return alert("No hay datos para exportar.");

  // Excel
  const wb = XLSX.utils.table_to_book(table, { sheet: "Datos" });
  XLSX.writeFile(wb, `${filename}.xlsx`);

  // PDF
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("l", "pt", "a4");
  doc.text(title, 40, 30);
  doc.autoTable({ html: table, startY: 50, styles: { fontSize: 8 } });
  doc.save(`${filename}.pdf`);

  table.remove(); // limpiar
}

function buildExportTable(type){
  const tmp = document.createElement("table");
  tmp.style.position = "fixed";
  tmp.style.left = "-99999px";
  tmp.style.top = "-99999px";

  let filename="export";
  let title="Export";

  const thead = document.createElement("thead");
  const tbody = document.createElement("tbody");
  tmp.appendChild(thead);
  tmp.appendChild(tbody);

  if(type==="users"){
    filename="usuarios"; title="Usuarios";
    thead.innerHTML = `<tr><th>Usuario</th><th>Nombre</th><th>Rol</th><th>Tel√©fono</th></tr>`;
    Object.keys(users).sort().forEach(u=>{
      tbody.innerHTML += `<tr><td>${esc(u)}</td><td>${esc(users[u].nombre||"")}</td><td>${esc(users[u].role||"")}</td><td>${esc(users[u].telefono||"")}</td></tr>`;
    });
  }

  if(type==="vehicles"){
    filename="vehiculos"; title="Veh√≠culos";
    thead.innerHTML = `<tr><th>Dominio</th><th>Modelo</th><th>Color</th><th>Cuota</th><th>VTV</th><th>Seguro</th><th>Usuario</th><th>KM actual</th><th>√öltimo aceite</th></tr>`;
    Object.keys(vehicles).sort().forEach(d=>{
      const v = vehicles[d];
      const oil = computeOilStatusForVehicle(v);
      tbody.innerHTML += `
        <tr>
          <td>${esc(v.dominio||d)}</td><td>${esc(v.modelo||"")}</td><td>${esc(v.color||"")}</td><td>${Number(v.cuotaSemanal||0)}</td>
          <td>${esc(v.vtv||"")}</td><td>${esc(v.seguro||"")}</td><td>${esc(v.usuario||"")}</td>
          <td>${Number(v.kmActual||0)}</td><td>${Number(oil.lastChange||0)}</td>
        </tr>`;
    });
  }

  if(type==="obligations"){
    filename="obligaciones"; title="Obligaciones (filtrado)";
    thead.innerHTML = `<tr><th>Dominio</th><th>Usuario</th><th>Concepto</th><th>Monto</th><th>Vence</th><th>Estado</th><th>Medio</th><th>Fecha</th><th>Motivo rechazo</th></tr>`;
    obligations.filter(obligationMatchesFilters).forEach(o=>{
      const owner = vehicleOwnerUsername(o.dominio) || "";
      tbody.innerHTML += `
        <tr>
          <td>${esc(o.dominio)}</td><td>${esc(owner)}</td><td>${esc(o.concepto)}</td><td>${Number(o.monto||0)}</td>
          <td>${esc(o.vencimiento)}</td><td>${esc(o.estado)}</td><td>${esc(o.medioPago||"")}</td><td>${esc(o.fechaPago||"")}</td><td>${esc(o.motivoRechazo||"")}</td>
        </tr>`;
    });
  }

  if(type==="km"){
    filename="kilometrajes"; title="Kilometrajes";
    thead.innerHTML = `<tr><th>Dominio</th><th>KM</th><th>Fecha</th><th>Usuario</th></tr>`;
    kms.forEach(k=>{
      tbody.innerHTML += `<tr><td>${esc(k.dominio)}</td><td>${Number(k.km||0)}</td><td>${esc(k.fecha)}</td><td>${esc(k.user||"")}</td></tr>`;
    });
  }

  if(type==="logs"){
    filename="logs"; title="Logs de acceso";
    thead.innerHTML = `<tr><th>Usuario</th><th>Fecha</th></tr>`;
    logs.forEach(l=>{
      tbody.innerHTML += `<tr><td>${esc(l.user)}</td><td>${esc(l.date)}</td></tr>`;
    });
  }

  if(type==="taller"){
    filename="taller"; title="Taller / Mantenimiento";
    thead.innerHTML = `<tr><th>Dominio</th><th>Fecha</th><th>KM</th><th>Tipo</th><th>Costo</th><th>Taller</th><th>Descripci√≥n</th><th>Creado por</th></tr>`;
    taller.forEach(t=>{
      tbody.innerHTML += `<tr><td>${esc(t.dominio)}</td><td>${esc(t.fecha)}</td><td>${Number(t.km||0)}</td><td>${esc(t.tipo)}</td><td>${Number(t.costo||0)}</td><td>${esc(t.taller||"")}</td><td>${esc(t.desc||"")}</td><td>${esc(t.creadoPor||"")}</td></tr>`;
    });
  }

  if(type==="oilReminders"){
    filename="recordatorios_aceite"; title="Recordatorios WhatsApp (aceite)";
    thead.innerHTML = `<tr><th>Dominio</th><th>Usuario</th><th>Tel√©fono</th><th>Estado aceite</th><th>KM restantes</th><th>Fecha</th></tr>`;
    oilReminders.forEach(r=>{
      tbody.innerHTML += `<tr><td>${esc(r.dominio)}</td><td>${esc(r.user)}</td><td>${esc(r.telefono)}</td><td>${esc(r.estadoAceite)}</td><td>${Number(r.kmRestantes||0)}</td><td>${esc(r.fecha)}</td></tr>`;
    });
  }

  if(type==="oilStatus"){
    filename="estado_aceite"; title="Estado de aceite (veh√≠culos)";
    thead.innerHTML = `<tr><th>Dominio</th><th>Usuario</th><th>KM actual</th><th>√öltimo cambio</th><th>Desde √∫ltimo</th><th>Restan</th><th>Estado</th><th>Intervalo</th></tr>`;
    Object.keys(vehicles).sort().forEach(d=>{
      const v = vehicles[d];
      const owner = v.usuario || "";
      const oil = computeOilStatusForVehicle(v);
      tbody.innerHTML += `
        <tr>
          <td>${esc(v.dominio||d)}</td><td>${esc(owner)}</td><td>${oil.kmActual}</td><td>${oil.lastChange}</td><td>${oil.kmDesde}</td><td>${oil.restantes}</td><td>${esc(oil.estado)}</td><td>${oil.interval}</td>
        </tr>`;
    });
  }

  if(tbody.children.length===0){
    tmp.remove();
    return { table:null, filename, title };
  }
  document.body.appendChild(tmp);
  return { table: tmp, filename, title };
}

/* =========================
   RESET
========================= */
function adminResetAll(){
  if(!confirm("Esto borra TODOS los datos del sistema en este navegador. ¬øContinuar?")) return;

  Object.values(KEYS).forEach(k => localStorage.removeItem(k));
  location.reload();
}

/* =========================
   INIT: asegurar selects
========================= */
(function init(){
  // Si hay veh√≠culos cargados en storage, asegurar estructura aceite
  Object.values(vehicles).forEach(v=>ensureVehicleOilFields(v));
  saveAll();
})();
</script>

</body>
</html>
